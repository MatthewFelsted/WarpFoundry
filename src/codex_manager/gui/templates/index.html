<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Codex Manager</title>
<style>
/* Ã¢â€â‚¬Ã¢â€â‚¬ Reset & Base Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  color-scheme: dark;
  --bg:        #070b11;
  --bg-elev:   #0f1622;
  --surface:   #131d2b;
  --surface2:  #1b2738;
  --surface3:  #23334a;
  --border:    #2d3d53;
  --border-soft: rgba(160, 190, 228, 0.24);
  --text:      #edf4ff;
  --text2:     #a1b4cd;
  --text3:     #7f94af;
  --accent:    #6ec7ff;
  --accent2:   #a1ddff;
  --success:   #47c07b;
  --warning:   #dfaa58;
  --danger:    #ff6f6f;
  --purple:    #8ea7ff;
  --radius:    10px;
  --radius-lg: 14px;
  --shadow-md: 0 12px 34px rgba(3, 8, 20, 0.38);
  --font:      'Aptos', 'Segoe UI Variable', 'Trebuchet MS', 'Segoe UI', sans-serif;
  --mono:      'Cascadia Code', 'Fira Code', 'Consolas', monospace;
}
html,body{height:100%;overflow:hidden}
body{
  font-family:var(--font);
  background:
    radial-gradient(circle at 2% 8%, rgba(110,199,255,.14), transparent 38%),
    radial-gradient(circle at 98% -4%, rgba(142,167,255,.16), transparent 36%),
    var(--bg);
  color:var(--text);
  font-size:14px;
  line-height:1.45;
  display:flex;
  flex-direction:column;
  -webkit-font-smoothing:antialiased;
  text-rendering:optimizeLegibility;
}
body.modal-open{overflow:hidden}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Scrollbar Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text2)}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Header Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px 18px;
  padding:10px 18px;
  min-height:62px;
  background:linear-gradient(180deg, rgba(19,29,43,.96), rgba(15,22,34,.9));
  border-bottom:1px solid var(--border-soft);
  backdrop-filter:blur(8px);
  flex-shrink:0;
  position:relative;
  z-index:100;
  overflow:visible
}
.header-brand{display:flex;align-items:center;gap:14px;min-width:0;flex-wrap:wrap}
.header-shortcuts{display:flex;gap:4px;align-items:center}
.header-shortcuts .btn{padding:5px 10px;font-size:12px}
.logo{font-size:19px;font-weight:700;letter-spacing:.1px;white-space:nowrap}
.logo span{color:var(--accent2);filter:drop-shadow(0 0 8px rgba(110,199,255,.42))}
.header-actions{display:flex;gap:8px;align-items:center;flex-shrink:0;min-width:0;flex-wrap:wrap;justify-content:flex-end}
.header-actions select,.header-actions button{font-size:13px}
#difficulty-mode-toggle{flex-shrink:0;position:relative;z-index:2}
.header-actions select{min-width:120px;max-width:180px}
.header-doc-links{display:flex;gap:6px;align-items:center}
.header-doc-links .btn{padding:5px 9px;font-size:12px}

/* Docs modal */
#docs-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:2500;display:flex;align-items:center;justify-content:center;padding:24px}
#docs-overlay.hidden{display:none}
.docs-modal{width:980px;max-width:100%;max-height:80vh;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.docs-modal-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px}
.docs-modal-header h3{font-size:15px;color:var(--text);margin:0}
.docs-subtitle{font-size:12px;color:var(--text2);margin-top:4px}
.docs-tab-row{padding:10px 16px;border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap}
.docs-tab-row .btn.active{border-color:var(--accent);background:rgba(88,166,255,.14);color:var(--accent2)}
.docs-content{padding:14px 16px;flex:1;overflow:auto;white-space:pre-wrap;word-break:break-word;background:var(--bg);color:var(--text);font-family:var(--mono);font-size:12px;line-height:1.55}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Layout Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
main{display:grid;grid-template-columns:minmax(360px,420px) minmax(0,1fr);flex:1;overflow:hidden}
.panel{overflow-y:auto;padding:20px}
#chain-panel{border-right:1px solid var(--border-soft);display:flex;flex-direction:column;gap:16px}
#exec-panel{overflow-x:hidden;overflow-y:auto;padding:20px}
#exec-panel > *{margin-bottom:16px}
#exec-panel > *:last-child{margin-bottom:0}
#pipeline-exec{overflow-x:hidden;overflow-y:auto}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Shared UI Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
h2{font-size:15px;font-weight:700;letter-spacing:.2px;color:var(--text2);margin-bottom:6px}
h3{font-size:13px;font-weight:650;color:var(--text2);margin-bottom:8px}
label{font-size:12px;color:var(--text2);display:block;margin-bottom:5px}
input[type="text"],input[type="number"],select,textarea{
  width:100%;padding:9px 11px;border:1px solid var(--border);border-radius:var(--radius);
  background:linear-gradient(180deg, rgba(15,22,34,.92), rgba(15,22,34,.82));color:var(--text);
  font-family:var(--font);font-size:13px;outline:none;transition:border .15s, box-shadow .15s, background .15s}
input:hover,select:hover,textarea:hover{border-color:var(--border-soft)}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(110,199,255,.22);background:var(--surface)}
/* Improve native select menu readability across Chromium variants (incl. Brave). */
select option{background:var(--surface);color:var(--text)}
textarea{resize:vertical;font-family:var(--mono);font-size:12px;line-height:1.5}
input[type="checkbox"]{accent-color:var(--accent);margin-right:6px;vertical-align:middle}

.btn{
  padding:8px 14px;border:1px solid var(--border);border-radius:9px;
  background:linear-gradient(180deg, var(--surface2), var(--surface));
  color:var(--text);cursor:pointer;font-size:13px;font-family:var(--font);
  transition:transform .15s, border-color .15s, background .15s, box-shadow .15s
}
.btn:hover{background:var(--surface3);border-color:var(--border-soft);transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.btn:disabled{opacity:.45;cursor:not-allowed;transform:none}
.btn-primary{background:var(--accent);color:#000;border-color:var(--accent);font-weight:600}
.btn-primary:hover{background:var(--accent2)}
.btn-danger{border-color:var(--danger);color:var(--danger)}
.btn-danger:hover{background:rgba(248,81,73,.15)}
.btn-success{border-color:var(--success);color:var(--success)}
.btn-success:hover{background:rgba(63,185,80,.15)}
.btn-warning{border-color:var(--warning);color:var(--warning)}
.btn-warning:hover{background:rgba(210,153,34,.15)}

.config-section{
  background:linear-gradient(180deg, rgba(19,29,43,.96), rgba(16,23,35,.93));
  border:1px solid var(--border-soft);border-radius:var(--radius-lg);padding:14px 15px;
  box-shadow:var(--shadow-md)
}
.form-row{margin-bottom:10px}
.form-row:last-child{margin-bottom:0}
.form-row-inline{display:flex;gap:12px;align-items:center}
.form-row-inline > *{flex:1}
.option-subpanel{
  border:1px solid var(--border);
  border-radius:var(--radius);
  background:rgba(19,29,43,.55);
  padding:10px;
  margin-top:8px;
}
.option-subpanel.hidden{display:none}
.scope-note{
  display:inline-block;
  font-size:11px;
  color:var(--accent2);
  border:1px solid rgba(110,199,255,.45);
  background:rgba(110,199,255,.08);
  border-radius:999px;
  padding:2px 8px;
  margin-bottom:8px;
}
.foundation-tools{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}

button:focus-visible,
input:focus-visible,
select:focus-visible,
textarea:focus-visible,
summary:focus-visible{
  outline:none;
  box-shadow:0 0 0 3px rgba(110,199,255,.28);
}
.tab-nav button:focus-visible{border-bottom-color:var(--accent);color:var(--text)}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Mode Toggle Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
.mode-toggle{display:flex;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.mode-toggle button{flex:1;padding:8px;border:none;background:var(--bg);color:var(--text2);cursor:pointer;font-size:13px;font-family:var(--font);transition:all .15s}
.mode-toggle button.active{background:var(--accent);color:#000;font-weight:600}
.mode-toggle button:hover:not(.active){background:var(--surface2)}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Repo Input Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
.repo-row{display:flex;gap:8px;align-items:center}
.repo-row input{flex:1}
.repo-status{font-size:18px;width:24px;text-align:center;flex-shrink:0}
.diag-card{
  margin-top:10px;padding:10px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg)
}
.diag-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
.diag-head strong{font-size:12px;color:var(--text)}
.diag-summary{font-size:11px;color:var(--text2);line-height:1.5;margin-bottom:8px;overflow-wrap:anywhere;word-break:break-word}
.diag-list{display:flex;flex-direction:column;gap:6px}
.diag-item{
  border:1px solid var(--border);border-radius:6px;padding:7px 8px;background:var(--surface)
}
.diag-item.diag-pass{border-color:rgba(63,185,80,.45);background:rgba(63,185,80,.10)}
.diag-item.diag-warn{border-color:rgba(210,153,34,.45);background:rgba(210,153,34,.10)}
.diag-item.diag-fail{border-color:rgba(248,81,73,.5);background:rgba(248,81,73,.10)}
.diag-main{display:flex;align-items:flex-start;gap:6px;font-size:11px}
.diag-icon{width:14px;text-align:center;flex:0 0 14px}
.diag-title{font-weight:600;color:var(--text);overflow-wrap:anywhere;word-break:break-word}
.diag-detail{margin-top:3px;font-size:11px;color:var(--text2);line-height:1.4;overflow-wrap:anywhere;word-break:break-word}
.diag-hint{margin-top:3px;font-size:11px;color:var(--warning);line-height:1.4;overflow-wrap:anywhere;word-break:break-word}
.diag-actions{margin-top:8px;display:flex;flex-direction:column;gap:6px}
.diag-actions-title{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
.diag-action{
  border:1px solid var(--border);border-radius:6px;padding:7px 8px;background:var(--surface)
}
.diag-action.diag-action-required{border-color:rgba(248,81,73,.45);background:rgba(248,81,73,.09)}
.diag-action.diag-action-recommended{border-color:rgba(88,166,255,.45);background:rgba(88,166,255,.09)}
.diag-action-head{display:flex;gap:6px;align-items:flex-start;font-size:11px;color:var(--text)}
.diag-action-rank{font-weight:700;color:var(--text2);min-width:16px}
.diag-action-title{font-weight:600;color:var(--text)}
.diag-action-detail{margin-top:4px;font-size:11px;color:var(--text2);line-height:1.4;overflow-wrap:anywhere;word-break:break-word}
.diag-action-command{
  margin-top:4px;font-size:11px;color:var(--accent2);font-family:var(--mono);line-height:1.35;
  overflow-wrap:anywhere;word-break:break-word
}
.diag-action-controls{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
.diag-action-controls .btn{padding:4px 8px;font-size:11px}
.diag-action-run-state{margin-top:4px;font-size:11px;color:var(--text2);line-height:1.35}
.diag-action-run-state.ok{color:var(--success)}
.diag-action-run-state.fail{color:var(--danger)}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Step List Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
.step-list{display:flex;flex-direction:column;gap:4px;min-height:40px}
.step-item{
  display:flex;align-items:center;gap:8px;padding:8px 10px;
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  cursor:pointer;transition:all .15s;user-select:none}
.step-item:hover{background:var(--surface2)}
.step-item.selected{border-color:var(--accent);background:rgba(88,166,255,.08)}
.step-item.duplicate-step{border-color:var(--danger);background:rgba(248,81,73,.10)}
.step-item.disabled-step{opacity:.45}
.step-item:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(110,199,255,.3)}
.step-num{font-size:12px;font-weight:700;color:var(--text2);width:18px;text-align:center}
.step-icon{font-size:16px;width:22px;text-align:center}
.step-name{flex:1;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.step-dup-mark{color:var(--danger);font-size:12px;font-weight:700;min-width:28px;text-align:center}
.step-actions{display:flex;gap:2px}
.step-actions button{padding:2px 5px;border:none;background:transparent;color:var(--text2);cursor:pointer;border-radius:3px;font-size:12px;line-height:1}
.step-actions button:hover{background:var(--border);color:var(--text)}

.btn-add{width:100%;border-style:dashed;color:var(--accent);margin-top:4px}
.btn-add:hover{background:rgba(88,166,255,.08)}
.step-collision-alert{
  display:none;margin-top:8px;padding:10px;border:1px solid rgba(248,81,73,.55);
  background:rgba(248,81,73,.12);border-radius:var(--radius);font-size:12px;color:#ffd6d3
}
.step-collision-alert code{
  font-family:var(--mono);font-size:11px;color:#ffd6d3;background:rgba(0,0,0,.25);padding:1px 4px;border-radius:4px
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Step Details Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
.step-details{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
.step-details .detail-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.step-details .detail-title{font-size:14px;font-weight:600}
.step-name-warning{
  margin-bottom:10px;padding:8px 10px;border:1px solid rgba(248,81,73,.55);
  background:rgba(248,81,73,.12);border-radius:var(--radius);font-size:12px;color:#ffd6d3;line-height:1.45
}
.radio-group{display:flex;gap:14px;padding:4px 0}
.radio-group label{display:flex;align-items:center;gap:4px;font-size:13px;color:var(--text);cursor:pointer}
.prompt-preview{position:relative}
.prompt-preview textarea{min-height:80px}
.prompt-preview .readonly-badge{position:absolute;top:6px;right:8px;font-size:10px;color:var(--text2);background:var(--surface2);padding:2px 6px;border-radius:3px}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Exec Controls Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
.exec-controls{display:flex;gap:8px}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Progress Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
.progress-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
.progress-info{display:flex;justify-content:space-between;margin-bottom:8px;font-size:13px}
.progress-bar{height:8px;background:var(--bg);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--accent),var(--purple));transition:width .4s ease;width:0}
.progress-fill.running{animation:progressPulse 1.8s ease-in-out infinite}
@keyframes progressPulse{
  0%{filter:saturate(95%) brightness(94%)}
  50%{filter:saturate(130%) brightness(108%)}
  100%{filter:saturate(95%) brightness(94%)}
}
.activity-heartbeat{margin-top:8px;font-size:11px;color:var(--text2);min-height:1.2em}
.progress-last-log{
  margin-top:6px;font-size:11px;color:var(--text2);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis
}
.stop-guidance{
  margin-top:10px;padding:10px;border-radius:var(--radius);border:1px solid var(--border);
  background:var(--bg);display:flex;flex-direction:column;gap:6px
}
.stop-guidance.hidden{display:none}
.stop-guidance-title{font-size:12px;font-weight:700;color:var(--text)}
.stop-guidance-summary{font-size:12px;color:var(--text2);line-height:1.45}
.stop-guidance-steps{
  margin:0;padding-left:18px;font-size:12px;color:var(--text2);display:flex;flex-direction:column;gap:4px
}
.stop-guidance-warn{border-color:rgba(210,153,34,.45);background:rgba(210,153,34,.1)}
.stop-guidance-error{border-color:rgba(248,81,73,.45);background:rgba(248,81,73,.1)}
.stop-guidance-info{border-color:rgba(88,166,255,.35);background:rgba(88,166,255,.08)}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Log Viewer Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
.log-section{margin-bottom:4px}
.log-viewer{
  min-height:180px;height:32vh;max-height:75vh;overflow:auto;resize:vertical;
  background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);
  padding:10px;font-family:var(--mono);font-size:12px;line-height:1.7}
.log-toolbar{display:flex;justify-content:space-between;align-items:center;margin:6px 0 8px 0}
.log-toolbar label{margin:0;font-size:11px;color:var(--text2);display:flex;align-items:center;gap:6px}
.pipe-logs-wrap{margin-bottom:4px}
.pipe-logs-wrap .log-viewer{margin-bottom:12px}
.pipe-logs-wrap .log-content{margin-bottom:4px}
.pipe-logs-head-row{display:flex;align-items:flex-start;gap:20px;flex-wrap:wrap;margin-bottom:8px}
.pipe-logs-head-row .pipe-logs-live{min-width:200px}
.pipe-logs-head-row .pipe-logs-files{flex:1;min-width:0}
.pipe-logs-head-row .pipe-logs-files .log-tabs{margin-bottom:0}
.log-tabs{display:flex;gap:2px;margin-bottom:8px;flex-wrap:wrap}
.log-empty{color:var(--text2);font-style:normal}
.log-entry{display:flex;gap:8px;align-items:flex-start;padding:2px 0;border-bottom:1px dashed rgba(139,148,158,.2)}
.log-entry:last-child{border-bottom:none}
.log-entry .log-time{color:var(--text2);white-space:nowrap;flex:0 0 72px}
.log-entry .log-msg{flex:1;min-width:0;white-space:pre-wrap;overflow-wrap:anywhere;word-break:break-word}
.log-info{color:var(--text)}
.log-warn{color:var(--warning)}
.log-error{color:var(--danger)}

.state-card{
  border:1px dashed var(--border-soft);
  border-radius:var(--radius);
  background:rgba(15,22,34,.84);
  color:var(--text2);
  font-size:12px;
  line-height:1.45;
  padding:11px 12px;
}
.state-card strong{color:var(--text)}
.state-card.loading{
  position:relative;
  padding-left:36px;
}
.state-card.loading::before{
  content:'';
  position:absolute;
  left:12px;
  top:50%;
  width:14px;
  height:14px;
  margin-top:-7px;
  border-radius:50%;
  border:2px solid rgba(161,180,205,.4);
  border-top-color:var(--accent2);
  animation:spin .8s linear infinite;
}
.state-card.error{
  border-color:rgba(255,111,111,.45);
  background:rgba(255,111,111,.09);
  color:#ffd6d6;
}
.state-card.warning{
  border-color:rgba(223,170,88,.45);
  background:rgba(223,170,88,.10);
  color:#ffe7c2;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Results Table Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
.results-section{margin-top:4px}
.results-wrap{overflow:auto;min-height:180px;height:28vh;max-height:70vh;resize:vertical;border:1px solid var(--border);border-radius:var(--radius)}
.results-table{width:100%;border-collapse:collapse;font-size:13px}
.results-table th{position:sticky;top:0;background:var(--surface);padding:8px 10px;text-align:left;font-weight:600;color:var(--text2);border-bottom:1px solid var(--border);font-size:12px;text-transform:uppercase;letter-spacing:.3px}
.results-table td{padding:7px 10px;border-bottom:1px solid var(--border)}
.results-table tr:last-child td{border-bottom:none}
.results-table tr:hover td{background:var(--surface2)}
.results-table td .state-card{margin:4px 0}
.file-changes-cell{min-width:230px;max-width:420px}
.file-changes-empty{color:var(--text2);font-size:12px}
.file-changes-details{display:block}
.file-changes-summary{cursor:pointer;color:var(--accent2);font-size:12px;list-style:none;user-select:none}
.file-changes-summary::-webkit-details-marker{display:none}
.file-changes-summary::before{content:"\25b8";display:inline-block;width:12px;color:var(--text2)}
.file-changes-details[open] .file-changes-summary::before{content:"\25be"}
.file-changes-list{
  margin-top:6px;padding:4px 0;max-height:170px;overflow:auto;
  border:1px solid var(--border);border-radius:6px;background:var(--bg)
}
.file-changes-row{
  display:grid;grid-template-columns:minmax(0,1fr) auto auto;gap:8px;align-items:center;
  padding:4px 8px;font-family:var(--mono);font-size:11px
}
.file-changes-row + .file-changes-row{border-top:1px dashed rgba(139,148,158,.25)}
.file-changes-path{min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text)}
.file-changes-plus{color:var(--success);text-align:right}
.file-changes-minus{color:var(--danger);text-align:right}
.file-changes-binary{color:var(--text2);text-align:right}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600}
.badge-pass{background:rgba(63,185,80,.15);color:var(--success)}
.badge-fail{background:rgba(248,81,73,.15);color:var(--danger)}
.badge-error{background:rgba(210,153,34,.15);color:var(--warning)}
.badge-skip{background:rgba(139,148,158,.15);color:var(--text2)}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Toast / Notification Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
#toast-stack{
  position:fixed;right:20px;bottom:20px;z-index:3000;
  display:flex;flex-direction:column;align-items:flex-end;gap:8px;
  pointer-events:none;max-width:min(420px, calc(100vw - 24px))
}
.toast{
  position:relative;padding:12px 20px;border-radius:var(--radius);font-size:13px;color:#fff;
  animation:slideUp .3s ease;pointer-events:none;max-width:100%;
  box-shadow:0 10px 28px rgba(0,0,0,.35);word-break:break-word
}
.toast.toast-exit{animation:toastFade .2s ease forwards}
.toast-success{background:#228958}
.toast-error{background:#b83f3f}
.toast-info{background:#2f6f98}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes toastFade{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(8px)}}

.visually-hidden{
  position:absolute !important;
  width:1px;
  height:1px;
  padding:0;
  margin:-1px;
  overflow:hidden;
  clip:rect(0,0,0,0);
  white-space:nowrap;
  border:0;
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Difficulty mode visibility Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
.easy-only{display:none}
.medium-only{display:none}
.expert-only{display:none}
body.mode-easy .easy-only{display:block}
body.mode-easy .easy-hide{display:none !important}
body.mode-medium .medium-only{display:block}
body.mode-medium .medium-hide{display:none !important}
body.mode-expert .expert-only{display:block}
body.mode-expert .expert-hide{display:none !important}
body.mode-expert .easy-only{display:none}
body.mode-expert .medium-only{display:none}
body.mode-medium .easy-only{display:none}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Recipe cards (Easy mode) Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
.recipe-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
.recipe-card{padding:14px;background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);cursor:pointer;transition:all .15s;text-align:left}
.recipe-card:hover{border-color:var(--accent);background:var(--surface2)}
.recipe-card.selected{border-color:var(--accent);background:rgba(88,166,255,.12)}
.recipe-card:focus-visible{
  outline:none;
  border-color:var(--accent2);
  box-shadow:0 0 0 3px rgba(110,199,255,.25);
}
.recipe-card .recipe-title{font-weight:600;font-size:13px;margin-bottom:4px;color:var(--text)}
.recipe-card .recipe-desc{font-size:11px;color:var(--text2);line-height:1.4}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Onboarding overlay Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
#onboarding-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:2000;display:flex;align-items:center;justify-content:center;padding:24px}
#onboarding-overlay.hidden{display:none}
.onboarding-card{max-width:520px;width:100%;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:28px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.onboarding-card h2{margin-bottom:12px;font-size:20px;color:var(--text)}
.onboarding-card p{color:var(--text2);font-size:14px;line-height:1.6;margin-bottom:12px}
.onboarding-card .mode-row{display:flex;align-items:flex-start;gap:10px;margin:14px 0;padding:10px;background:var(--bg);border-radius:var(--radius)}
.onboarding-card .mode-row strong{color:var(--accent);font-size:13px;min-width:80px}
.onboarding-card .mode-row span{font-size:12px;color:var(--text2);line-height:1.5}
.onboarding-card .btn-primary{width:100%;padding:12px;margin-top:16px;font-size:14px}

/* Ã¢â€â‚¬Ã¢â€â‚¬ New Project modal Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
#new-project-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:2000;display:flex;align-items:center;justify-content:center;padding:24px}
#new-project-overlay.hidden{display:none}
.new-project-card{max-width:520px;width:100%;max-height:88vh;overflow-y:auto;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:28px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.new-project-card h2{margin-bottom:4px;font-size:18px;color:var(--text)}
.new-project-card .subtitle{color:var(--text2);font-size:13px;margin-bottom:16px}
.new-project-card .form-row{margin-bottom:12px}
.new-project-card label{font-size:12px;color:var(--text2);display:block;margin-bottom:4px}
.new-project-card .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px}
.new-project-card .toggle-row{display:flex;gap:16px;margin:8px 0}
.new-project-card .toggle-row label{display:flex;align-items:center;gap:4px;font-size:13px;color:var(--text);cursor:pointer;margin-bottom:0}
.new-project-card details{margin-top:8px;border:1px solid var(--border);border-radius:var(--radius);padding:10px}
.new-project-card details summary{cursor:pointer;font-size:12px;color:var(--text2);font-weight:600}
.new-project-card details .form-row{margin-top:10px}
.new-project-card .creation-result{margin-top:12px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);font-size:12px;color:var(--success);display:none}

#todo-wishlist-overlay{position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:2200;display:flex;align-items:center;justify-content:center;padding:24px}
#todo-wishlist-overlay.hidden{display:none}
.todo-wishlist-card{width:760px;max-width:100%;max-height:88vh;overflow-y:auto;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.todo-wishlist-card h2{margin-bottom:4px;font-size:18px;color:var(--text)}
.todo-wishlist-card .subtitle{color:var(--text2);font-size:13px;margin-bottom:14px}
.todo-wishlist-card .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap}
.todo-wishlist-card .status{font-size:12px;color:var(--text2);margin-top:6px;min-height:1.2em}
.todo-wishlist-card .inline-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Help tooltip Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
.help-icon{display:inline-block;width:14px;height:14px;line-height:14px;text-align:center;border-radius:50%;background:var(--border);color:var(--text2);font-size:10px;font-weight:700;cursor:help;margin-left:4px;vertical-align:middle}
.field-help{font-size:11px;color:var(--text2);line-height:1.5;margin-top:4px}
.perm-summary{font-size:11px;color:var(--text2);line-height:1.5;margin-top:6px;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius)}
.perm-warning{font-size:11px;color:var(--warning);line-height:1.5;margin-top:6px;padding:8px 10px;background:rgba(210,153,34,.12);border:1px solid rgba(210,153,34,.4);border-radius:var(--radius)}
.perm-warning.hidden{display:none}
.perm-manual{margin-top:10px;border:1px solid var(--border);border-radius:var(--radius);padding:10px;background:var(--bg)}
.perm-manual summary{cursor:pointer;font-size:12px;color:var(--text2);font-weight:600}
.perm-manual .form-row{margin-top:8px}
.adv-block{margin-top:10px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius)}
.adv-block h4{font-size:12px;color:var(--text2);text-transform:uppercase;letter-spacing:.3px;margin-bottom:8px}
.adv-block summary{cursor:pointer;font-size:12px;color:var(--text2);font-weight:600}

.cua-card{
  background:linear-gradient(135deg, rgba(15,22,34,.95), rgba(23,35,49,.92));
  border:1px solid var(--border-soft);
  border-radius:var(--radius);
  padding:10px;
}
.cua-toggle-label{margin-bottom:6px}
.cua-toggle-label input[type="checkbox"]{accent-color:var(--accent)}
.cua-toggle-label strong{color:var(--accent2)}
.cua-description{font-size:11px;color:var(--text2);margin:4px 0 0 22px}
.cua-options{display:none;margin-top:10px;padding-left:22px}
.cua-field{margin-bottom:6px}
.cua-input-sm{font-size:12px}
.cua-task-input{
  font-size:12px;resize:vertical;width:100%;background:var(--bg);
  border:1px solid var(--border);border-radius:var(--radius);padding:8px;color:var(--text)
}
.cua-run-row{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
.btn-cua{font-size:11px;padding:4px 10px}
.cua-status{font-size:11px;color:var(--text2);padding-top:5px}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Permissions Help Modal Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
#permissions-help-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:2600;display:flex;align-items:center;justify-content:center;padding:24px}
#permissions-help-overlay.hidden{display:none}
.permissions-help-modal{width:680px;max-width:100%;max-height:75vh;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.permissions-help-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:8px}
.permissions-help-body{padding:14px 16px;overflow-y:auto;display:flex;flex-direction:column;gap:10px}
.permissions-help-body h4{font-size:13px;color:var(--text2);text-transform:uppercase;letter-spacing:.3px}
.permissions-help-body p{font-size:12px;color:var(--text2);line-height:1.5}
.permissions-help-card{padding:10px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg)}

/* Read-Only Run Warning Modal */
#readonly-warning-overlay{position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:2800;display:flex;align-items:center;justify-content:center;padding:24px}
#readonly-warning-overlay.hidden{display:none}
.readonly-warning-modal{width:560px;max-width:100%;background:var(--surface);border:1px solid rgba(248,81,73,.5);border-radius:var(--radius);box-shadow:0 24px 72px rgba(0,0,0,.55);display:flex;flex-direction:column}
.readonly-warning-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.readonly-warning-header h3{margin:0;font-size:15px;color:var(--danger)}
.readonly-warning-body{padding:14px 16px;display:flex;flex-direction:column;gap:10px}
.readonly-warning-body p{margin:0;font-size:13px;line-height:1.5;color:var(--text2)}
.readonly-warning-callout{padding:10px;border:1px solid rgba(248,81,73,.45);border-radius:var(--radius);background:rgba(248,81,73,.10);font-size:12px;color:#ffd7d5}
.readonly-warning-actions{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

#run-plan-overlay{position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:2900;display:flex;align-items:center;justify-content:center;padding:24px}
#run-plan-overlay.hidden{display:none}
.run-plan-modal{width:760px;max-width:100%;max-height:80vh;overflow:hidden;background:linear-gradient(165deg, rgba(22,27,34,.98), rgba(13,17,23,.98));border:1px solid var(--border);border-radius:14px;box-shadow:0 24px 72px rgba(0,0,0,.55);display:flex;flex-direction:column}
.run-plan-header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.run-plan-header h3{margin:0;font-size:16px;color:var(--text)}
.run-plan-subtitle{font-size:12px;color:var(--text2);margin-top:4px;line-height:1.5}
.run-plan-model-chip{padding:6px 10px;border:1px solid rgba(88,166,255,.45);border-radius:999px;background:rgba(88,166,255,.12);color:var(--accent2);font-size:11px;white-space:nowrap}
.run-plan-body{padding:16px 18px;overflow-y:auto;display:flex;flex-direction:column;gap:14px}
.run-plan-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.run-plan-field{padding:12px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg)}
.run-plan-field label{font-size:12px;color:var(--text2);margin-bottom:6px}
.run-plan-summary{padding:12px;border:1px solid var(--border);border-radius:var(--radius);background:rgba(28,35,51,.55);display:flex;flex-direction:column;gap:8px}
.run-plan-summary-line{font-size:12px;color:var(--text2);line-height:1.5}
.run-plan-summary-line strong{color:var(--text)}
.run-plan-callout{padding:10px;border-radius:var(--radius);border:1px solid rgba(88,166,255,.35);background:rgba(88,166,255,.1);color:#d6ebff;font-size:12px;line-height:1.45}
.run-plan-callout.warn{border-color:rgba(210,153,34,.45);background:rgba(210,153,34,.12);color:#f3e5bf}
.run-plan-callout.danger{border-color:rgba(248,81,73,.45);background:rgba(248,81,73,.12);color:#ffd7d5}
.run-plan-danger{display:flex;align-items:flex-start;gap:8px;padding:10px;border:1px solid rgba(248,81,73,.45);border-radius:var(--radius);background:rgba(248,81,73,.1);font-size:12px;color:#ffd7d5}
.run-plan-danger.hidden{display:none}
.run-plan-actions{padding:12px 18px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}

/* Scientist dashboard modal */
#science-dashboard-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:2950;display:flex;align-items:center;justify-content:center;padding:24px}
#science-dashboard-overlay.hidden{display:none}
.science-dashboard-modal{
  width:1120px;max-width:100%;max-height:84vh;overflow:hidden;
  background:linear-gradient(165deg, rgba(19,29,43,.98), rgba(7,11,17,.98));
  border:1px solid var(--border-soft);border-radius:14px;box-shadow:0 24px 72px rgba(0,0,0,.58);
  display:flex;flex-direction:column
}
.science-dashboard-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.science-dashboard-header h3{margin:0;font-size:16px;color:var(--text)}
.science-dashboard-subtitle{font-size:12px;color:var(--text2);margin-top:4px;line-height:1.45}
.science-dashboard-actions{display:flex;gap:8px;flex-wrap:wrap}
.science-dashboard-body{padding:14px 16px;overflow:auto;display:flex;flex-direction:column;gap:14px}
.science-cards{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
.science-card{
  border:1px solid var(--border);border-radius:10px;padding:10px;background:rgba(19,29,43,.75);
  display:flex;flex-direction:column;gap:4px
}
.science-card-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.3px}
.science-card-value{font-size:19px;font-weight:700;color:var(--text)}
.science-card-value.pass{color:var(--success)}
.science-card-value.fail{color:var(--danger)}
.science-card-value.warn{color:var(--warning)}
.science-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.science-panel{border:1px solid var(--border);border-radius:10px;background:var(--bg);padding:10px}
.science-panel h4{font-size:12px;color:var(--text2);margin-bottom:8px;text-transform:uppercase;letter-spacing:.3px}
.science-list{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--text2)}
.science-list-item{display:flex;align-items:center;justify-content:space-between;gap:8px}
.science-list-item .name{color:var(--text);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.science-list-item .count{font-family:var(--mono);color:var(--text2);font-size:11px}
.science-bars{display:flex;flex-direction:column;gap:8px}
.science-bar-row{display:grid;grid-template-columns:88px 1fr 44px;gap:8px;align-items:center}
.science-bar-label{font-size:11px;color:var(--text2);text-transform:capitalize}
.science-bar-track{height:10px;background:var(--surface2);border-radius:999px;overflow:hidden}
.science-bar-fill{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.science-bar-fill.pass{background:linear-gradient(90deg,#2ea66a,#61d995)}
.science-bar-fill.fail{background:linear-gradient(90deg,#d14a4a,#ff7c7c)}
.science-bar-fill.warn{background:linear-gradient(90deg,#be8a3b,#f4bd64)}
.science-bar-value{font-family:var(--mono);font-size:11px;color:var(--text2);text-align:right}
.science-table-wrap{max-height:240px;overflow:auto;border:1px solid var(--border);border-radius:8px}
.science-table{width:100%;border-collapse:collapse;font-size:12px}
.science-table th{position:sticky;top:0;background:var(--surface);padding:6px 8px;color:var(--text2);text-align:left;border-bottom:1px solid var(--border);font-size:11px;text-transform:uppercase;letter-spacing:.3px}
.science-table td{padding:6px 8px;border-bottom:1px solid var(--border)}
.science-table tr:last-child td{border-bottom:none}
.science-analysis{max-height:180px;overflow:auto;white-space:pre-wrap;word-break:break-word;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px;font-family:var(--mono);font-size:11px;color:var(--text2);line-height:1.5}
.science-empty{font-size:12px;color:var(--text2);padding:10px;border:1px dashed var(--border-soft);border-radius:8px;background:rgba(15,22,34,.65)}
.science-open-btn{margin-top:8px;display:flex;justify-content:flex-end}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Tab Navigation Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
.tab-nav{display:flex;gap:2px}
.tab-nav button{padding:7px 16px;border:none;background:transparent;color:var(--text2);cursor:pointer;font-size:13px;font-family:var(--font);font-weight:500;border-bottom:2px solid transparent;transition:all .15s}
.tab-nav button:hover{color:var(--text)}
.tab-nav button.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:600}
.tab-nav button[aria-selected="true"]{color:var(--accent);border-bottom-color:var(--accent);font-weight:600}
.tab-content{display:none}
.tab-content.active{display:grid}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Pipeline Panel Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
#pipeline-view{grid-template-columns:minmax(360px,420px) minmax(0,1fr);flex:1;overflow:hidden}
.pipeline-panel{overflow-y:auto;padding:20px}
#pipeline-config{border-right:1px solid var(--border-soft);display:flex;flex-direction:column;gap:16px}
#pipeline-exec > *{margin-bottom:16px}
#pipeline-exec > *:last-child{margin-bottom:0}
.phase-list{display:flex;flex-direction:column;gap:4px}
.phase-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);transition:all .15s;overflow:hidden}
.phase-item:hover{background:var(--surface2)}
.phase-item.disabled-phase{opacity:.45}
.phase-header{display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;user-select:none}
.phase-header:hover{background:rgba(255,255,255,.03)}
.phase-header:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(110,199,255,.3)}
.phase-expand-arrow{font-size:10px;color:var(--text2);transition:transform .2s;width:14px;text-align:center}
.phase-item.expanded .phase-expand-arrow{transform:rotate(90deg)}
.phase-icon{font-size:15px;width:22px;text-align:center}
.phase-name{flex:1;font-size:13px}
.phase-iter{width:50px;text-align:center;font-size:12px;padding:4px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text)}
.phase-details{display:none;padding:0 12px 12px 12px;border-top:1px solid var(--border);margin-top:0}
.phase-item.expanded .phase-details{display:block}
.phase-details .phase-desc{font-size:11px;color:var(--text2);margin:10px 0 8px 0;line-height:1.5}
.phase-details .phase-prompt-wrap{margin-top:8px}
.phase-details .phase-prompt-wrap label{font-size:12px;font-weight:600;color:var(--text);margin-bottom:4px;display:block}
.phase-details textarea.phase-prompt{width:100%;min-height:100px;max-height:300px;resize:vertical;font-size:11px;font-family:'Fira Code','Cascadia Code','JetBrains Mono',monospace;line-height:1.5;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:8px;color:var(--text);box-sizing:border-box}
.phase-details .phase-meta-row{display:flex;gap:12px;margin-top:10px;flex-wrap:wrap}
.phase-details .phase-meta-row .form-row{flex:1;min-width:120px}
.log-tabs button{padding:4px 10px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg);color:var(--text2);cursor:pointer;font-size:11px;font-family:var(--font);transition:all .15s}
.log-tabs button:hover{background:var(--surface2)}
.log-tabs button.active{background:var(--accent);color:#000;border-color:var(--accent);font-weight:600}
.log-content{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:12px;font-family:var(--mono);font-size:12px;line-height:1.6;min-height:180px;height:28vh;max-height:70vh;resize:vertical;overflow-y:auto;overflow-x:auto;white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere;color:var(--text2);transition:border-color .15s, background .15s}
.log-content.is-loading{border-color:var(--border-soft);background:rgba(15,22,34,.78);color:var(--text3)}
.log-viewer{overflow-x:hidden}
.results-wrap{overflow-x:auto}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Browse Modal Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
.browse-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:2000;display:flex;align-items:center;justify-content:center;padding:24px}
.browse-modal-overlay.hidden{display:none}
.browse-modal{width:520px;max-width:100%;max-height:70vh;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.browse-modal-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.browse-modal-header h3{font-size:14px;font-weight:600;color:var(--text);flex:1;margin:0}
.browse-path-bar{padding:8px 16px;border-bottom:1px solid var(--border);font-size:12px;font-family:var(--mono);color:var(--text2);word-break:break-all;background:var(--bg)}
.browse-list{flex:1;overflow-y:auto;padding:4px 0}
.browse-item{display:flex;align-items:center;gap:10px;padding:8px 16px;cursor:pointer;font-size:13px;color:var(--text);transition:background .1s;border:none;background:none;width:100%;text-align:left;font-family:var(--font)}
.browse-item:hover{background:var(--surface2)}
.browse-item-icon{font-size:16px;width:22px;text-align:center;flex-shrink:0}
.browse-item-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.browse-item-git{font-size:10px;padding:2px 6px;border-radius:8px;background:rgba(63,185,80,.15);color:var(--success);font-weight:600;flex-shrink:0}
.browse-empty{padding:24px 16px;text-align:center;color:var(--text2);font-size:13px;font-style:normal}
.browse-drives{display:flex;gap:6px;flex-wrap:wrap;padding:8px 16px;border-bottom:1px solid var(--border)}
.browse-drives button{padding:4px 10px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg);color:var(--text);cursor:pointer;font-size:12px;font-family:var(--mono);transition:all .1s}
.browse-drives button:hover{background:var(--surface2);border-color:var(--accent)}
.browse-modal-footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Responsive Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
@media(max-width:1280px){
  header{padding:10px 14px}
  .header-brand{width:100%}
  .header-actions{width:100%;justify-content:flex-start}
  .header-doc-links{order:2}
}
@media(max-width:980px){
  html,body{overflow:auto;height:auto;min-height:100%}
  body{min-height:100dvh}
  main,#pipeline-view{grid-template-columns:1fr;grid-template-rows:auto auto;overflow:visible}
  #chain-panel,#pipeline-config{border-right:none;border-bottom:1px solid var(--border-soft);max-height:none}
  #exec-panel,#pipeline-exec{overflow:visible}
  .panel,.pipeline-panel{padding:14px}
  .recipe-grid{grid-template-columns:1fr}
  .run-plan-grid{grid-template-columns:1fr}
  .exec-controls{flex-wrap:wrap}
  .header-doc-links{width:100%;flex-wrap:wrap}
  .tab-nav{width:100%}
  .mode-toggle{min-width:200px}
  .science-cards{grid-template-columns:repeat(2,minmax(0,1fr))}
  .science-grid{grid-template-columns:1fr}
}
@media(max-width:640px){
  .header-actions select{min-width:100px}
  #toast-stack{right:12px;bottom:12px}
  .docs-modal,.browse-modal,.permissions-help-modal,.run-plan-modal,.readonly-warning-modal,.science-dashboard-modal{max-height:88vh}
  .science-cards{grid-template-columns:1fr}
  .science-bar-row{grid-template-columns:72px 1fr 38px}
}
@media (prefers-reduced-motion: reduce){
  *,*::before,*::after{
    animation-duration:0.01ms !important;
    animation-iteration-count:1 !important;
    transition-duration:0.01ms !important;
    scroll-behavior:auto !important;
  }
}
</style>
</head>

<body>
<div id="sr-announcer" class="visually-hidden" aria-live="assertive" aria-atomic="true"></div>
<!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
<!-- HEADER                                                        -->
<!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
<header>
  <div class="header-brand">
    <div class="logo"><span>&#9889;</span> Codex Manager</div>
    <div class="header-doc-links">
      <button class="btn" onclick="openDoc('quickstart')" title="Open quick start guide">Quickstart</button>
      <button class="btn" onclick="openDoc('output_artifacts')" title="Open outputs and artifacts guide">Outputs</button>
      <button class="btn" onclick="openDoc('troubleshooting')" title="Open troubleshooting guide">Troubleshooting</button>
      <button class="btn" onclick="openDoc('cli_reference')" title="Open CLI reference">CLI Reference</button>
    </div>
    <div class="tab-nav" id="main-tabs" role="tablist" aria-label="Primary views">
      <button id="tab-chain" class="active" data-tab="chain" role="tab" tabindex="0" aria-selected="true" aria-controls="chain-view" onclick="switchTab('chain')">Chain Builder</button>
      <button id="tab-pipeline" data-tab="pipeline" role="tab" tabindex="-1" aria-selected="false" aria-controls="pipeline-view" onclick="switchTab('pipeline')">Pipeline</button>
    </div>
    <div class="header-shortcuts">
      <button type="button" class="btn" onclick="showTodoWishlistModal()">To-Do / Wishlist</button>
      <button type="button" class="btn btn-success" onclick="startTodoWishlistAutopilot()">Implement To-Do</button>
    </div>
  </div>
  <div class="header-actions">
    <div class="mode-toggle" id="difficulty-mode-toggle">
      <button type="button" data-mode="easy" onclick="applyMode('easy')" title="Autopilot: pick a recipe and go">Autopilot</button>
      <button type="button" data-mode="medium" onclick="applyMode('medium')" title="Customize: build and tweak steps">Customize</button>
      <button type="button" data-mode="expert" onclick="applyMode('expert')" title="Expert: full control">Expert</button>
    </div>
    <button class="btn btn-primary" onclick="showNewProjectModal()" style="white-space:nowrap">+ New Project</button>
    <select id="config-select" title="Saved configs">
      <option value="">Load config...</option>
    </select>
    <button class="btn" onclick="saveConfig()">Save</button>
    <button class="btn" onclick="loadConfigList()">Refresh</button>
    <button class="btn btn-danger" onclick="clearEverything()" title="Reset all settings and runtime UI to defaults">Clear Everything</button>
  </div>
</header>
<div id="backend-status-banner" class="state-card error" style="display:none;margin:8px 18px 0 18px">
  Backend connection lost. Waiting to reconnect.
</div>
<div id="watchdog-alert-banner" class="state-card warning" style="display:none;margin:8px 18px 0 18px">
  <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap">
    <strong>Model Watchdog Alerts</strong>
    <div style="display:flex;gap:6px;flex-wrap:wrap">
      <button class="btn btn-success" type="button" id="watchdog-apply-migrations-btn" style="display:none" onclick="applyWatchdogMigrationsFromBanner()">Apply migration suggestions</button>
      <button class="btn btn-warning" type="button" onclick="runWatchdogNowFromBanner()">Run now</button>
      <button class="btn" type="button" onclick="openDoc('model_watchdog')">Guide</button>
      <button class="btn" type="button" onclick="muteWatchdogAlerts(1)">Mute 1h</button>
    </div>
  </div>
  <div id="watchdog-alert-content" style="margin-top:8px;white-space:pre-wrap"></div>
</div>

<!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
<!-- MAIN LAYOUT                                                   -->
<!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
<main class="tab-content active" id="chain-view" role="tabpanel" aria-labelledby="tab-chain">

<!-- Ã¢â€â‚¬Ã¢â€â‚¬ LEFT PANEL: Chain Builder Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ -->
<aside class="panel" id="chain-panel">

  <h2>Task Chain</h2>

  <!-- Repository -->
  <div class="config-section">
    <div class="form-row">
      <label>Repository Path</label>
      <div class="repo-row">
        <input type="text" id="repo-path" placeholder="C:\path\to\your\repo" oninput="validateRepo()" title="Full path to your git repository">
        <button class="btn" onclick="openBrowse('repo-path')" title="Browse for folder">Browse</button>
        <span class="repo-status" id="repo-status" aria-live="polite"></span>
      </div>
    </div>
    <div class="diag-card">
      <div class="diag-head">
        <strong>Setup Diagnostics</strong>
        <button class="btn" onclick="refreshDiagnostics('chain')">Run</button>
      </div>
      <div class="diag-summary" id="diag-summary-chain">Run diagnostics to check repo, binaries, and auth setup.</div>
      <div class="diag-list" id="diag-list-chain">
        <div class="diag-item"><div class="diag-detail">No diagnostics run yet.</div></div>
      </div>
      <div class="diag-actions" id="diag-actions-chain"></div>
    </div>
    <div class="form-row easy-hide">
      <label>Mode <span class="help-icon easy-hide" title="Dry Run: preview changes only. Apply: commit and push.">?</span></label>
      <div class="mode-toggle" id="mode-toggle" title="Dry Run: preview only. Apply: commit and push.">
        <button class="active" data-mode="dry-run" onclick="setMode('dry-run')">&#128269; Dry Run</button>
        <button data-mode="apply" onclick="setMode('apply')">&#128295; Apply</button>
      </div>
    </div>
  </div>

  <!-- Recipe Picker (Easy mode only) -->
  <div class="config-section easy-only" id="recipe-section">
    <h3>Choose a Recipe</h3>
    <p style="font-size:12px;color:var(--text2);margin-bottom:10px">One-click preset chains. Pick one, set your repo above, then Start.</p>
    <div class="recipe-grid" id="recipe-grid">
      <div class="recipe-card" data-recipe="autopilot_default" onclick="selectRecipe('autopilot_default')" title="Easy Improvements -> New Features -> GUI/UX Polish -> Code Quality -> Bug Hunt -> Performance -> Open Ended">
        <div class="recipe-title">Autopilot Default</div>
        <div class="recipe-desc">7-step full sweep with scripted prompts and commits</div>
      </div>
      <div class="recipe-card" data-recipe="strategic" onclick="selectRecipe('strategic')" title="Strategic Product Maximization x2 -> Implementation x2 -> Testing x1 -> Bug Hunting x1">
        <div class="recipe-title">Strategic Product Max</div>
        <div class="recipe-desc">Highest leverage product wins with validation</div>
      </div>
      <div class="recipe-card" data-recipe="improve" onclick="selectRecipe('improve')" title="Feature Discovery x2 -> Implementation x2 -> Testing x1 -> Bug Hunting x1 -> Refactoring x1">
        <div class="recipe-title">Improve Everything</div>
        <div class="recipe-desc">Discovery, implementation, testing, bug hunting, refactoring</div>
      </div>
      <div class="recipe-card" data-recipe="fix" onclick="selectRecipe('fix')" title="Bug Hunting x3 -> Testing x2 -> Refactoring x1">
        <div class="recipe-title">Fix and Stabilize</div>
        <div class="recipe-desc">Bug hunting, testing, refactoring</div>
      </div>
      <div class="recipe-card" data-recipe="polish" onclick="selectRecipe('polish')" title="Refactoring x2 -> Performance x1 -> Documentation x2 -> Security Audit x1">
        <div class="recipe-title">Polish and Document</div>
        <div class="recipe-desc">Refactor, performance, docs, security audit</div>
      </div>
      <div class="recipe-card" data-recipe="test" onclick="selectRecipe('test')" title="Testing x3 -> Bug Hunting x2 -> Testing x2">
        <div class="recipe-title">Test Coverage</div>
        <div class="recipe-desc">Testing and bug hunting focus</div>
      </div>
      <div class="recipe-card" data-recipe="todo_wishlist_autopilot" onclick="selectRecipe('todo_wishlist_autopilot')" title="Create To-Do/Wishlist -> Implement open items until done">
        <div class="recipe-title">To-Do/Wishlist Autopilot</div>
        <div class="recipe-desc">Create backlog then implement items until completed</div>
      </div>
      <div class="recipe-card" data-recipe="feature_dream_autopilot" onclick="selectRecipe('feature_dream_autopilot')" title="Dream Up Feature List -> Implement features until done">
        <div class="recipe-title">Feature Dream Autopilot</div>
        <div class="recipe-desc">Dream up features and implement all open items</div>
      </div>
    </div>
  </div>

  <!-- Steps -->
  <div class="easy-hide">
    <h3>Steps <span id="step-count" style="color:var(--accent)">(0)</span><span class="help-icon easy-hide" title="Add, remove, reorder steps. Each step runs in sequence; use loop count to repeat.">?</span></h3>
    <div class="step-list" id="step-list"></div>
    <div class="step-collision-alert" id="step-collision-alert"></div>
    <button class="btn btn-add" onclick="addStep()">+ Add Step</button>
  </div>

  <!-- Step Details (shown when a step is selected) -->
  <div id="step-details-wrap" style="display:none" class="easy-hide">
    <div class="step-details" id="step-details"></div>
  </div>

  <!-- Stop Conditions -->
  <div class="config-section easy-hide">
    <h3>Stop Conditions <span class="help-icon easy-hide" title="When to stop the loop: max loops, max time, or unlimited until improvement is low.">?</span></h3>
    <div class="form-row" style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:10px;margin-bottom:12px">
      <label style="margin-bottom:6px"><input type="checkbox" id="unlimited" onchange="toggleUnlimited()"> <strong style="color:var(--accent)">Unlimited Mode</strong> - loop until diminishing returns</label>
      <div id="threshold-group" style="margin-top:8px;display:none" class="medium-hide">
        <label>Improvement Threshold (stop when below)</label>
        <div style="display:flex;align-items:center;gap:10px;margin-top:4px">
          <input type="range" id="threshold-slider" min="0.1" max="10" step="0.1" value="1.0" style="flex:1;accent-color:var(--accent)" oninput="document.getElementById('threshold-val').textContent=this.value+'%'">
          <span id="threshold-val" style="font-weight:600;color:var(--accent);min-width:44px;text-align:right">1.0%</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-top:2px">
          <span>0.1% (aggressive)</span>
          <span>10% (conservative)</span>
        </div>
      </div>
    </div>
    <div class="form-row-inline">
      <div class="form-row">
        <label>Max Loops <span id="max-loops-note" style="color:var(--text2)"></span></label>
        <input type="number" id="max-loops" value="3" min="1" max="10000">
      </div>
      <div class="form-row">
        <label>Max Time (min) <span id="max-time-note" style="color:var(--text2)"></span></label>
        <input type="number" id="max-time" value="120" min="0">
      </div>
    </div>
    <div class="form-row medium-hide">
      <label>Token Budget <span id="max-tokens-note" style="color:var(--text2)"></span></label>
      <input type="number" id="max-tokens" value="2000000" min="0" step="100000">
    </div>
    <div class="form-row medium-hide">
      <label><input type="checkbox" id="strict-token-budget"> Enforce token budget immediately</label>
      <div class="field-help">Off (default): budget checked after each full loop. On: stop right after a step exceeds budget.</div>
    </div>
    <div class="form-row medium-hide" id="convergence-row">
      <label><input type="checkbox" id="stop-convergence" checked> Stop on convergence (4 low-impact steps) <span id="convergence-note" style="color:var(--text2)"></span></label>
    </div>
  </div>

  <!-- Parallel Execution -->
  <div class="config-section easy-hide medium-hide">
    <h3>Execution Mode <span style="font-size:10px;color:var(--text2);font-weight:400;margin-left:4px">Expert</span></h3>
    <div class="form-row" style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:10px">
      <label style="margin-bottom:6px"><input type="checkbox" id="parallel-exec" onchange="config.parallel_execution=this.checked"> <strong style="color:var(--accent)">Parallel Execution</strong> - run steps concurrently</label>
      <p style="font-size:11px;color:var(--text2);margin:4px 0 0 22px">
        When enabled, all steps in a loop run at the same time. Assign different agents per step
        (e.g. Codex on implementation, Claude Code on testing) to maximise throughput.
      </p>
    </div>
  </div>

  <!-- Brain (AI Thinking Layer) -->
  <div class="config-section easy-hide">
    <h3>AI Brain</h3>
    <!-- Local Only Toggle -->
    <div class="form-row" style="background:linear-gradient(135deg, var(--bg), #1a2a1a);border:1px solid #2d5a2d;border-radius:var(--radius);padding:10px;margin-bottom:12px">
      <label style="margin-bottom:6px">
        <input type="checkbox" id="local-only" onchange="toggleLocalOnly()" style="accent-color:#4caf50">
        <strong style="color:#4caf50">Local Only</strong> - use only Ollama (no cloud APIs)
      </label>
      <p style="font-size:11px;color:var(--text2);margin:4px 0 0 22px">
        All brain / optimizer / scientist calls go through your local Ollama server. No data leaves your machine. Free.
      </p>
      <div id="ollama-status" style="margin:6px 0 0 22px;font-size:11px;display:none">
        <span id="ollama-status-icon"></span>
        <span id="ollama-status-text" style="color:var(--text2)"></span>
      </div>
    </div>
    <div class="form-row" style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:10px;margin-bottom:12px">
      <label style="margin-bottom:6px"><input type="checkbox" id="brain-enabled" onchange="toggleBrain()"> <strong style="color:var(--purple)">Enable Brain</strong> - AI thinks before Codex acts</label>
      <p style="font-size:11px;color:var(--text2);margin:4px 0 0 22px">
        Uses a separate AI model to plan prompts, evaluate results, handle errors, and escalate only when necessary.
      </p>
    </div>
    <div id="brain-options" style="display:none" class="medium-hide">
      <div class="form-row">
        <label>Brain Model <span style="font-size:10px;color:var(--text2);font-weight:400;margin-left:4px">Expert</span></label>
        <select id="brain-model" title="AI model used for planning and evaluating step results.">
          <optgroup label="OpenAI" class="cloud-model-group">
            <option value="gpt-5.2">GPT-5.2</option>
            <option value="gpt-4.1">GPT-4.1</option>
            <option value="gpt-4o">GPT-4o</option>
          </optgroup>
          <optgroup label="Anthropic" class="cloud-model-group">
            <option value="claude-opus-4-6">Claude Opus 4.6</option>
            <option value="claude-sonnet-4">Claude Sonnet 4</option>
          </optgroup>
          <optgroup label="Google" class="cloud-model-group">
            <option value="gemini-3-pro-preview">Gemini 3 Pro</option>
            <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
          </optgroup>
          <optgroup label="xAI" class="cloud-model-group">
            <option value="grok-4-1-fast-reasoning">Grok 4.1 Fast</option>
          </optgroup>
          <optgroup label="Local (Free)" id="chain-ollama-models">
            <option value="ollama:gemma3:27b">Ollama - Gemma 3 27B</option>
          </optgroup>
        </select>
      </div>
      <div style="display:flex;gap:8px;margin-top:4px">
        <span class="badge" style="font-size:10px;background:var(--surface2);color:var(--purple);padding:3px 8px;border-radius:12px">Plans prompts</span>
        <span class="badge" style="font-size:10px;background:var(--surface2);color:var(--success);padding:3px 8px;border-radius:12px">Evaluates results</span>
        <span class="badge" style="font-size:10px;background:var(--surface2);color:var(--warning);padding:3px 8px;border-radius:12px">Handles errors</span>
        <span class="badge" style="font-size:10px;background:var(--surface2);color:var(--danger);padding:3px 8px;border-radius:12px">Escalates if stuck</span>
      </div>
    </div>
  </div>

  <!-- Advanced -->
  <details class="config-section easy-hide medium-hide">
    <summary style="cursor:pointer;font-size:13px;font-weight:600;color:var(--text2)" title="Validation command, permissions, and runtime overrides.">Advanced Settings <span style="font-size:10px;color:var(--text2);font-weight:400;margin-left:4px">Expert</span></summary>
    <div style="margin-top:10px">
      <p class="field-help">Most users only need the first two settings below. Everything else is optional tuning.</p>

      <div class="adv-block">
        <h4>Common Settings</h4>
        <div class="form-row">
          <label>Validation Command (optional) <span class="help-icon" title="Command to verify changes after each step. Leave empty to skip validation.">?</span></label>
          <input type="text" id="test-cmd" value="" placeholder="e.g. python -m pytest -q">
          <div class="field-help">Runs after each step to catch regressions early.</div>
        </div>
        <div class="form-row">
          <label>Permission Profile <span class="help-icon" title="Pick a preset. Most users should use Recommended.">?</span></label>
          <select id="codex-permission-profile" onchange="setPermissionProfile('chain', this.value)">
            <option value="safe">Recommended: Safe Repo Access</option>
            <option value="readonly">Read-Only Inspect</option>
            <option value="full_access">Trusted Repo Full Access</option>
            <option value="custom">Custom (manual settings)</option>
          </select>
          <div class="field-help">Start with Recommended. Use Custom only if you need to tune low-level controls.</div>
          <div id="codex-permission-summary" class="perm-summary"></div>
          <div id="codex-permission-warning" class="perm-warning hidden">
            Full access bypasses sandbox and approval checks. Use only with trusted local repositories.
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" onclick="openPermissionsHelpModal()">What do these settings mean?</button>
          </div>
        </div>
      </div>

      <div class="adv-block">
        <h4>Autonomy and Assets</h4>
        <div class="form-row">
          <label><input type="checkbox" id="chain-allow-path-creation"> Allow creating new files and directories</label>
        </div>
        <div class="form-row">
          <label>Dependency Install Permissions</label>
          <select id="chain-dependency-install-policy">
            <option value="project_only">Project environment only (recommended)</option>
            <option value="disallow">Disallow installs</option>
            <option value="allow_system">Allow project + system-wide installs</option>
          </select>
          <div class="field-help">Controls whether agents can install dependencies during a run.</div>
        </div>
        <div class="form-row">
          <label><input type="checkbox" id="chain-image-generation-enabled" onchange="toggleChainImageOptions()"> Enable image generation for graphics/icons/assets</label>
        </div>
        <div id="chain-image-options" style="display:none">
          <div class="form-row">
            <label>Image Provider</label>
            <select id="chain-image-provider" onchange="onChainImageProviderChanged()">
              <option value="openai">OpenAI</option>
              <option value="google">Google</option>
            </select>
          </div>
          <div class="form-row">
            <label>Image Model</label>
            <input type="text" id="chain-image-model" value="gpt-image-1" placeholder="gpt-image-1 or nano-banana">
          </div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <label><input type="checkbox" id="chain-vector-memory-enabled" onchange="toggleChainVectorMemory()"> Enable per-repo vector memory (ChromaDB)</label>
          <div class="field-help">Stores high-signal step outcomes for long-term retrieval across chain and pipeline runs.</div>
        </div>
        <div id="chain-vector-memory-options" class="option-subpanel hidden">
          <div class="form-row">
            <label>Vector Backend</label>
            <select id="chain-vector-memory-backend">
              <option value="chroma">ChromaDB</option>
            </select>
          </div>
          <div class="form-row">
            <label>Collection Name <span style="color:var(--text2)">(optional)</span></label>
            <input type="text" id="chain-vector-memory-collection" placeholder="defaults to repo folder name">
          </div>
          <div class="form-row">
            <label>Memory Recall Top-K</label>
            <input type="number" id="chain-vector-memory-top-k" value="8" min="1" max="30">
          </div>
        </div>
      </div>

      <details class="adv-block">
        <summary>More Controls (optional)</summary>
        <div class="form-row" style="margin-top:8px">
          <label>
            <input type="checkbox" id="timeout-step-enabled" onchange="onChainTimeoutToggle()">
            Enforce Step Inactivity Timeout
            <span class="help-icon" title="When enabled, a step is stopped only after this many seconds with no stdout/stderr activity. Disable for unlimited runtime.">?</span>
          </label>
          <div class="field-help" id="timeout-step-note">Unlimited (no inactivity timeout).</div>
        </div>
        <div class="form-row">
          <label>Timeout Seconds</label>
          <input type="number" id="timeout-step" value="600" min="30" step="1" disabled>
        </div>

        <details class="perm-manual" id="codex-perm-manual">
          <summary>Manual Permission Controls</summary>
          <div class="form-row">
            <label>Filesystem Access Mode <span class="help-icon" title="workspace-write: read/write in repo only. read-only: inspect only. danger-full-access: broad local access.">?</span></label>
            <select id="codex-sandbox-mode" onchange="onPermissionControlChanged('chain')">
              <option value="workspace-write">workspace-write (recommended)</option>
              <option value="read-only">read-only</option>
              <option value="danger-full-access">danger-full-access</option>
            </select>
          </div>
          <div class="form-row">
            <label>Approval Prompt Mode <span class="help-icon" title="never: non-interactive runs. on-failure/on-request/untrusted: interactive approval prompts.">?</span></label>
            <select id="codex-approval-policy" onchange="onPermissionControlChanged('chain')">
              <option value="never">never (recommended for unattended runs)</option>
              <option value="on-failure">on-failure</option>
              <option value="on-request">on-request</option>
              <option value="untrusted">untrusted</option>
            </select>
          </div>
          <div class="form-row">
            <label>
              <input type="checkbox" id="codex-bypass-approvals" onchange="onPermissionControlChanged('chain')">
              Disable sandbox + approval prompts (trusted repo only)
            </label>
          </div>
        </details>

        <details class="perm-manual">
          <summary>CLI Command Overrides (rare)</summary>
          <div class="form-row">
            <label>Codex CLI Command <span class="help-icon" title="Path or command used to start Codex CLI.">?</span></label>
            <input type="text" id="codex-bin" value="codex">
          </div>
          <div class="form-row">
            <label>Codex Reasoning Effort <span class="help-icon" title="Controls how much reasoning Codex uses per task. Higher levels are usually slower and more expensive but can improve hard-problem quality.">?</span></label>
            <select id="codex-reasoning-effort" onchange="onPermissionControlChanged('chain')">
              <option value="xhigh">Extra High (recommended default)</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
              <option value="inherit">Inherit Codex CLI default</option>
            </select>
          </div>
          <div class="form-row">
            <label>Claude CLI Command <span class="help-icon" title="Path or command used to start Claude Code CLI.">?</span></label>
            <input type="text" id="claude-bin" value="claude">
          </div>
        </details>
      </details>
    </div>
  </details>

</aside>

<!-- Ã¢â€â‚¬Ã¢â€â‚¬ RIGHT PANEL: Execution Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ -->
<section class="panel" id="exec-panel">

  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2>Execution</h2>
    <div class="exec-controls">
      <button class="btn btn-success" id="btn-start" onclick="startChain()">&#9654; Start</button>
      <button class="btn btn-warning" id="btn-pause" onclick="pauseChain()" disabled>&#9208; Pause</button>
      <button class="btn btn-danger"  id="btn-stop"  onclick="stopChain()"  disabled>&#9209; Stop</button>
    </div>
  </div>

  <!-- Progress -->
  <div class="progress-section" id="progress-section">
    <div class="progress-info">
      <span id="progress-text">Ready</span>
      <span id="progress-tokens" style="color:var(--text2)">0 tokens</span>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
    <div class="activity-heartbeat" id="activity-heartbeat">Activity: idle</div>
    <div class="progress-last-log" id="progress-last-log">Last log: none yet</div>
    <div class="stop-guidance hidden" id="chain-stop-guidance" aria-live="polite"></div>
  </div>

  <!-- Live Log -->
  <div class="log-section">
    <h3>Live Log</h3>
    <div class="log-toolbar">
      <label><input type="checkbox" id="show-debug-logs" onchange="toggleDebugLogs()"> Show debug messages</label>
    </div>
    <div class="log-viewer" id="log-viewer" aria-live="polite">
      <div class="log-empty state-card">Waiting to start...</div>
    </div>
  </div>

  <div class="chain-outputs-section">
    <h3>Step Outputs</h3>
    <div class="form-row-inline" style="margin-bottom:8px">
      <select id="chain-output-select" onchange="viewChainOutput()">
        <option value="">No output files yet</option>
      </select>
      <button class="btn" onclick="refreshChainOutputs(true)">Refresh</button>
    </div>
    <div id="chain-output-dir" style="font-size:11px;color:var(--text2);margin-bottom:6px;white-space:normal;overflow-wrap:anywhere;word-break:break-word;max-width:100%"></div>
    <div class="log-content" id="chain-output-content" aria-live="polite">Run a chain to generate step output files.</div>
  </div>

  <div class="chain-outputs-section">
    <h3>Owner Decision Board (Monetization)</h3>
    <div class="form-row-inline" style="margin-bottom:8px">
      <button class="btn" onclick="generateDecisionBoardFromCurrentOutput()">Generate from current output</button>
      <button class="btn" onclick="loadOwnerDecisionBoard()">Refresh</button>
    </div>
    <div id="owner-board-warning" style="font-size:11px;color:var(--warning);margin-bottom:6px;white-space:pre-wrap"></div>
    <div class="log-content" id="owner-board-content" aria-live="polite">No decision board yet. Generate from a monetization output.</div>
  </div>

  <!-- Results -->
  <div class="results-section">
    <h3>Results</h3>
    <div class="results-wrap">
      <table class="results-table">
        <thead>
          <tr>
            <th>Loop</th>
            <th>Step</th>
            <th>Agent</th>
            <th>Tests</th>
            <th>Files</th>
            <th>Changed Files</th>
            <th>Net &Delta;</th>
            <th>Time</th>
            <th>Commit</th>
          </tr>
        </thead>
        <tbody id="results-body">
          <tr><td colspan="9"><div class="state-card">No execution results yet. Run a chain to populate this table.</div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

</section>
</main>

<!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
<!-- PIPELINE VIEW                                                  -->
<!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
<div class="tab-content" id="pipeline-view" role="tabpanel" aria-labelledby="tab-pipeline" hidden>

<!-- Ã¢â€â‚¬Ã¢â€â‚¬ LEFT: Pipeline Config Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ -->
<aside class="pipeline-panel" id="pipeline-config">

  <h2>Autonomous Pipeline</h2>

  <!-- Repository -->
  <div class="config-section">
    <div class="form-row">
      <label>Repository Path</label>
      <div class="repo-row">
        <input type="text" id="pipe-repo-path" placeholder="C:\path\to\your\repo" oninput="validatePipeRepo()">
        <button class="btn" onclick="openBrowse('pipe-repo-path')" title="Browse for folder">Browse</button>
        <span class="repo-status" id="pipe-repo-status" aria-live="polite"></span>
      </div>
    </div>
    <div class="diag-card">
      <div class="diag-head">
        <strong>Setup Diagnostics</strong>
        <button class="btn" onclick="refreshDiagnostics('pipeline')">Run</button>
      </div>
      <div class="diag-summary" id="diag-summary-pipeline">Run diagnostics to check repo, binaries, and auth setup.</div>
      <div class="diag-list" id="diag-list-pipeline">
        <div class="diag-item"><div class="diag-detail">No diagnostics run yet.</div></div>
      </div>
      <div class="diag-actions" id="diag-actions-pipeline"></div>
    </div>
    <div class="form-row">
      <label>Mode</label>
      <div class="mode-toggle" id="pipe-mode-toggle">
        <button class="active" data-mode="dry-run" onclick="setPipeMode('dry-run')">&#128269; Dry Run</button>
        <button data-mode="apply" onclick="setPipeMode('apply')">&#128295; Apply</button>
      </div>
    </div>
  </div>

  <!-- Phases -->
  <div class="config-section">
    <h3>Pipeline Phases</h3>
    <p style="font-size:11px;color:var(--text2);margin-bottom:10px">
      Each phase runs in order. Adjust iteration counts to control depth.
    </p>
    <div class="phase-list" id="phase-list"></div>
  </div>

  <!-- Science Mode -->
  <div class="config-section">
    <div class="form-row" style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:10px">
      <label style="margin-bottom:6px">
        <input type="checkbox" id="pipe-science" onchange="togglePipeScience()">
        <strong style="color:var(--purple)">Scientist Mode</strong> - theorize, experiment, skeptic, analyze
      </label>
      <p style="font-size:11px;color:var(--text2);margin:4px 0 0 22px">
        Applies the scientific method before implementation: forms testable hypotheses,
        runs controlled experiments, requires skeptical replication, and generates
        an action plan used by subsequent coding phases.
      </p>
    </div>
  </div>

  <!-- CUA Visual Testing -->
  <div class="config-section">
    <div class="form-row cua-card">
      <label class="cua-toggle-label">
        <input type="checkbox" id="pipe-cua" onchange="togglePipeCUA()">
        <strong>&#128065; Computer-Use Agent</strong> - AI visually tests the UI
      </label>
      <p class="cua-description">
        An AI agent launches a browser, navigates your app, clicks buttons, fills forms,
        and reports visual bugs. Uses screenshot-based vision models (OpenAI CUA or Anthropic Claude).
      </p>
      <div id="pipe-cua-options" class="cua-options">
        <div class="form-row cua-field">
          <label style="font-size:12px">CUA Provider</label>
          <select id="pipe-cua-provider" class="cua-input-sm">
            <option value="openai">OpenAI CUA (computer-use-preview)</option>
            <option value="anthropic">Anthropic Claude (computer use tool)</option>
          </select>
        </div>
        <div class="form-row cua-field">
          <label style="font-size:12px">Target URL</label>
          <input type="text" id="pipe-cua-url" placeholder="http://localhost:5088" class="cua-input-sm">
        </div>
        <div class="form-row">
          <label style="font-size:12px">Task / Goal</label>
          <textarea id="pipe-cua-task" rows="2" placeholder="Navigate the app, test interactive elements, report visual issues..." class="cua-task-input"></textarea>
        </div>
        <div class="cua-run-row">
          <button class="btn btn-primary btn-cua" onclick="runStandaloneCUA()">&#9654; Run CUA Now</button>
          <span id="pipe-cua-status" class="cua-status"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Stop Conditions (consistent with Chain Builder) -->
  <div class="config-section">
    <h3>Stop Conditions</h3>
    <div class="form-row" style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:10px;margin-bottom:12px">
      <label style="margin-bottom:6px"><input type="checkbox" id="pipe-unlimited" onchange="togglePipeUnlimited()"> <strong style="color:var(--accent)">Unlimited Mode</strong> - loop until diminishing returns</label>
      <div id="pipe-threshold-group" style="margin-top:8px;display:none">
        <label>Improvement Threshold (stop when below)</label>
        <div style="display:flex;align-items:center;gap:10px;margin-top:4px">
          <input type="range" id="pipe-threshold-slider" min="0.1" max="10" step="0.1" value="1.0" style="flex:1;accent-color:var(--accent)" oninput="document.getElementById('pipe-threshold-val').textContent=this.value+'%'">
          <span id="pipe-threshold-val" style="font-weight:600;color:var(--accent);min-width:44px;text-align:right">1.0%</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-top:2px">
          <span>0.1% (aggressive)</span>
          <span>10% (conservative)</span>
        </div>
      </div>
    </div>
    <div class="form-row-inline">
      <div class="form-row">
        <label>Max Cycles <span id="pipe-cycles-note" style="color:var(--text2)"></span></label>
        <input type="number" id="pipe-cycles" value="3" min="1" max="10000">
      </div>
      <div class="form-row">
        <label>Max Time (min) <span id="pipe-time-note" style="color:var(--text2)"></span></label>
        <input type="number" id="pipe-max-time" value="240" min="0">
      </div>
    </div>
    <div class="form-row">
      <label>Token Budget <span id="pipe-tokens-note" style="color:var(--text2)"></span></label>
      <input type="number" id="pipe-max-tokens" value="5000000" min="0" step="100000">
    </div>
    <div class="form-row">
      <label><input type="checkbox" id="pipe-strict-token-budget"> Enforce token budget immediately</label>
      <div class="field-help">Off (default): budget checked after each full cycle. On: stop right after a phase exceeds budget.</div>
    </div>
    <div class="form-row" id="pipe-convergence-row">
      <label><input type="checkbox" id="pipe-stop-convergence" checked> Stop on convergence (4 low-impact phases) <span id="pipe-convergence-note" style="color:var(--text2)"></span></label>
    </div>
  </div>

  <!-- Agent & Brain -->
  <div class="config-section">
    <h3>Agent &amp; Brain</h3>
    <div class="form-row">
      <label>Agent</label>
      <select id="pipe-agent">
        <option value="codex">Codex (OpenAI)</option>
        <option value="claude_code">Claude Code (Anthropic)</option>
      </select>
    </div>
    <!-- Local Only Toggle -->
    <div class="form-row" style="background:linear-gradient(135deg, var(--bg), #1a2a1a);border:1px solid #2d5a2d;border-radius:var(--radius);padding:10px;margin-top:8px">
      <label style="margin-bottom:6px">
        <input type="checkbox" id="pipe-local-only" onchange="togglePipeLocalOnly()" style="accent-color:#4caf50">
        <strong style="color:#4caf50">Local Only</strong> - use only Ollama (no cloud APIs)
      </label>
      <p style="font-size:11px;color:var(--text2);margin:4px 0 0 22px">
        All brain / optimizer / scientist calls go through your local Ollama server. Free, private, offline.
      </p>
      <div id="pipe-ollama-status" style="margin:6px 0 0 22px;font-size:11px;display:none">
        <span id="pipe-ollama-status-icon"></span>
        <span id="pipe-ollama-status-text" style="color:var(--text2)"></span>
      </div>
    </div>
    <div class="form-row" style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:10px;margin-top:8px">
      <label style="margin-bottom:4px">
        <input type="checkbox" id="pipe-brain" onchange="togglePipeBrain()">
        <strong style="color:var(--purple)">Enable Brain</strong> - AI thinks before agents act
      </label>
      <p style="font-size:11px;color:var(--text2);margin:4px 0 0 22px">
        Uses a separate AI model to plan prompts, evaluate results, handle errors, and escalate only when necessary.
      </p>
      <div id="pipe-brain-options" style="display:none;margin-top:8px">
        <label>Brain Model</label>
        <select id="pipe-brain-model">
          <optgroup label="OpenAI" class="cloud-model-group">
            <option value="gpt-5.2">GPT-5.2</option>
            <option value="gpt-4.1">GPT-4.1</option>
          </optgroup>
          <optgroup label="Anthropic" class="cloud-model-group">
            <option value="claude-opus-4-6">Claude Opus 4.6</option>
            <option value="claude-sonnet-4">Claude Sonnet 4</option>
          </optgroup>
          <optgroup label="Google" class="cloud-model-group">
            <option value="gemini-3-pro-preview">Gemini 3 Pro</option>
          </optgroup>
          <optgroup label="xAI" class="cloud-model-group">
            <option value="grok-4-1-fast-reasoning">Grok 4.1 Fast</option>
          </optgroup>
          <optgroup label="Local (Free)" id="pipe-ollama-models">
            <option value="ollama:gemma3:27b">Ollama - Gemma 3 27B</option>
          </optgroup>
        </select>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <span class="badge" style="font-size:10px;background:var(--surface2);color:var(--purple);padding:3px 8px;border-radius:12px">Plans prompts</span>
          <span class="badge" style="font-size:10px;background:var(--surface2);color:var(--success);padding:3px 8px;border-radius:12px">Evaluates results</span>
          <span class="badge" style="font-size:10px;background:var(--surface2);color:var(--warning);padding:3px 8px;border-radius:12px">Handles errors</span>
          <span class="badge" style="font-size:10px;background:var(--surface2);color:var(--danger);padding:3px 8px;border-radius:12px">Escalates if stuck</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Git Settings -->
  <div class="config-section">
    <h3>Git Settings</h3>
    <div class="form-row">
      <label><input type="checkbox" id="pipe-auto-commit" checked> Auto-commit after implementation &amp; debugging phases</label>
    </div>
    <div class="form-row">
      <label>Commit Frequency</label>
      <select id="pipe-commit-freq">
        <option value="per_phase">Per Phase</option>
        <option value="per_cycle">Per Cycle</option>
        <option value="manual">Manual (commit phase only)</option>
      </select>
    </div>
  </div>

  <!-- Advanced Settings (consistent with Chain Builder) -->
  <details class="config-section">
    <summary style="cursor:pointer;font-size:13px;font-weight:600;color:var(--text2)">Advanced Settings</summary>
    <div style="margin-top:10px">
      <p class="field-help">Most users only need the first two settings below. Everything else is optional tuning.</p>

      <div class="adv-block">
        <h4>Common Settings</h4>
        <div class="form-row">
          <label>Validation Command (optional) <span class="help-icon" title="Command to verify changes after each phase. Leave empty to skip validation.">?</span></label>
          <input type="text" id="pipe-test-cmd" value="" placeholder="e.g. python -m pytest -q">
          <div class="field-help">Runs after each phase to catch regressions early.</div>
        </div>
        <div class="form-row">
          <label>Permission Profile <span class="help-icon" title="Pick a preset. Most users should use Recommended.">?</span></label>
          <select id="pipe-codex-permission-profile" onchange="setPermissionProfile('pipeline', this.value)">
            <option value="safe">Recommended: Safe Repo Access</option>
            <option value="readonly">Read-Only Inspect</option>
            <option value="full_access">Trusted Repo Full Access</option>
            <option value="custom">Custom (manual settings)</option>
          </select>
          <div class="field-help">Start with Recommended. Use Custom only if you need to tune low-level controls.</div>
          <div id="pipe-codex-permission-summary" class="perm-summary"></div>
          <div id="pipe-codex-permission-warning" class="perm-warning hidden">
            Full access bypasses sandbox and approval checks. Use only with trusted local repositories.
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" onclick="openPermissionsHelpModal()">What do these settings mean?</button>
          </div>
        </div>
      </div>

      <div class="adv-block">
        <h4>Autonomy and Assets</h4>
        <div class="form-row">
          <label><input type="checkbox" id="pipe-allow-path-creation"> Allow creating new files and directories</label>
        </div>
        <div class="form-row">
          <label>Dependency Install Permissions</label>
          <select id="pipe-dependency-install-policy">
            <option value="project_only">Project environment only (recommended)</option>
            <option value="disallow">Disallow installs</option>
            <option value="allow_system">Allow project + system-wide installs</option>
          </select>
          <div class="field-help">Controls whether agents can install dependencies during a run.</div>
        </div>
        <div class="form-row">
          <label><input type="checkbox" id="pipe-image-generation-enabled" onchange="togglePipeImageOptions()"> Enable image generation for graphics/icons/assets</label>
        </div>
        <div id="pipe-image-options" style="display:none">
          <div class="form-row">
            <label>Image Provider</label>
            <select id="pipe-image-provider" onchange="onPipeImageProviderChanged()">
              <option value="openai">OpenAI</option>
              <option value="google">Google</option>
            </select>
          </div>
          <div class="form-row">
            <label>Image Model</label>
            <input type="text" id="pipe-image-model" value="gpt-image-1" placeholder="gpt-image-1 or nano-banana">
          </div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <label><input type="checkbox" id="pipe-vector-memory-enabled" onchange="togglePipeVectorMemory()"> Enable per-repo vector memory (ChromaDB)</label>
          <div class="field-help">Stores high-signal notes, phase outcomes, and research artifacts for long-term retrieval.</div>
        </div>
        <div id="pipe-vector-memory-options" class="option-subpanel hidden">
          <div class="form-row">
            <label>Vector Backend</label>
            <select id="pipe-vector-memory-backend">
              <option value="chroma">ChromaDB</option>
            </select>
          </div>
          <div class="form-row">
            <label>Collection Name <span style="color:var(--text2)">(optional)</span></label>
            <input type="text" id="pipe-vector-memory-collection" placeholder="defaults to repo folder name">
          </div>
          <div class="form-row">
            <label>Memory Recall Top-K</label>
            <input type="number" id="pipe-vector-memory-top-k" value="8" min="1" max="30">
          </div>
          <div class="field-help">Higher values provide more context, but may increase token usage.</div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <label><input type="checkbox" id="pipe-deep-research-enabled" onchange="togglePipeDeepResearch()"> Enable Deep Research phase</label>
          <div class="field-help">Adds a dedicated research step with cache-aware dedupe and persistent summaries.</div>
        </div>
        <div id="pipe-deep-research-options" class="option-subpanel hidden">
          <div class="form-row">
            <label>Research Provider Preference</label>
            <select id="pipe-deep-research-providers">
              <option value="both">OpenAI + Google</option>
              <option value="openai">OpenAI only</option>
              <option value="google">Google only</option>
            </select>
          </div>
          <div class="form-row">
            <label>Reuse Window (hours)</label>
            <input type="number" id="pipe-deep-research-max-age-hours" value="168" min="1" max="8760">
          </div>
          <div class="form-row">
            <label><input type="checkbox" id="pipe-deep-research-dedupe" checked> Skip redundant research when recent findings are similar</label>
          </div>
          <div class="form-row">
            <label><input type="checkbox" id="pipe-deep-research-native-enabled"> Prefer native provider deep-research APIs</label>
            <div class="field-help">Uses provider-native web-research calls with retries, quota limits, and budget controls before agent fallback.</div>
          </div>
          <div class="form-row-inline">
            <div class="form-row">
              <label>Retry Attempts</label>
              <input type="number" id="pipe-deep-research-retry-attempts" value="2" min="1" max="6">
            </div>
            <div class="form-row">
              <label>Daily Quota (runs)</label>
              <input type="number" id="pipe-deep-research-daily-quota" value="8" min="1" max="100">
            </div>
          </div>
          <div class="form-row-inline">
            <div class="form-row">
              <label>Per-Provider Max Tokens</label>
              <input type="number" id="pipe-deep-research-max-provider-tokens" value="12000" min="512" max="64000" step="128">
            </div>
            <div class="form-row">
              <label>Daily Budget (USD est.)</label>
              <input type="number" id="pipe-deep-research-budget-usd" value="5.0" min="0" step="0.1">
            </div>
          </div>
          <div class="form-row-inline">
            <div class="form-row">
              <label>OpenAI Deep Research Model</label>
              <input type="text" id="pipe-deep-research-openai-model" value="gpt-5.2">
            </div>
            <div class="form-row">
              <label>Google Deep Research Model</label>
              <input type="text" id="pipe-deep-research-google-model" value="gemini-3-pro-preview">
            </div>
          </div>
          <div class="form-row" style="margin-top:8px">
            <label>Source Governance Policy (global)</label>
            <div class="field-help">Domain allow/deny lists used for monetization governance checks and deep-research citation filtering.</div>
          </div>
          <div class="form-row-inline">
            <div class="form-row">
              <label>General Allowlist Domains</label>
              <input type="text" id="pipe-governance-research-allowed" placeholder="docs.python.org,openai.com">
            </div>
            <div class="form-row">
              <label>General Blocklist Domains</label>
              <input type="text" id="pipe-governance-research-blocked" placeholder="example.com,tiktok.com">
            </div>
          </div>
          <div class="form-row-inline">
            <div class="form-row">
              <label>Deep Research Allowlist Domains</label>
              <input type="text" id="pipe-governance-deep-allowed" placeholder="developer.mozilla.org,arxiv.org">
            </div>
            <div class="form-row">
              <label>Deep Research Blocklist Domains</label>
              <input type="text" id="pipe-governance-deep-blocked" placeholder="example.com,x.com">
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <button class="btn" type="button" onclick="loadGovernancePolicy()">Reload policy</button>
            <button class="btn btn-primary" type="button" onclick="saveGovernancePolicy()">Save policy</button>
          </div>
          <div class="field-help" id="pipe-governance-policy-status"></div>
        </div>

        <div class="form-row" style="margin-top:10px">
          <span class="scope-note">For <span class="program-name-slot">this program</span> only</span>
          <label><input type="checkbox" id="pipe-self-improvement-enabled" onchange="togglePipeSelfImprovement()"> Enable self-improvement restart checkpoint phase</label>
          <div class="field-help">Adds a special phase that writes a resume checkpoint so this program can restart and continue with updated code.</div>
        </div>
        <div class="form-row">
          <label><input type="checkbox" id="pipe-self-improvement-auto-restart"> Auto-restart this program and auto-resume from checkpoint</label>
        </div>
      </div>

      <details class="adv-block">
        <summary>More Controls (optional)</summary>
        <div class="form-row" style="margin-top:8px">
          <label>
            <input type="checkbox" id="pipe-timeout-enabled" onchange="onPipeTimeoutToggle()">
            Enforce Phase Inactivity Timeout
            <span class="help-icon" title="When enabled, a phase is stopped only after this many seconds with no stdout/stderr activity. Disable for unlimited runtime.">?</span>
          </label>
          <div class="field-help" id="pipe-timeout-note">Unlimited (no inactivity timeout).</div>
        </div>
        <div class="form-row">
          <label>Timeout Seconds</label>
          <input type="number" id="pipe-timeout" value="600" min="30" step="1" disabled>
        </div>

        <details class="perm-manual" id="pipe-codex-perm-manual">
          <summary>Manual Permission Controls</summary>
          <div class="form-row">
            <label>Filesystem Access Mode <span class="help-icon" title="workspace-write: read/write in repo only. read-only: inspect only. danger-full-access: broad local access.">?</span></label>
            <select id="pipe-codex-sandbox-mode" onchange="onPermissionControlChanged('pipeline')">
              <option value="workspace-write">workspace-write (recommended)</option>
              <option value="read-only">read-only</option>
              <option value="danger-full-access">danger-full-access</option>
            </select>
          </div>
          <div class="form-row">
            <label>Approval Prompt Mode <span class="help-icon" title="never: non-interactive runs. on-failure/on-request/untrusted: interactive approval prompts.">?</span></label>
            <select id="pipe-codex-approval-policy" onchange="onPermissionControlChanged('pipeline')">
              <option value="never">never (recommended for unattended runs)</option>
              <option value="on-failure">on-failure</option>
              <option value="on-request">on-request</option>
              <option value="untrusted">untrusted</option>
            </select>
          </div>
          <div class="form-row">
            <label>
              <input type="checkbox" id="pipe-codex-bypass-approvals" onchange="onPermissionControlChanged('pipeline')">
              Disable sandbox + approval prompts (trusted repo only)
            </label>
          </div>
        </details>

        <details class="perm-manual">
          <summary>CLI Command Overrides (rare)</summary>
          <div class="form-row">
            <label>Codex CLI Command <span class="help-icon" title="Path or command used to start Codex CLI.">?</span></label>
            <input type="text" id="pipe-codex-bin" value="codex">
          </div>
          <div class="form-row">
            <label>Codex Reasoning Effort <span class="help-icon" title="Controls how much reasoning Codex uses per task. Higher levels are usually slower and more expensive but can improve hard-problem quality.">?</span></label>
            <select id="pipe-codex-reasoning-effort" onchange="onPermissionControlChanged('pipeline')">
              <option value="xhigh">Extra High (recommended default)</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
              <option value="inherit">Inherit Codex CLI default</option>
            </select>
          </div>
          <div class="form-row">
            <label>Claude CLI Command <span class="help-icon" title="Path or command used to start Claude Code CLI.">?</span></label>
            <input type="text" id="pipe-claude-bin" value="claude">
          </div>
        </details>
      </details>
    </div>
  </details>

</aside>

<!-- Ã¢â€â‚¬Ã¢â€â‚¬ RIGHT: Pipeline Execution Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ -->
<section class="pipeline-panel" id="pipeline-exec">

  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2>Pipeline Execution</h2>
    <div class="exec-controls">
      <button class="btn btn-success" id="pipe-btn-start" onclick="startPipeline()">&#9654; Start Pipeline</button>
      <button class="btn btn-warning" id="pipe-btn-pause" onclick="pausePipeline()" disabled>&#9208; Pause</button>
      <button class="btn btn-danger"  id="pipe-btn-stop"  onclick="stopPipeline()"  disabled>&#9209; Stop</button>
    </div>
  </div>

  <!-- Progress -->
  <div class="progress-section">
    <div class="progress-info">
      <span id="pipe-progress-text">Ready</span>
      <span id="pipe-progress-tokens" style="color:var(--text2)">0 tokens</span>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="pipe-progress-fill"></div></div>
    <div class="activity-heartbeat" id="pipe-activity-heartbeat">Activity: idle</div>
    <div class="progress-last-log" id="pipe-progress-last-log">Last log: none yet</div>
    <div class="stop-guidance hidden" id="pipe-stop-guidance" aria-live="polite"></div>
  </div>

  <!-- Live Log + Log Files: one row for toolbar and tabs to avoid z-order overlap -->
  <div class="pipe-logs-wrap">
    <div class="pipe-logs-head-row">
      <div class="log-section pipe-logs-live">
        <h3>Live Log</h3>
        <div class="log-toolbar">
          <label><input type="checkbox" id="pipe-show-debug-logs" onchange="togglePipeDebugLogs()"> Show debug messages</label>
        </div>
      </div>
      <div class="log-files-section pipe-logs-files">
        <h3>Log Files</h3>
        <div class="log-tabs" id="log-file-tabs">
          <button class="active" data-file="WISHLIST.md" onclick="viewLogFile('WISHLIST.md')">WISHLIST</button>
          <button data-file="TESTPLAN.md" onclick="viewLogFile('TESTPLAN.md')">TESTPLAN</button>
          <button data-file="ERRORS.md" onclick="viewLogFile('ERRORS.md')">ERRORS</button>
          <button data-file="EXPERIMENTS.md" onclick="viewLogFile('EXPERIMENTS.md')">EXPERIMENTS</button>
          <button data-file="RESEARCH.md" onclick="viewLogFile('RESEARCH.md')">RESEARCH</button>
          <button data-file="SCIENTIST_REPORT.md" onclick="viewLogFile('SCIENTIST_REPORT.md')">SCIENCE REPORT</button>
          <button data-file="PROGRESS.md" onclick="viewLogFile('PROGRESS.md')">PROGRESS</button>
          <button data-file="BRAIN.md" onclick="viewLogFile('BRAIN.md')">BRAIN</button>
          <button data-file="HISTORY.md" onclick="viewLogFile('HISTORY.md')">HISTORY</button>
        </div>
        <div class="science-open-btn">
          <button class="btn btn-primary" onclick="openScienceDashboardModal()">Open Scientist Dashboard</button>
        </div>
      </div>
    </div>
    <div class="log-viewer" id="pipe-log-viewer" aria-live="polite">
      <div class="log-empty state-card">Configure phases and click Start Pipeline...</div>
    </div>
    <h3 id="log-file-label" style="margin-top:4px">Log File Contents</h3>
    <div class="log-content" id="log-file-content" aria-live="polite">Select a log file above to view its contents.</div>
  </div>

  <!-- Results -->
  <div class="results-section">
    <h3>Phase Results</h3>
    <div class="results-wrap">
      <table class="results-table">
        <thead>
          <tr>
            <th>Phase</th>
            <th>Iter</th>
            <th>Status</th>
            <th>Tests</th>
            <th>Files</th>
            <th>Changed Files</th>
            <th>Net &Delta;</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody id="pipe-results-body">
          <tr><td colspan="8"><div class="state-card">No pipeline results yet. Start a pipeline run to populate this table.</div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

</section>
</div>

<!-- Onboarding (first visit) -->
<div id="onboarding-overlay" class="hidden">
  <div class="onboarding-card" role="dialog" aria-modal="true" aria-labelledby="onboarding-title">
    <h2 id="onboarding-title">Welcome to Codex Manager</h2>
    <p>Configure and run AI-powered task chains on your repo: discovery, implementation, testing, refactoring, and more. Choose how much control you want:</p>
    <div class="mode-row"><strong>Autopilot</strong><span>Pick a recipe, set your repo path, and hit Start. Best for quick runs.</span></div>
    <div class="mode-row"><strong>Customize</strong><span>Build and reorder steps, set loop counts and stop conditions. No advanced options.</span></div>
    <div class="mode-row"><strong>Expert</strong><span>Full control: parallel execution, brain model, agent per step, timeouts, and advanced settings.</span></div>
    <button type="button" class="btn btn-primary" onclick="dismissOnboarding()">Get Started</button>
  </div>
</div>

<!-- To-Do / Wishlist modal -->
<div id="todo-wishlist-overlay" class="hidden" onclick="if(event.target===this)hideTodoWishlistModal()">
  <div class="todo-wishlist-card" role="dialog" aria-modal="true" aria-labelledby="todo-wishlist-title">
    <h2 id="todo-wishlist-title">To-Do / Wishlist Workspace</h2>
    <p class="subtitle">Write your own backlog or let AI generate one, then implement it with one click.</p>

    <div class="form-row">
      <label>Repository Path</label>
      <div class="repo-row">
        <input type="text" id="todo-wishlist-repo" placeholder="C:\path\to\your\repo">
        <button class="btn" type="button" onclick="syncTodoWishlistRepoFromMain()">Use Current Repo</button>
      </div>
    </div>

    <div class="form-row">
      <label>To-Do / Wishlist (markdown checklist)</label>
      <textarea id="todo-wishlist-content" rows="18" placeholder="- [ ] Add feature X&#10;- [ ] Improve Y"></textarea>
      <div class="field-help">Use <code>- [ ]</code> for open items and <code>- [x]</code> for completed items.</div>
    </div>

    <details>
      <summary>AI Suggestion (optional)</summary>
      <div class="form-row" style="margin-top:8px">
        <label>Extra context for AI</label>
        <textarea id="todo-wishlist-context" rows="4" placeholder="What kind of features, priorities, constraints, or timeline do you want?"></textarea>
      </div>
      <div class="form-row">
        <label>Suggestion Model</label>
        <select id="todo-wishlist-model">
          <option value="gpt-5.2">GPT-5.2</option>
          <option value="claude-opus-4-6">Claude Opus 4.6</option>
          <option value="gemini-3-pro-preview">Gemini 3 Pro</option>
          <option value="grok-4-1-fast-reasoning">Grok 4.1 Fast</option>
        </select>
      </div>
      <div class="inline-actions">
        <button class="btn" type="button" onclick="suggestTodoWishlist()">Suggest with AI</button>
        <button class="btn" type="button" onclick="appendTodoWishlistSuggestion()">Append Suggestion</button>
      </div>
      <div class="status" id="todo-wishlist-suggest-status"></div>
    </details>

    <div class="actions">
      <button class="btn" type="button" onclick="hideTodoWishlistModal()">Close</button>
      <button class="btn" type="button" onclick="loadTodoWishlist()">Load</button>
      <button class="btn btn-primary" type="button" onclick="saveTodoWishlist()">Save</button>
      <button class="btn btn-success" type="button" onclick="saveAndStartTodoWishlistAutopilot()">Save + Implement</button>
    </div>
  </div>
</div>

<!-- New Project modal -->
<div id="new-project-overlay" class="hidden">
  <div class="new-project-card" role="dialog" aria-modal="true" aria-labelledby="new-project-title">
    <h2 id="new-project-title">New Project</h2>
    <p class="subtitle">Create a new project folder with a local Git repository.</p>

    <div class="form-row">
      <label>Parent Directory</label>
      <input type="text" id="np-parent" placeholder="C:\Users\you\Projects">
    </div>
    <div class="form-row">
      <label>Project Name</label>
      <input type="text" id="np-name" placeholder="my-awesome-project">
    </div>
    <div class="form-row">
      <label>Description <span style="color:var(--text2)">(optional)</span></label>
      <input type="text" id="np-desc" placeholder="A short description for the README">
    </div>

    <div class="form-row">
      <label>Git Author Name</label>
      <input type="text" id="np-git-name" placeholder="Your Name" value="">
    </div>
    <div class="form-row">
      <label>Git Author Email</label>
      <input type="text" id="np-git-email" placeholder="you@example.com" value="">
    </div>

    <div class="toggle-row">
      <label><input type="checkbox" id="np-readme" checked> Create README.md</label>
      <label><input type="checkbox" id="np-gitignore" checked> Create .gitignore</label>
    </div>

    <details>
      <summary>Remote &amp; Branch Settings</summary>
      <div class="form-row">
        <label>Initial Branch Name</label>
        <input type="text" id="np-branch" placeholder="main" value="main">
      </div>
      <div class="form-row">
        <label>Remote URL <span style="color:var(--text2)">(optional - GitHub, GitLab, etc.)</span></label>
        <input type="text" id="np-remote" placeholder="https://github.com/you/repo.git">
      </div>
    </details>

    <details>
      <summary>Foundational Prompt &amp; Bootstrap (optional)</summary>
      <div class="form-row" style="margin-top:8px">
        <label><input type="checkbox" id="np-foundation-enabled" onchange="toggleFoundationOptions()"> Enable foundational prompt setup</label>
      </div>
      <div id="np-foundation-options" class="option-subpanel hidden">
        <div class="form-row">
          <label>Foundational Prompt</label>
          <textarea id="np-foundation-prompt" rows="8" placeholder="Describe what should be built, constraints, priorities, and quality bar..."></textarea>
        </div>
        <div class="form-row">
          <label>Prompt Improvement Assistants</label>
          <div class="foundation-tools">
            <label><input type="checkbox" class="np-foundation-assistant" value="codex" checked> Codex</label>
            <label><input type="checkbox" class="np-foundation-assistant" value="openai"> OpenAI</label>
            <label><input type="checkbox" class="np-foundation-assistant" value="google"> Google</label>
            <label><input type="checkbox" class="np-foundation-assistant" value="claude"> Claude</label>
            <button class="btn" type="button" onclick="improveFoundationalPrompt()">Improve my foundational prompt</button>
          </div>
          <div class="field-help" id="np-foundation-status">Choose assistants and click "Improve..." to refine prompt structure.</div>
        </div>
        <div class="toggle-row">
          <label><input type="checkbox" id="np-foundation-generate-docs" checked> Auto-generate foundational docs/plans</label>
          <label><input type="checkbox" id="np-foundation-bootstrap-once" checked> Mark one-time bootstrap request</label>
          <label><input type="checkbox" id="np-foundation-bootstrap-autorun" checked> Auto-run one-time bootstrap chain after project creation</label>
        </div>
      </div>
    </details>

    <details>
      <summary>Licensing &amp; Commercial Packaging (optional)</summary>
      <div class="form-row" style="margin-top:8px">
        <label><input type="checkbox" id="np-licensing-enabled" onchange="toggleLicensingOptions()"> Generate licensing/commercial planning docs</label>
      </div>
      <div id="np-licensing-options" class="option-subpanel hidden">
        <div class="form-row">
          <label>Strategy</label>
          <select id="np-licensing-strategy">
            <option value="oss_only">Open-source only</option>
            <option value="open_core">Open core (OSS + paid add-ons)</option>
            <option value="dual_license">Dual license (OSS + commercial)</option>
            <option value="hosted_service">Hosted service (SaaS/API)</option>
          </select>
        </div>
        <div class="toggle-row">
          <label><input type="checkbox" id="np-licensing-commercial" checked> Include pricing-tier planning template</label>
        </div>
        <div class="form-row">
          <label>Owner Contact Email <span style="color:var(--text2)">(optional)</span></label>
          <input type="text" id="np-licensing-email" placeholder="owner@example.com">
        </div>
        <div class="form-row">
          <label><input type="checkbox" id="np-licensing-legal-review-required" checked onchange="toggleLicensingLegalSignoff()"> Require legal-review checkpoint before publishing docs</label>
        </div>
        <div class="form-row">
          <label><input type="checkbox" id="np-licensing-legal-signoff"> Mark legal sign-off complete now</label>
        </div>
        <div class="form-row">
          <label>Legal Reviewer <span style="color:var(--text2)">(optional)</span></label>
          <input type="text" id="np-licensing-legal-reviewer" placeholder="owner or counsel">
        </div>
        <div class="form-row">
          <label>Legal Notes <span style="color:var(--text2)">(optional)</span></label>
          <input type="text" id="np-licensing-legal-notes" placeholder="Internal sign-off notes">
        </div>
        <div class="field-help">Creates draft docs under <code>docs/</code> and profile config under <code>.codex_manager/business/</code>.</div>
      </div>
    </details>

    <div class="creation-result" id="np-result"></div>

    <div class="actions">
      <button class="btn" onclick="hideNewProjectModal()">Cancel</button>
      <button class="btn btn-primary" id="np-create-btn" onclick="createProject()">Create Project</button>
    </div>
  </div>
</div>

<!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
<!-- JAVASCRIPT                                                    -->
<!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
<script>
/* Ã¢â€â‚¬Ã¢â€â‚¬ State Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
function cloneState(obj) {
  return JSON.parse(JSON.stringify(obj));
}

const config = {
  name: 'Untitled Chain',
  repo_path: '',
  mode: 'dry-run',
  steps: [],
  max_loops: 3,
  unlimited: false,
  improvement_threshold: 1.0,
  max_time_minutes: 120,
  max_total_tokens: 2000000,
  strict_token_budget: false,
  stop_on_convergence: true,
  test_cmd: '',
  codex_binary: 'codex',
  codex_reasoning_effort: 'xhigh',
  claude_binary: 'claude',
  codex_sandbox_mode: 'workspace-write',
  codex_approval_policy: 'never',
  codex_bypass_approvals_and_sandbox: false,
  codex_danger_confirmation: '',
  allow_path_creation: true,
  dependency_install_policy: 'project_only',
  image_generation_enabled: false,
  image_provider: 'openai',
  image_model: 'gpt-image-1',
  vector_memory_enabled: false,
  vector_memory_backend: 'chroma',
  vector_memory_collection: '',
  vector_memory_top_k: 8,
  timeout_per_step: 0,
  parallel_execution: false,
  brain_enabled: false,
  brain_model: 'gpt-5.2',
  local_only: false,
};
const DEFAULT_CHAIN_CONFIG = cloneState(config);

let presets = [];
let selectedStepId = null;
let eventSource = null;
let pollTimer = null;
let chainOutputFiles = [];
let _lastOutputRefreshStepCount = -1;
let chainResultsCache = [];
let pipeResultsCache = [];
let chainResultsCount = 0;
let pipeResultsCount = 0;
let _chainResultsRenderSignature = '';
let _pipeResultsRenderSignature = '';
let chainLogEntries = [];
let pipeLogEntries = [];
let chainLastActivityMs = 0;
let pipeLastActivityMs = 0;
let chainRunning = false;
let chainPaused = false;
let pipeRunning = false;
let pipePaused = false;
let activityHeartbeatTimer = null;
let backendHealthTimer = null;
let backendOnline = true;
let backendLastError = '';
let pendingServerRestart = null;
let selfRestartNoticeCheckpoint = '';
let watchdogAlertsTimer = null;
let watchdogAlertsMutedUntil = 0;
let watchdogAlertDigest = '';
let watchdogMigrationSuggestions = [];
const _autoVectorMemoryNotified = { chain: '', pipeline: '' };

let currentMode = (typeof localStorage !== 'undefined' && localStorage.getItem('cm_mode')) || 'easy';

const RECIPES_PAYLOAD = {{ recipes_payload | tojson }};
const RECIPES = (RECIPES_PAYLOAD && RECIPES_PAYLOAD.recipes) || {};
const DEFAULT_EASY_RECIPE_ID = (RECIPES_PAYLOAD && RECIPES_PAYLOAD.default_recipe_id) || 'autopilot_default';
const PROGRAM_DISPLAY_NAME = {{ project_display_name | tojson }};

const VALID_CODEX_SANDBOX_MODES = ['read-only', 'workspace-write', 'danger-full-access'];
const VALID_CODEX_APPROVAL_POLICIES = ['untrusted', 'on-failure', 'on-request', 'never'];
const VALID_CODEX_REASONING_EFFORTS = ['inherit', 'low', 'medium', 'high', 'xhigh'];
const VALID_DEPENDENCY_INSTALL_POLICIES = ['disallow', 'project_only', 'allow_system'];
const VALID_IMAGE_PROVIDERS = ['openai', 'google'];
const DEFAULT_IMAGE_MODEL_BY_PROVIDER = { openai: 'gpt-image-1', google: 'nano-banana' };
const DANGER_CONFIRMATION_PHRASE = 'I UNDERSTAND';
const PERMISSION_PROFILE_LABEL = {
  safe: 'Recommended: Safe Repo Access',
  readonly: 'Read-Only Inspect',
  full_access: 'Trusted Repo Full Access',
  custom: 'Custom',
};
const PERMISSION_PROFILE_SUMMARY = {
  safe: 'Recommended default. Read/write inside your repository with unattended execution.',
  readonly: 'Inspection mode. Reads repository files but does not allow writing changes.',
  full_access: 'Trusted-repo mode. Full local access with sandbox/approval checks disabled.',
  custom: 'Manual settings are active. Review sandbox, approval policy, and bypass toggle.',
};
const CODEX_MODEL_LABEL = 'GPT-5.3-Codex';
const _permissionProfileUiState = { chain: null, pipeline: null };
const _modalFocusReturnTargets = Object.create(null);
const _modalOverlayIds = [
  'docs-overlay',
  'science-dashboard-overlay',
  'permissions-help-overlay',
  'run-plan-overlay',
  'readonly-warning-overlay',
  'browse-overlay',
  'new-project-overlay',
  'todo-wishlist-overlay',
  'onboarding-overlay',
];

function _captureModalFocus(overlayId) {
  const active = document.activeElement;
  if (active && typeof active.focus === 'function') {
    _modalFocusReturnTargets[overlayId] = active;
  }
}

function _restoreModalFocus(overlayId) {
  const target = _modalFocusReturnTargets[overlayId];
  delete _modalFocusReturnTargets[overlayId];
  if (!target || !document.contains(target)) return;
  try {
    target.focus({ preventScroll: true });
  } catch (_err) {
    try { target.focus(); } catch (_err2) {}
  }
}

function _syncModalOpenState() {
  const anyOpen = _modalOverlayIds.some(id => {
    const el = document.getElementById(id);
    return !!el && !el.classList.contains('hidden');
  });
  document.body.classList.toggle('modal-open', anyOpen);
}

function _openOverlay(overlayId, focusSelector = '') {
  const overlay = document.getElementById(overlayId);
  if (!overlay) return null;
  _captureModalFocus(overlayId);
  overlay.classList.remove('hidden');
  _syncModalOpenState();
  if (focusSelector) {
    const focusTarget = overlay.querySelector(focusSelector);
    if (focusTarget && typeof focusTarget.focus === 'function') focusTarget.focus();
  }
  return overlay;
}

function applyProgramNameLabels() {
  const label = String(PROGRAM_DISPLAY_NAME || '').trim() || 'this program';
  document.querySelectorAll('.program-name-slot').forEach(el => {
    el.textContent = label;
  });
}

function _closeOverlay(overlayId) {
  const overlay = document.getElementById(overlayId);
  if (!overlay) return null;
  overlay.classList.add('hidden');
  _syncModalOpenState();
  _restoreModalFocus(overlayId);
  return overlay;
}

function normalizeCodexPermissions(cfg) {
  if (!VALID_CODEX_SANDBOX_MODES.includes(cfg.codex_sandbox_mode)) {
    cfg.codex_sandbox_mode = 'workspace-write';
  }
  if (!VALID_CODEX_APPROVAL_POLICIES.includes(cfg.codex_approval_policy)) {
    cfg.codex_approval_policy = 'never';
  }
  if (!VALID_CODEX_REASONING_EFFORTS.includes(cfg.codex_reasoning_effort)) {
    cfg.codex_reasoning_effort = 'xhigh';
  }
  cfg.codex_bypass_approvals_and_sandbox = !!cfg.codex_bypass_approvals_and_sandbox;
  cfg.codex_danger_confirmation = '';
}

function normalizeCapabilitySettings(cfg) {
  cfg.allow_path_creation = cfg.allow_path_creation !== false;
  const depPolicy = String(cfg.dependency_install_policy || 'project_only').trim().toLowerCase();
  cfg.dependency_install_policy = VALID_DEPENDENCY_INSTALL_POLICIES.includes(depPolicy)
    ? depPolicy
    : 'project_only';

  cfg.image_generation_enabled = !!cfg.image_generation_enabled;
  const provider = String(cfg.image_provider || 'openai').trim().toLowerCase();
  cfg.image_provider = VALID_IMAGE_PROVIDERS.includes(provider) ? provider : 'openai';
  cfg.image_model = String(cfg.image_model || '').trim();
  if (!cfg.image_model) cfg.image_model = DEFAULT_IMAGE_MODEL_BY_PROVIDER[cfg.image_provider];

  cfg.vector_memory_enabled = !!cfg.vector_memory_enabled;
  cfg.vector_memory_backend = String(cfg.vector_memory_backend || 'chroma').trim().toLowerCase();
  if (cfg.vector_memory_backend !== 'chroma') cfg.vector_memory_backend = 'chroma';
  cfg.vector_memory_collection = String(cfg.vector_memory_collection || '').trim();
  cfg.vector_memory_top_k = Math.min(30, Math.max(1, parseInt(cfg.vector_memory_top_k, 10) || 8));

  cfg.deep_research_enabled = !!cfg.deep_research_enabled;
  const providers = String(cfg.deep_research_providers || 'both').trim().toLowerCase();
  cfg.deep_research_providers = ['openai', 'google', 'both'].includes(providers) ? providers : 'both';
  cfg.deep_research_max_age_hours = Math.min(
    8760,
    Math.max(1, parseInt(cfg.deep_research_max_age_hours, 10) || 168),
  );
  cfg.deep_research_dedupe = cfg.deep_research_dedupe !== false;
  cfg.deep_research_native_enabled = !!cfg.deep_research_native_enabled;
  cfg.deep_research_retry_attempts = Math.min(
    6,
    Math.max(1, parseInt(cfg.deep_research_retry_attempts, 10) || 2),
  );
  cfg.deep_research_daily_quota = Math.min(
    100,
    Math.max(1, parseInt(cfg.deep_research_daily_quota, 10) || 8),
  );
  cfg.deep_research_max_provider_tokens = Math.min(
    64000,
    Math.max(512, parseInt(cfg.deep_research_max_provider_tokens, 10) || 12000),
  );
  cfg.deep_research_budget_usd = Math.max(0, parseFloat(cfg.deep_research_budget_usd) || 5.0);
  cfg.deep_research_openai_model = String(cfg.deep_research_openai_model || 'gpt-5.2').trim() || 'gpt-5.2';
  cfg.deep_research_google_model = String(cfg.deep_research_google_model || 'gemini-3-pro-preview').trim() || 'gemini-3-pro-preview';
}

function syncChainCapabilityControlsFromConfig() {
  normalizeCapabilitySettings(config);
  document.getElementById('chain-allow-path-creation').checked = !!config.allow_path_creation;
  document.getElementById('chain-dependency-install-policy').value = config.dependency_install_policy;
  document.getElementById('chain-image-generation-enabled').checked = !!config.image_generation_enabled;
  document.getElementById('chain-image-provider').value = config.image_provider;
  document.getElementById('chain-image-model').value = config.image_model || DEFAULT_IMAGE_MODEL_BY_PROVIDER[config.image_provider];
  document.getElementById('chain-vector-memory-enabled').checked = !!config.vector_memory_enabled;
  document.getElementById('chain-vector-memory-backend').value = config.vector_memory_backend || 'chroma';
  document.getElementById('chain-vector-memory-collection').value = config.vector_memory_collection || '';
  document.getElementById('chain-vector-memory-top-k').value = config.vector_memory_top_k || 8;
  toggleChainImageOptions(false);
  toggleChainVectorMemory(false);
}

function syncPipelineCapabilityControlsFromConfig() {
  normalizeCapabilitySettings(pipeConfig);
  document.getElementById('pipe-allow-path-creation').checked = !!pipeConfig.allow_path_creation;
  document.getElementById('pipe-dependency-install-policy').value = pipeConfig.dependency_install_policy;
  document.getElementById('pipe-image-generation-enabled').checked = !!pipeConfig.image_generation_enabled;
  document.getElementById('pipe-image-provider').value = pipeConfig.image_provider;
  document.getElementById('pipe-image-model').value = pipeConfig.image_model || DEFAULT_IMAGE_MODEL_BY_PROVIDER[pipeConfig.image_provider];
  document.getElementById('pipe-vector-memory-enabled').checked = !!pipeConfig.vector_memory_enabled;
  document.getElementById('pipe-vector-memory-backend').value = pipeConfig.vector_memory_backend || 'chroma';
  document.getElementById('pipe-vector-memory-collection').value = pipeConfig.vector_memory_collection || '';
  document.getElementById('pipe-vector-memory-top-k').value = pipeConfig.vector_memory_top_k || 8;
  document.getElementById('pipe-deep-research-enabled').checked = !!pipeConfig.deep_research_enabled;
  document.getElementById('pipe-deep-research-providers').value = pipeConfig.deep_research_providers || 'both';
  document.getElementById('pipe-deep-research-max-age-hours').value = pipeConfig.deep_research_max_age_hours || 168;
  document.getElementById('pipe-deep-research-dedupe').checked = pipeConfig.deep_research_dedupe !== false;
  document.getElementById('pipe-deep-research-native-enabled').checked = !!pipeConfig.deep_research_native_enabled;
  document.getElementById('pipe-deep-research-retry-attempts').value = pipeConfig.deep_research_retry_attempts || 2;
  document.getElementById('pipe-deep-research-daily-quota').value = pipeConfig.deep_research_daily_quota || 8;
  document.getElementById('pipe-deep-research-max-provider-tokens').value = pipeConfig.deep_research_max_provider_tokens || 12000;
  document.getElementById('pipe-deep-research-budget-usd').value = pipeConfig.deep_research_budget_usd || 5.0;
  document.getElementById('pipe-deep-research-openai-model').value = pipeConfig.deep_research_openai_model || 'gpt-5.2';
  document.getElementById('pipe-deep-research-google-model').value = pipeConfig.deep_research_google_model || 'gemini-3-pro-preview';
  document.getElementById('pipe-self-improvement-enabled').checked = !!pipeConfig.self_improvement_enabled;
  document.getElementById('pipe-self-improvement-auto-restart').checked = !!pipeConfig.self_improvement_auto_restart;
  document.getElementById('pipe-self-improvement-auto-restart').disabled = !pipeConfig.self_improvement_enabled;
  togglePipeImageOptions(false);
  togglePipeVectorMemory(false);
  togglePipeDeepResearch(false);
}

function toggleChainImageOptions(syncConfig = true) {
  const enabled = document.getElementById('chain-image-generation-enabled').checked;
  document.getElementById('chain-image-options').style.display = enabled ? '' : 'none';
  if (syncConfig) {
    config.image_generation_enabled = enabled;
    normalizeCapabilitySettings(config);
  }
}

function onChainImageProviderChanged() {
  const provider = document.getElementById('chain-image-provider').value;
  config.image_provider = provider;
  const modelInput = document.getElementById('chain-image-model');
  if (!String(modelInput.value || '').trim()) {
    modelInput.value = DEFAULT_IMAGE_MODEL_BY_PROVIDER[provider] || 'gpt-image-1';
  }
  config.image_model = modelInput.value.trim();
  normalizeCapabilitySettings(config);
}

function toggleChainVectorMemory(syncConfig = true) {
  const enabled = document.getElementById('chain-vector-memory-enabled').checked;
  const panel = document.getElementById('chain-vector-memory-options');
  panel.classList.toggle('hidden', !enabled);
  if (syncConfig) {
    config.vector_memory_enabled = enabled;
    normalizeCapabilitySettings(config);
  }
}

function togglePipeImageOptions(syncConfig = true) {
  const enabled = document.getElementById('pipe-image-generation-enabled').checked;
  document.getElementById('pipe-image-options').style.display = enabled ? '' : 'none';
  if (syncConfig) {
    pipeConfig.image_generation_enabled = enabled;
    normalizeCapabilitySettings(pipeConfig);
  }
}

function onPipeImageProviderChanged() {
  const provider = document.getElementById('pipe-image-provider').value;
  pipeConfig.image_provider = provider;
  const modelInput = document.getElementById('pipe-image-model');
  if (!String(modelInput.value || '').trim()) {
    modelInput.value = DEFAULT_IMAGE_MODEL_BY_PROVIDER[provider] || 'gpt-image-1';
  }
  pipeConfig.image_model = modelInput.value.trim();
  normalizeCapabilitySettings(pipeConfig);
}

function togglePipeVectorMemory(syncConfig = true) {
  const enabled = document.getElementById('pipe-vector-memory-enabled').checked;
  const panel = document.getElementById('pipe-vector-memory-options');
  panel.classList.toggle('hidden', !enabled);
  if (syncConfig) {
    pipeConfig.vector_memory_enabled = enabled;
    normalizeCapabilitySettings(pipeConfig);
  }
}

function togglePipeDeepResearch(syncConfig = true) {
  const enabled = document.getElementById('pipe-deep-research-enabled').checked;
  const panel = document.getElementById('pipe-deep-research-options');
  panel.classList.toggle('hidden', !enabled);
  if (syncConfig) {
    pipeConfig.deep_research_enabled = enabled;
    normalizeCapabilitySettings(pipeConfig);
  }
  renderPipelinePhases();
}

function _normalizeDomainCsv(value) {
  const tokens = String(value || '')
    .toLowerCase()
    .split(/[\s,;]+/)
    .map(chunk => chunk.trim().replace(/^\./, ''))
    .filter(Boolean);
  return Array.from(new Set(tokens)).join(',');
}

function _setGovernancePolicyStatus(text, tone = 'muted') {
  const el = document.getElementById('pipe-governance-policy-status');
  if (!el) return;
  el.textContent = String(text || '');
  if (tone === 'ok') el.style.color = 'var(--success)';
  else if (tone === 'warn') el.style.color = 'var(--warning)';
  else if (tone === 'error') el.style.color = 'var(--danger)';
  else el.style.color = 'var(--text2)';
}

function _applyGovernancePolicyToUi(policy) {
  const payload = policy || {};
  const map = {
    research_allowed_domains: 'pipe-governance-research-allowed',
    research_blocked_domains: 'pipe-governance-research-blocked',
    deep_research_allowed_domains: 'pipe-governance-deep-allowed',
    deep_research_blocked_domains: 'pipe-governance-deep-blocked',
  };
  Object.keys(map).forEach(key => {
    const el = document.getElementById(map[key]);
    if (!el) return;
    el.value = _normalizeDomainCsv(payload[key] || '');
  });
}

function _readGovernancePolicyFromUi() {
  return {
    research_allowed_domains: _normalizeDomainCsv(document.getElementById('pipe-governance-research-allowed').value),
    research_blocked_domains: _normalizeDomainCsv(document.getElementById('pipe-governance-research-blocked').value),
    deep_research_allowed_domains: _normalizeDomainCsv(document.getElementById('pipe-governance-deep-allowed').value),
    deep_research_blocked_domains: _normalizeDomainCsv(document.getElementById('pipe-governance-deep-blocked').value),
  };
}

async function loadGovernancePolicy(opts = {}) {
  try {
    const resp = await api('/api/governance/source-policy');
    if (resp.error) throw new Error(resp.error);
    _applyGovernancePolicyToUi(resp);
    if (!opts.silent) {
      _setGovernancePolicyStatus('Governance policy loaded.', 'ok');
    } else {
      _setGovernancePolicyStatus('Governance policy loaded from server.', 'muted');
    }
  } catch (err) {
    const message = (err && err.message) ? err.message : String(err);
    _setGovernancePolicyStatus('Could not load policy: ' + message, 'error');
    if (!opts.silent) {
      toast('Could not load governance policy: ' + message, 'error');
    }
  }
}

async function saveGovernancePolicy() {
  const payload = _readGovernancePolicyFromUi();
  try {
    const resp = await postJson('/api/governance/source-policy', payload);
    if (resp.error) throw new Error(resp.error);
    const saved = (resp && resp.policy) ? resp.policy : payload;
    _applyGovernancePolicyToUi(saved);
    _setGovernancePolicyStatus('Governance policy saved.', 'ok');
    toast('Governance source policy saved', 'success');
  } catch (err) {
    const message = (err && err.message) ? err.message : String(err);
    _setGovernancePolicyStatus('Could not save policy: ' + message, 'error');
    toast('Could not save governance policy: ' + message, 'error');
  }
}

function togglePipeSelfImprovement() {
  const enabled = document.getElementById('pipe-self-improvement-enabled').checked;
  pipeConfig.self_improvement_enabled = enabled;
  const autoRestartEl = document.getElementById('pipe-self-improvement-auto-restart');
  autoRestartEl.disabled = !enabled;
  if (!enabled) autoRestartEl.checked = false;
  pipeConfig.self_improvement_auto_restart = !!autoRestartEl.checked;
  renderPipelinePhases();
}

function _permissionProfileFromConfig(cfg) {
  if (cfg.codex_bypass_approvals_and_sandbox) return 'full_access';
  if (cfg.codex_sandbox_mode === 'read-only') return 'readonly';
  if (
    cfg.codex_sandbox_mode === 'workspace-write'
    && cfg.codex_approval_policy === 'never'
    && !cfg.codex_bypass_approvals_and_sandbox
  ) return 'safe';
  return 'custom';
}

function _applyPermissionProfile(cfg, profile) {
  if (profile === 'readonly') {
    cfg.codex_sandbox_mode = 'read-only';
    cfg.codex_approval_policy = 'never';
    cfg.codex_bypass_approvals_and_sandbox = false;
  } else if (profile === 'full_access') {
    cfg.codex_sandbox_mode = 'danger-full-access';
    cfg.codex_approval_policy = 'never';
    cfg.codex_bypass_approvals_and_sandbox = true;
  } else if (profile === 'safe') {
    cfg.codex_sandbox_mode = 'workspace-write';
    cfg.codex_approval_policy = 'never';
    cfg.codex_bypass_approvals_and_sandbox = false;
  }
  cfg.codex_danger_confirmation = '';
}

function _permissionUiRefs(target) {
  const isPipe = target === 'pipeline';
  return {
    cfg: isPipe ? pipeConfig : config,
    profile: document.getElementById(isPipe ? 'pipe-codex-permission-profile' : 'codex-permission-profile'),
    summary: document.getElementById(isPipe ? 'pipe-codex-permission-summary' : 'codex-permission-summary'),
    warning: document.getElementById(isPipe ? 'pipe-codex-permission-warning' : 'codex-permission-warning'),
    manual: document.getElementById(isPipe ? 'pipe-codex-perm-manual' : 'codex-perm-manual'),
    sandbox: document.getElementById(isPipe ? 'pipe-codex-sandbox-mode' : 'codex-sandbox-mode'),
    approval: document.getElementById(isPipe ? 'pipe-codex-approval-policy' : 'codex-approval-policy'),
    bypass: document.getElementById(isPipe ? 'pipe-codex-bypass-approvals' : 'codex-bypass-approvals'),
  };
}

function resetPermissionProfileUiState(target) {
  _permissionProfileUiState[target === 'pipeline' ? 'pipeline' : 'chain'] = null;
}

function updatePermissionUi(target) {
  const refs = _permissionUiRefs(target);
  const inferred = _permissionProfileFromConfig(refs.cfg);
  const sticky = _permissionProfileUiState[target];
  const profile = sticky === 'custom' ? 'custom' : inferred;
  if (sticky !== 'custom') _permissionProfileUiState[target] = inferred;
  if (refs.profile) refs.profile.value = profile;
  if (refs.summary) {
    if (profile === 'custom' && inferred !== 'custom') {
      refs.summary.textContent = 'Custom profile selected. Current values match '
        + PERMISSION_PROFILE_LABEL[inferred] + '.';
    } else {
      refs.summary.textContent = PERMISSION_PROFILE_SUMMARY[profile];
    }
  }
  if (refs.warning) {
    const bypassRisk = refs.cfg.codex_bypass_approvals_and_sandbox;
    const sandboxRisk = refs.cfg.codex_sandbox_mode === 'danger-full-access';
    const risky = bypassRisk || sandboxRisk;
    refs.warning.textContent = bypassRisk
      ? 'Full access bypasses sandbox and approval checks. Use only with trusted local repositories.'
      : 'Danger sandbox mode enables broad local access. Use only with trusted local repositories.';
    refs.warning.classList.toggle('hidden', !risky);
  }
}

function syncChainPermissionControlsFromConfig() {
  document.getElementById('codex-sandbox-mode').value = config.codex_sandbox_mode || 'workspace-write';
  document.getElementById('codex-approval-policy').value = config.codex_approval_policy || 'never';
  document.getElementById('codex-reasoning-effort').value = config.codex_reasoning_effort || 'xhigh';
  document.getElementById('codex-bypass-approvals').checked = !!config.codex_bypass_approvals_and_sandbox;
  updatePermissionUi('chain');
}

function syncPipelinePermissionControlsFromConfig() {
  document.getElementById('pipe-codex-sandbox-mode').value = pipeConfig.codex_sandbox_mode || 'workspace-write';
  document.getElementById('pipe-codex-approval-policy').value = pipeConfig.codex_approval_policy || 'never';
  document.getElementById('pipe-codex-reasoning-effort').value = pipeConfig.codex_reasoning_effort || 'xhigh';
  document.getElementById('pipe-codex-bypass-approvals').checked = !!pipeConfig.codex_bypass_approvals_and_sandbox;
  updatePermissionUi('pipeline');
}

function setPermissionProfile(target, profile) {
  const refs = _permissionUiRefs(target);
  if (profile === 'custom') {
    _permissionProfileUiState[target] = 'custom';
    if (refs.manual) refs.manual.open = true;
    updatePermissionUi(target);
    toast('Custom profile selected', 'info');
    return;
  }
  _permissionProfileUiState[target] = profile;
  _applyPermissionProfile(refs.cfg, profile);
  if (refs.manual) refs.manual.open = false;
  if (target === 'pipeline') syncPipelinePermissionControlsFromConfig();
  else syncChainPermissionControlsFromConfig();

  if (profile === 'safe') toast('Applied Recommended: Safe Repo Access', 'info');
  if (profile === 'readonly') toast('Applied Read-Only Inspect profile', 'info');
  if (profile === 'full_access') toast('Applied Trusted Repo Full Access profile', 'info');
}

function onPermissionControlChanged(target) {
  const refs = _permissionUiRefs(target);
  refs.cfg.codex_sandbox_mode = refs.sandbox.value;
  refs.cfg.codex_approval_policy = refs.approval.value;
  refs.cfg.codex_reasoning_effort = (target === 'pipeline'
    ? document.getElementById('pipe-codex-reasoning-effort')
    : document.getElementById('codex-reasoning-effort')
  ).value;
  refs.cfg.codex_bypass_approvals_and_sandbox = !!refs.bypass.checked;
  refs.cfg.codex_danger_confirmation = '';
  normalizeCodexPermissions(refs.cfg);
  _permissionProfileUiState[target] = 'custom';
  if (refs.manual) refs.manual.open = true;
  if (target === 'pipeline') syncPipelinePermissionControlsFromConfig();
  else syncChainPermissionControlsFromConfig();
}

function openPermissionsHelpModal() {
  _openOverlay('permissions-help-overlay', '.permissions-help-header .btn');
}

function closePermissionsHelpModal() {
  _closeOverlay('permissions-help-overlay');
}

function closeDocsModal() {
  _closeOverlay('docs-overlay');
}

function _setActiveDocTab(docKey) {
  document.querySelectorAll('#docs-tab-row [data-doc]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.doc === docKey);
  });
}

async function loadDoc(docKey) {
  _setActiveDocTab(docKey);
  const titleEl = document.getElementById('docs-title');
  const subtitleEl = document.getElementById('docs-subtitle');
  const contentEl = document.getElementById('docs-content');
  if (!contentEl) return;

  contentEl.textContent = 'Loading documentation...';
  if (titleEl) titleEl.textContent = 'Documentation';
  if (subtitleEl) subtitleEl.textContent = '';

  try {
    const doc = await api('/api/docs/' + docKey);
    if (doc.error) throw new Error(doc.error);
    if (titleEl) titleEl.textContent = doc.title || 'Documentation';
    if (subtitleEl) subtitleEl.textContent = doc.filename || '';
    contentEl.textContent = doc.content || '(empty)';
  } catch (e) {
    if (titleEl) titleEl.textContent = 'Documentation';
    if (subtitleEl) subtitleEl.textContent = 'Could not load document';
    contentEl.textContent = 'Could not load this guide. ' + (e && e.message ? e.message : '');
  }
}

function openDoc(docKey) {
  const overlay = _openOverlay('docs-overlay', '.docs-modal-header .btn');
  if (!overlay) return;
  loadDoc(docKey || 'quickstart');
}

let _runPlanResolver = null;
let _runPlanTarget = 'chain';

function _runPlanTargetLabel(target) {
  return target === 'pipeline' ? 'Pipeline' : 'Chain';
}

function updateRunPlanModalPreview() {
  const modeEl = document.getElementById('run-plan-mode');
  const profileEl = document.getElementById('run-plan-profile');
  if (!modeEl || !profileEl) return;

  const runMode = modeEl.value || 'dry-run';
  const profile = profileEl.value || 'safe';
  const modeLabel = runMode === 'apply' ? 'Apply' : 'Dry Run';
  const profileLabel = PERMISSION_PROFILE_LABEL[profile] || profile;
  const modeLine = document.getElementById('run-plan-summary-mode');
  const profileLine = document.getElementById('run-plan-summary-profile');
  const callout = document.getElementById('run-plan-summary-callout');
  const dangerWrap = document.getElementById('run-plan-danger-wrap');
  const dangerAck = document.getElementById('run-plan-danger-ack');

  if (modeLine) {
    modeLine.innerHTML = '<strong>Execution:</strong> ' + modeLabel
      + (runMode === 'dry-run'
        ? ' (edits are reverted at the end of the run)'
        : ' (edits are kept and can be committed)');
  }
  if (profileLine) {
    profileLine.innerHTML = '<strong>Codex Access:</strong> ' + profileLabel;
  }

  if (dangerWrap) {
    const showDangerAck = profile === 'full_access';
    dangerWrap.classList.toggle('hidden', !showDangerAck);
    if (!showDangerAck && dangerAck) dangerAck.checked = false;
  }

  if (!callout) return;
  callout.classList.remove('warn', 'danger');
  if (profile === 'full_access') {
    callout.textContent = (
      runMode === 'dry-run'
        ? 'Trusted Repo Full Access selected in Dry Run: edits are still reverted at the end, but sandbox and approval checks are disabled during execution.'
        : 'Trusted Repo Full Access: sandbox and approval checks are disabled. Use only for repositories you fully trust.'
    );
    callout.classList.add('danger');
    return;
  }
  if (runMode === 'dry-run') {
    callout.textContent = 'Dry Run preview: Codex can attempt edits, tests, and analysis, but workspace changes are reverted before completion.';
    callout.classList.add('warn');
    return;
  }
  if (profile === 'readonly') {
    callout.textContent = 'Read-Only Inspect selected: Codex can analyze but cannot write files, even in Apply mode.';
    callout.classList.add('warn');
    return;
  }
  callout.textContent = 'Recommended Safe Repo Access: Codex can read/write inside your repository with unattended execution.';
}

function openRunPlanModal(target) {
  const normalizedTarget = target === 'pipeline' ? 'pipeline' : 'chain';
  const overlay = document.getElementById('run-plan-overlay');
  if (!overlay) return Promise.resolve({ action: 'confirm', target: normalizedTarget, mode: 'dry-run', profile: 'safe' });

  _runPlanTarget = normalizedTarget;
  const cfg = normalizedTarget === 'pipeline' ? pipeConfig : config;
  const inferredProfile = _permissionProfileFromConfig(cfg);
  const defaultProfile = ['safe', 'readonly', 'full_access'].includes(inferredProfile)
    ? inferredProfile
    : 'safe';

  const area = _runPlanTargetLabel(normalizedTarget);
  const modeEl = document.getElementById('run-plan-mode');
  const profileEl = document.getElementById('run-plan-profile');
  const titleEl = document.getElementById('run-plan-title');
  const subtitleEl = document.getElementById('run-plan-subtitle');
  const modelChipEl = document.getElementById('run-plan-model-chip');
  const dangerAck = document.getElementById('run-plan-danger-ack');

  if (titleEl) titleEl.textContent = area + ' Run Configuration';
  if (subtitleEl) {
    subtitleEl.textContent = 'Review what will happen, then choose execution behavior and Codex access mode before starting.';
  }
  if (modelChipEl) modelChipEl.textContent = 'Model: ' + CODEX_MODEL_LABEL;
  if (modeEl) modeEl.value = (cfg.mode || 'dry-run');
  if (profileEl) profileEl.value = defaultProfile;
  if (dangerAck) dangerAck.checked = false;
  updateRunPlanModalPreview();

  _openOverlay('run-plan-overlay', '#run-plan-mode');
  return new Promise(resolve => {
    _runPlanResolver = resolve;
  });
}

function closeRunPlanModal(payload = { action: 'cancel' }) {
  _closeOverlay('run-plan-overlay');
  if (_runPlanResolver) {
    const resolve = _runPlanResolver;
    _runPlanResolver = null;
    resolve(payload);
  }
}

function confirmRunPlanModal() {
  const modeEl = document.getElementById('run-plan-mode');
  const profileEl = document.getElementById('run-plan-profile');
  const dangerAck = document.getElementById('run-plan-danger-ack');
  const mode = modeEl ? modeEl.value : 'dry-run';
  const profile = profileEl ? profileEl.value : 'safe';

  if (profile === 'full_access' && !(dangerAck && dangerAck.checked)) {
    toast('Please acknowledge the trusted full-access warning before starting.', 'error');
    return;
  }

  closeRunPlanModal({
    action: 'confirm',
    target: _runPlanTarget,
    mode,
    profile,
    danger_ack: !!(dangerAck && dangerAck.checked),
  });
}

function applyRunPlanChoice(choice) {
  if (!choice || choice.action !== 'confirm') return false;
  const target = choice.target === 'pipeline' ? 'pipeline' : 'chain';
  const runMode = choice.mode === 'apply' ? 'apply' : 'dry-run';
  const profile = ['safe', 'readonly', 'full_access'].includes(choice.profile) ? choice.profile : 'safe';

  if (target === 'pipeline') setPipeMode(runMode);
  else setMode(runMode);
  setPermissionProfile(target, profile);

  const cfg = target === 'pipeline' ? pipeConfig : config;
  cfg.mode = runMode;
  cfg.codex_danger_confirmation = (
    profile === 'full_access' && choice.danger_ack
      ? DANGER_CONFIRMATION_PHRASE
      : ''
  );
  return true;
}

let _readOnlyWarningResolver = null;

function openReadOnlyWarningModal(target, runMode) {
  const overlay = document.getElementById('readonly-warning-overlay');
  if (!overlay) return Promise.resolve('continue_readonly');

  const area = target === 'pipeline' ? 'Pipeline' : 'Chain';
  const modeLabel = runMode === 'apply' ? 'Apply mode' : 'Dry Run mode';

  document.getElementById('readonly-warning-title').textContent = 'Read-Only Sandbox Active';
  document.getElementById('readonly-warning-message').textContent =
    area + ' run requested in ' + modeLabel + ' with Codex sandbox set to read-only. Codex can inspect files but cannot write changes.';
  document.getElementById('readonly-warning-guidance').textContent = runMode === 'apply'
    ? 'Apply mode is selected, but write operations will be blocked until you switch to a write-enabled permission profile.'
    : 'This mode is fine for analysis-only runs. Switch to a write-enabled profile if you want Codex to edit files.';

  _openOverlay('readonly-warning-overlay', '#readonly-warning-cancel');

  return new Promise(resolve => {
    _readOnlyWarningResolver = resolve;
  });
}

function closeReadOnlyWarningModal(action = 'cancel') {
  _closeOverlay('readonly-warning-overlay');
  if (_readOnlyWarningResolver) {
    const resolve = _readOnlyWarningResolver;
    _readOnlyWarningResolver = null;
    resolve(action);
  }
}

async function guardReadOnlySandboxBeforeRun(target, usesCodex, runMode) {
  const cfg = target === 'pipeline' ? pipeConfig : config;
  if (!usesCodex || cfg.codex_sandbox_mode !== 'read-only') return true;

  const choice = await openReadOnlyWarningModal(target, runMode);
  if (choice === 'cancel') return false;

  if (choice === 'switch_trusted') {
    setPermissionProfile(target, 'full_access');
    toast('Switched to Trusted Repo Full Access. Write access is now enabled for this run.', 'info');
    return true;
  }

  if (choice === 'switch_safe') {
    setPermissionProfile(target, 'safe');
    toast('Switched to Recommended: Safe Repo Access (sandboxed write access).', 'info');
    return true;
  }

  toast('Continuing in read-only inspect mode. Codex cannot write files in this run.', runMode === 'apply' ? 'error' : 'info');
  return true;
}

function applyCodexPermissionPreset(target, preset) {
  if (preset === 'safe') return setPermissionProfile(target, 'safe');
  if (preset === 'isolated_full') return setPermissionProfile(target, 'full_access');
  return setPermissionProfile(target, 'custom');
}

function requestDangerConfirmationIfNeeded(cfg) {
  if (!cfg.codex_bypass_approvals_and_sandbox) {
    cfg.codex_danger_confirmation = '';
    return true;
  }
  if ((cfg.codex_danger_confirmation || '').trim() === DANGER_CONFIRMATION_PHRASE) {
    return true;
  }
  const ack = prompt(
    'Trusted Repo Full Access is enabled for this run.\n\n'
    + 'This disables sandbox and approval checks.\n'
    + 'Use only in repositories you fully trust.\n\n'
    + 'Type "' + DANGER_CONFIRMATION_PHRASE + '" to continue.'
  );
  if ((ack || '').trim() !== DANGER_CONFIRMATION_PHRASE) {
    toast('Dangerous mode cancelled: confirmation text did not match', 'error');
    cfg.codex_danger_confirmation = '';
    return false;
  }
  cfg.codex_danger_confirmation = DANGER_CONFIRMATION_PHRASE;
  return true;
}

function stepOutputFilename(step) {
  const raw = (step.name || step.job_type || 'step').trim();
  const slug = raw.replace(/[^\w\-]+/g, '-').replace(/^-+|-+$/g, '');
  return (slug || 'step') + '.md';
}

function getStepOutputCollisionDetails(steps) {
  const byFile = {};
  (steps || []).filter(s => s && s.enabled !== false).forEach(step => {
    const file = stepOutputFilename(step);
    if (!byFile[file]) byFile[file] = [];
    byFile[file].push({
      id: step.id,
      name: (step.name || step.job_type || 'step'),
    });
  });
  return Object.entries(byFile)
    .filter(([, entries]) => entries.length > 1)
    .map(([file, entries]) => ({ file, steps: entries }));
}

function findStepOutputCollisions(steps) {
  return getStepOutputCollisionDetails(steps)
    .map(c => [c.file, c.steps.map(s => s.name)]);
}

function duplicateStepIdSet(collisionDetails) {
  const ids = new Set();
  (collisionDetails || []).forEach(c => {
    (c.steps || []).forEach(s => ids.add(s.id));
  });
  return ids;
}

function renderStepCollisionAlert(collisionDetails) {
  const alert = document.getElementById('step-collision-alert');
  if (!alert) return;
  if (!collisionDetails || !collisionDetails.length) {
    alert.style.display = 'none';
    alert.innerHTML = '';
    return;
  }
  const rows = collisionDetails.map(c => {
    const names = (c.steps || []).map(s => esc(s.name || 'step')).join(', ');
    return '<div><code>' + esc(c.file) + '</code> &larr; ' + names + '</div>';
  }).join('');
  alert.innerHTML =
    '<div><strong>&#10060; Duplicate step names detected</strong></div>'
    + '<div style="margin-top:4px">These enabled steps map to the same output file:</div>'
    + '<div style="margin-top:6px;display:flex;flex-direction:column;gap:4px">' + rows + '</div>'
    + '<div style="margin-top:8px"><strong>How to fix:</strong> rename each marked step so every step name is unique.</div>';
  alert.style.display = 'block';
}

function applyMode(mode) {
  currentMode = mode;
  if (typeof localStorage !== 'undefined') localStorage.setItem('cm_mode', mode);
  document.body.classList.remove('mode-easy', 'mode-medium', 'mode-expert');
  document.body.classList.add('mode-' + mode);
  document.querySelectorAll('#difficulty-mode-toggle button').forEach(b => {
    b.classList.toggle('active', b.dataset.mode === mode);
  });
  if (mode === 'easy') {
    config.mode = 'dry-run';
    config.unlimited = true;
    config.stop_on_convergence = true;
    config.brain_enabled = true;
    config.parallel_execution = false;
    if (document.getElementById('mode-toggle')) {
      document.querySelectorAll('#mode-toggle button').forEach(b => { b.classList.toggle('active', b.dataset.mode === 'dry-run'); });
    }
    document.getElementById('unlimited').checked = true;
    toggleUnlimited();
    document.getElementById('brain-enabled').checked = true;
    toggleBrain();
    document.getElementById('parallel-exec').checked = false;
  }
  if (mode === 'easy' && (!config.steps || !config.steps.length)) {
    applyDefaultEasyRecipe();
    return;
  }
  renderSteps();
  renderStepDetails();
}

function selectRecipe(recipeId) {
  const recipe = RECIPES[recipeId];
  if (!recipe) return;
  document.querySelectorAll('.recipe-card').forEach(c => {
    const selected = c.dataset.recipe === recipeId;
    c.classList.toggle('selected', selected);
    c.setAttribute('aria-pressed', selected ? 'true' : 'false');
  });
  const steps = [];
  recipe.forEach((r, i) => {
    const p = presets.find(x => x.key === r.job_type);
    const promptMode = r.prompt_mode || (r.custom_prompt ? 'custom' : 'preset');
    steps.push({
      id: Math.random().toString(36).substring(2, 10),
      name: r.name || (p ? p.name : r.job_type),
      job_type: r.job_type,
      prompt_mode: promptMode,
      custom_prompt: promptMode === 'custom' ? (r.custom_prompt || '') : '',
      on_failure: r.on_failure || 'skip',
      max_retries: Number.isFinite(r.max_retries) ? r.max_retries : 1,
      loop_count: r.loop_count || 1,
      enabled: r.enabled !== false,
      agent: r.agent || 'auto',
    });
  });
  config.steps = steps;
  selectedStepId = steps.length ? steps[0].id : null;
  config.unlimited = true;
  config.stop_on_convergence = true;
  config.brain_enabled = true;
  config.parallel_execution = false;
  config.mode = 'dry-run';
  document.getElementById('unlimited').checked = true;
  toggleUnlimited();
  document.getElementById('brain-enabled').checked = true;
  toggleBrain();
  document.getElementById('parallel-exec').checked = false;
  if (document.getElementById('mode-toggle')) {
    document.querySelectorAll('#mode-toggle button').forEach(b => { b.classList.toggle('active', b.dataset.mode === 'dry-run'); });
  }
  renderSteps();
  renderStepDetails();
}

function applyDefaultEasyRecipe() {
  if (!RECIPES[DEFAULT_EASY_RECIPE_ID]) return;
  selectRecipe(DEFAULT_EASY_RECIPE_ID);
}

function initRecipeCardKeyboardAccess() {
  document.querySelectorAll('.recipe-card').forEach(card => {
    card.setAttribute('role', 'button');
    card.setAttribute('tabindex', '0');
    if (!card.hasAttribute('aria-pressed')) card.setAttribute('aria-pressed', 'false');
    if (card.dataset.keyboardBound === '1') return;
    card.dataset.keyboardBound = '1';
    card.addEventListener('keydown', (event) => {
      if (event.key !== 'Enter' && event.key !== ' ') return;
      event.preventDefault();
      const recipeId = card.dataset.recipe || '';
      if (recipeId) selectRecipe(recipeId);
    });
  });
}

function initMainTabKeyboardNav() {
  const tabList = document.getElementById('main-tabs');
  if (!tabList || tabList.dataset.keyboardBound === '1') return;
  tabList.dataset.keyboardBound = '1';
  tabList.addEventListener('keydown', (event) => {
    const keys = ['ArrowLeft', 'ArrowRight', 'Home', 'End'];
    if (!keys.includes(event.key)) return;
    const tabs = Array.from(tabList.querySelectorAll('button[data-tab]'));
    if (!tabs.length) return;

    const focusedIdx = tabs.indexOf(document.activeElement);
    const currentIdx = focusedIdx >= 0
      ? focusedIdx
      : Math.max(0, tabs.findIndex(btn => btn.getAttribute('aria-selected') === 'true'));
    let nextIdx = currentIdx;
    if (event.key === 'ArrowLeft') nextIdx = (currentIdx - 1 + tabs.length) % tabs.length;
    if (event.key === 'ArrowRight') nextIdx = (currentIdx + 1) % tabs.length;
    if (event.key === 'Home') nextIdx = 0;
    if (event.key === 'End') nextIdx = tabs.length - 1;

    const target = tabs[nextIdx];
    if (!target) return;
    event.preventDefault();
    target.focus();
    switchTab(target.dataset.tab);
  });
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Init Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
document.addEventListener('DOMContentLoaded', async () => {
  applyProgramNameLabels();
  try {
    presets = await api('/api/presets');
  } catch(e) { console.warn('Could not load presets', e); }
  resetPermissionProfileUiState('chain');
  resetPermissionProfileUiState('pipeline');
  normalizeCodexPermissions(config);
  normalizeCodexPermissions(pipeConfig);
  normalizeCapabilitySettings(config);
  normalizeCapabilitySettings(pipeConfig);
  syncChainPermissionControlsFromConfig();
  syncPipelinePermissionControlsFromConfig();
  syncChainCapabilityControlsFromConfig();
  syncPipelineCapabilityControlsFromConfig();
  syncChainTimeoutControlsFromConfig();
  syncPipeTimeoutControlsFromConfig();
  initMainTabKeyboardNav();
  initRecipeCardKeyboardAccess();
  renderActivityHeartbeats();
  if (activityHeartbeatTimer) clearInterval(activityHeartbeatTimer);
  activityHeartbeatTimer = setInterval(renderActivityHeartbeats, 1000);
  startBackendHealthPolling();
  startWatchdogAlertPolling();
  switchTab('chain');
  applyMode(currentMode);
  loadConfigList();
  renderSteps();
  // Fetch Ollama models in background - populates both brain dropdowns
  fetchOllamaModels();
  refreshChainOutputs(false);
  loadGovernancePolicy({ silent: true });
  loadOwnerDecisionBoard();
  ['codex-bin', 'claude-bin'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', () => scheduleDiagnosticsRefresh('chain'));
    el.addEventListener('change', () => scheduleDiagnosticsRefresh('chain'));
  });
  ['pipe-codex-bin', 'pipe-claude-bin'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', () => scheduleDiagnosticsRefresh('pipeline'));
    el.addEventListener('change', () => scheduleDiagnosticsRefresh('pipeline'));
  });
  const pipeAgent = document.getElementById('pipe-agent');
  if (pipeAgent) {
    pipeAgent.addEventListener('change', () => {
      pipeConfig.agent = pipeAgent.value;
      scheduleDiagnosticsRefresh('pipeline');
    });
  }
  refreshDiagnostics('chain', { silent: true });
  refreshDiagnostics('pipeline', { silent: true });
  if (typeof localStorage !== 'undefined' && !localStorage.getItem('cm_onboarded')) {
    _openOverlay('onboarding-overlay', '.onboarding-card .btn-primary');
  }
  _syncModalOpenState();
  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Escape') return;
    closeRunPlanModal({ action: 'cancel' });
    closeScienceDashboardModal();
    closePermissionsHelpModal();
    closeReadOnlyWarningModal('cancel');
    closeDocsModal();
    hideTodoWishlistModal();
    hideNewProjectModal();
    browseClose();
  });
});

function dismissOnboarding() {
  _closeOverlay('onboarding-overlay');
  if (typeof localStorage !== 'undefined') localStorage.setItem('cm_onboarded', '1');
  applyMode('easy');
}

/* -- To-Do / Wishlist workspace -- */
let lastTodoWishlistSuggestion = '';

function _activeRepoPath() {
  const chainRepo = String(document.getElementById('repo-path').value || '').trim();
  if (chainRepo) return chainRepo;
  const pipeRepo = String(document.getElementById('pipe-repo-path').value || '').trim();
  return pipeRepo;
}

function syncTodoWishlistRepoFromMain() {
  const repo = _activeRepoPath();
  const input = document.getElementById('todo-wishlist-repo');
  if (input) input.value = repo;
  return repo;
}

function _setTodoWishlistStatus(text, tone = 'muted') {
  const el = document.getElementById('todo-wishlist-suggest-status');
  if (!el) return;
  el.textContent = String(text || '');
  if (tone === 'ok') {
    el.style.color = 'var(--success)';
  } else if (tone === 'warn') {
    el.style.color = 'var(--warning)';
  } else if (tone === 'error') {
    el.style.color = 'var(--danger)';
  } else {
    el.style.color = 'var(--text2)';
  }
}

async function showTodoWishlistModal() {
  syncTodoWishlistRepoFromMain();
  const area = document.getElementById('todo-wishlist-content');
  if (area) area.value = '';
  lastTodoWishlistSuggestion = '';
  _setTodoWishlistStatus('');
  _openOverlay('todo-wishlist-overlay', '#todo-wishlist-repo');
  await loadTodoWishlist();
}

function hideTodoWishlistModal() {
  _closeOverlay('todo-wishlist-overlay');
}

async function loadTodoWishlist() {
  const repo = String(document.getElementById('todo-wishlist-repo').value || '').trim();
  if (!repo) {
    _setTodoWishlistStatus('Set a repository path first.', 'warn');
    return;
  }
  _setTodoWishlistStatus('Loading to-do/wishlist...', 'muted');
  try {
    const resp = await api('/api/owner/todo-wishlist?repo_path=' + encodeURIComponent(repo));
    if (resp.error) {
      _setTodoWishlistStatus(resp.error, 'error');
      return;
    }
    const area = document.getElementById('todo-wishlist-content');
    if (area) area.value = String(resp.content || '').trim();
    _setTodoWishlistStatus(resp.exists ? 'Loaded existing to-do/wishlist file.' : 'Loaded starter template.', 'ok');
  } catch (e) {
    _setTodoWishlistStatus('Could not load to-do/wishlist.', 'error');
  }
}

async function saveTodoWishlist() {
  const repo = String(document.getElementById('todo-wishlist-repo').value || '').trim();
  const content = String(document.getElementById('todo-wishlist-content').value || '').trim();
  if (!repo) {
    _setTodoWishlistStatus('Set a repository path first.', 'warn');
    return false;
  }
  try {
    const resp = await postJson('/api/owner/todo-wishlist/save', {
      repo_path: repo,
      content: content,
    });
    if (resp.error) {
      _setTodoWishlistStatus(resp.error, 'error');
      return false;
    }
    _setTodoWishlistStatus('Saved to-do/wishlist.', 'ok');
    toast('To-do/wishlist saved.', 'success');
    return true;
  } catch (e) {
    _setTodoWishlistStatus('Could not save to-do/wishlist.', 'error');
    return false;
  }
}

async function suggestTodoWishlist() {
  const repo = String(document.getElementById('todo-wishlist-repo').value || '').trim();
  if (!repo) {
    _setTodoWishlistStatus('Set a repository path first.', 'warn');
    return;
  }
  const existing = String(document.getElementById('todo-wishlist-content').value || '').trim();
  const ownerContext = String(document.getElementById('todo-wishlist-context').value || '').trim();
  const model = String(document.getElementById('todo-wishlist-model').value || 'gpt-5.2').trim() || 'gpt-5.2';
  _setTodoWishlistStatus('Generating suggestions...', 'muted');
  try {
    const resp = await postJson('/api/owner/todo-wishlist/suggest', {
      repo_path: repo,
      existing_markdown: existing,
      owner_context: ownerContext,
      model: model,
    });
    if (resp.error) {
      _setTodoWishlistStatus(resp.error, 'error');
      return;
    }
    lastTodoWishlistSuggestion = String(resp.content || '').trim();
    if (!lastTodoWishlistSuggestion) {
      _setTodoWishlistStatus('AI returned an empty suggestion.', 'warn');
      return;
    }
    document.getElementById('todo-wishlist-content').value = lastTodoWishlistSuggestion;
    const warning = String(resp.warning || '').trim();
    if (warning) {
      _setTodoWishlistStatus(warning, 'warn');
      toast(warning, 'info');
    } else {
      _setTodoWishlistStatus('AI suggestion applied to the editor.', 'ok');
    }
  } catch (e) {
    _setTodoWishlistStatus('AI suggestion failed.', 'error');
  }
}

function appendTodoWishlistSuggestion() {
  const area = document.getElementById('todo-wishlist-content');
  const suggestion = String(lastTodoWishlistSuggestion || '').trim();
  if (!area || !suggestion) {
    _setTodoWishlistStatus('No suggestion to append yet. Click "Suggest with AI" first.', 'warn');
    return;
  }
  const existing = String(area.value || '').trim();
  area.value = existing ? (existing + '\n\n' + suggestion) : suggestion;
  _setTodoWishlistStatus('Appended latest suggestion to the editor.', 'ok');
}

async function saveAndStartTodoWishlistAutopilot() {
  const ok = await saveTodoWishlist();
  if (!ok) return;
  hideTodoWishlistModal();
  await startTodoWishlistAutopilot();
}

async function startTodoWishlistAutopilot() {
  const repoFromModal = String(document.getElementById('todo-wishlist-repo') ? document.getElementById('todo-wishlist-repo').value : '').trim();
  const repo = repoFromModal || _activeRepoPath();
  if (!repo) {
    toast('Set a repository path first.', 'error');
    return;
  }
  document.getElementById('repo-path').value = repo;
  config.repo_path = repo;
  validateRepo();
  applyMode('easy');
  selectRecipe('todo_wishlist_autopilot');
  switchTab('chain');
  await startChain();
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ New Project Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
function showNewProjectModal() {
  document.getElementById('np-result').style.display = 'none';
  document.getElementById('np-create-btn').disabled = false;
  toggleFoundationOptions();
  toggleLicensingOptions();
  _openOverlay('new-project-overlay', '#np-parent');
}

function hideNewProjectModal() {
  _closeOverlay('new-project-overlay');
}

function toggleFoundationOptions() {
  const enabled = document.getElementById('np-foundation-enabled').checked;
  const panel = document.getElementById('np-foundation-options');
  panel.classList.toggle('hidden', !enabled);
}

function toggleLicensingOptions() {
  const enabled = document.getElementById('np-licensing-enabled').checked;
  const panel = document.getElementById('np-licensing-options');
  panel.classList.toggle('hidden', !enabled);
  toggleLicensingLegalSignoff();
}

function toggleLicensingLegalSignoff() {
  const requiredEl = document.getElementById('np-licensing-legal-review-required');
  const signoffEl = document.getElementById('np-licensing-legal-signoff');
  const reviewerEl = document.getElementById('np-licensing-legal-reviewer');
  const notesEl = document.getElementById('np-licensing-legal-notes');
  if (!requiredEl || !signoffEl || !reviewerEl || !notesEl) return;
  const required = !!requiredEl.checked;
  signoffEl.disabled = !required;
  reviewerEl.disabled = !required;
  notesEl.disabled = !required;
  if (!required) signoffEl.checked = false;
}

function _selectedFoundationAssistants() {
  return Array.from(document.querySelectorAll('.np-foundation-assistant:checked'))
    .map(el => String(el.value || '').trim().toLowerCase())
    .filter(Boolean);
}

function _setFoundationStatus(text, tone = 'muted') {
  const el = document.getElementById('np-foundation-status');
  if (!el) return;
  el.textContent = text;
  if (tone === 'ok') {
    el.style.color = 'var(--success)';
  } else if (tone === 'warn') {
    el.style.color = 'var(--warning)';
  } else if (tone === 'error') {
    el.style.color = 'var(--danger)';
  } else {
    el.style.color = 'var(--text2)';
  }
}

async function improveFoundationalPrompt() {
  const projectName = document.getElementById('np-name').value.trim() || 'Project';
  const promptEl = document.getElementById('np-foundation-prompt');
  const prompt = promptEl.value.trim();
  const assistants = _selectedFoundationAssistants();
  if (!prompt) {
    toast('Enter a foundational prompt first', 'error');
    return;
  }

  _setFoundationStatus('Improving prompt...', 'muted');
  try {
    const resp = await postJson('/api/project/foundation/improve', {
      prompt,
      project_name: projectName,
      assistants,
    });
    if (resp.error) {
      _setFoundationStatus(resp.error, 'error');
      toast(resp.error, 'error');
      return;
    }
    const improved = String(resp.recommended_prompt || '').trim();
    if (!improved) {
      _setFoundationStatus('No improved prompt returned.', 'warn');
      return;
    }
    promptEl.value = improved;
    if (resp.warning) {
      _setFoundationStatus(String(resp.warning), 'warn');
      toast(String(resp.warning), 'info');
    } else {
      _setFoundationStatus('Prompt improved and applied.', 'ok');
      toast('Foundational prompt improved', 'success');
    }
  } catch (e) {
    const message = 'Prompt improvement failed: ' + (e && e.message ? e.message : String(e));
    _setFoundationStatus(message, 'error');
    toast(message, 'error');
  }
}

async function createProject() {
  const parentDir = document.getElementById('np-parent').value.trim();
  const projectName = document.getElementById('np-name').value.trim();
  const description = document.getElementById('np-desc').value.trim();
  const gitName = document.getElementById('np-git-name').value.trim();
  const gitEmail = document.getElementById('np-git-email').value.trim();
  const addReadme = document.getElementById('np-readme').checked;
  const addGitignore = document.getElementById('np-gitignore').checked;
  const branch = document.getElementById('np-branch').value.trim() || 'main';
  const remoteUrl = document.getElementById('np-remote').value.trim();
  const foundationEnabled = document.getElementById('np-foundation-enabled').checked;
  const foundationalPrompt = document.getElementById('np-foundation-prompt').value.trim();
  const foundationAssistants = _selectedFoundationAssistants();
  const foundationGenerateDocs = document.getElementById('np-foundation-generate-docs').checked;
  const foundationBootstrapOnce = document.getElementById('np-foundation-bootstrap-once').checked;
  const foundationBootstrapAutorun = document.getElementById('np-foundation-bootstrap-autorun').checked;
  const licensingEnabled = document.getElementById('np-licensing-enabled').checked;
  const licensingStrategy = document.getElementById('np-licensing-strategy').value;
  const licensingCommercialTiers = document.getElementById('np-licensing-commercial').checked;
  const licensingOwnerContactEmail = document.getElementById('np-licensing-email').value.trim();
  const licensingLegalReviewRequired = document.getElementById('np-licensing-legal-review-required').checked;
  const licensingLegalSignoffApproved = document.getElementById('np-licensing-legal-signoff').checked;
  const licensingLegalReviewer = document.getElementById('np-licensing-legal-reviewer').value.trim();
  const licensingLegalNotes = document.getElementById('np-licensing-legal-notes').value.trim();

  if (!parentDir) { toast('Enter a parent directory', 'error'); return; }
  if (!projectName) { toast('Enter a project name', 'error'); return; }
  if (!gitName) { toast('Enter a git author name', 'error'); return; }
  if (!gitEmail) { toast('Enter a git author email', 'error'); return; }
  if (foundationEnabled && !foundationalPrompt) {
    toast('Foundational prompt is required when foundational setup is enabled', 'error');
    return;
  }

  document.getElementById('np-create-btn').disabled = true;
  const resultEl = document.getElementById('np-result');
  resultEl.style.display = 'none';

  try {
    const resp = await postJson('/api/project/create', {
      parent_dir: parentDir,
      project_name: projectName,
      description: description,
      git_name: gitName,
      git_email: gitEmail,
      add_readme: addReadme,
      add_gitignore: addGitignore,
      initial_branch: branch,
      remote_url: remoteUrl,
      foundation_enabled: foundationEnabled,
      foundational_prompt: foundationalPrompt,
      foundation_assistants: foundationAssistants,
      foundation_generate_docs: foundationGenerateDocs,
      foundation_bootstrap_once: foundationBootstrapOnce,
      foundation_bootstrap_autorun: foundationBootstrapAutorun,
      licensing_enabled: licensingEnabled,
      licensing_strategy: licensingStrategy,
      licensing_include_commercial_tiers: licensingCommercialTiers,
      licensing_owner_contact_email: licensingOwnerContactEmail,
      licensing_legal_review_required: licensingLegalReviewRequired,
      licensing_legal_signoff_approved: licensingLegalSignoffApproved,
      licensing_legal_reviewer: licensingLegalReviewer,
      licensing_legal_notes: licensingLegalNotes,
    });

    if (resp.error) {
      toast(resp.error, 'error');
      document.getElementById('np-create-btn').disabled = false;
      return;
    }

    // Populate the repo path in the main UI
    document.getElementById('repo-path').value = resp.path;
    config.repo_path = resp.path;
    validateRepo();

    // Close modal immediately and show toast
    hideNewProjectModal();
    if (resp.foundation_enabled && Array.isArray(resp.foundation_files) && resp.foundation_files.length) {
      const bootstrap = resp.foundation_bootstrap_status || {};
      const bootstrapStatus = String(bootstrap.status || '').trim().toLowerCase();
      if (bootstrapStatus === 'running') {
        toast('Project created with foundation artifacts and bootstrap chain started.', 'success');
      } else if (bootstrapStatus === 'queued') {
        toast('Project created. Bootstrap request queued because executor is busy.', 'info');
      } else if (bootstrapStatus === 'pending') {
        toast('Project created with foundation artifacts. Bootstrap request is pending manual run.', 'success');
      } else {
        toast('Project created with foundational artifacts at: ' + resp.path, 'success');
      }
    } else {
      toast('Project created at: ' + resp.path, 'success');
    }
    if (resp.licensing_enabled && Array.isArray(resp.licensing_files) && resp.licensing_files.length) {
      toast('Licensing/commercial docs generated for strategy: ' + String(resp.licensing_strategy || 'oss_only'), 'info');
      const legalStatus = String(resp.licensing_legal_review_status || '').trim().toLowerCase();
      if (legalStatus === 'pending') {
        toast('Legal review checkpoint is pending before publishing licensing/pricing docs.', 'warn');
      } else if (legalStatus === 'approved') {
        toast('Legal review checkpoint recorded as approved.', 'success');
      } else if (legalStatus === 'not_required') {
        toast('Legal review checkpoint was marked optional for this project.', 'info');
      }
    }
    loadOwnerDecisionBoard();

  } catch (e) {
    toast('Failed to create project: ' + e.message, 'error');
    document.getElementById('np-create-btn').disabled = false;
  }
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ API helper Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
function setBackendOnlineState(isOnline, detail = '') {
  const wasOnline = backendOnline;
  backendOnline = !!isOnline;
  if (backendOnline) {
    backendLastError = '';
  } else if (detail) {
    backendLastError = detail;
  }

  const banner = document.getElementById('backend-status-banner');
  if (banner) {
    if (backendOnline) {
      banner.style.display = 'none';
      banner.textContent = 'Backend connection healthy.';
    } else {
      banner.style.display = '';
      if (pendingServerRestart) {
        banner.textContent = 'Server restarting to apply updates. Waiting to reconnect...';
      } else if (backendLastError) {
        banner.textContent = 'Backend unavailable: ' + backendLastError;
      } else {
        banner.textContent = 'Backend connection lost. Waiting to reconnect.';
      }
    }
  }
  if (!backendOnline) {
    const watchdogBanner = document.getElementById('watchdog-alert-banner');
    if (watchdogBanner) watchdogBanner.style.display = 'none';
  } else if (!wasOnline) {
    pollWatchdogAlerts({ silent: true });
  }

  if (backendOnline && pendingServerRestart) {
    pendingServerRestart = null;
    selfRestartNoticeCheckpoint = '';
    toast('Server restart complete. Reloading UI...', 'info');
    window.location.reload();
  }
}

async function pollBackendHealth() {
  try {
    const resp = await fetch('/api/health', { cache: 'no-store' });
    if (!resp.ok) {
      throw new Error('Health check failed (' + resp.status + ' ' + resp.statusText + ')');
    }
    await resp.json();
    setBackendOnlineState(true);
  } catch (err) {
    const message = (err && err.message) ? err.message : 'network error';
    setBackendOnlineState(false, message);
  }
}

function startBackendHealthPolling() {
  if (backendHealthTimer) clearInterval(backendHealthTimer);
  backendHealthTimer = setInterval(pollBackendHealth, 2500);
  pollBackendHealth();
}

function _watchdogDigest(alerts) {
  if (!Array.isArray(alerts) || !alerts.length) return '';
  return alerts
    .map(a => [a.severity, a.title, a.detail, a.action].map(v => String(v || '')).join('|'))
    .join('||');
}

function _watchdogMigrationsFromAlerts(alerts) {
  const rows = [];
  if (!Array.isArray(alerts)) return rows;
  alerts.forEach(alert => {
    const direct = Array.isArray(alert && alert.migrations) ? alert.migrations : [];
    const nested = (
      alert
      && alert.playbook
      && Array.isArray(alert.playbook.migrations)
    ) ? alert.playbook.migrations : [];
    direct.concat(nested).forEach(row => {
      if (!row || typeof row !== 'object') return;
      const provider = String(row.provider || '').trim().toLowerCase();
      const fromModel = String(row.from_model || row.from || '').trim();
      const toModel = String(row.to_model || row.to || '').trim();
      if (!provider || !fromModel || !toModel || fromModel === toModel) return;
      const key = provider + '|' + fromModel + '|' + toModel;
      if (!rows.some(item => (item.key === key))) {
        rows.push({ key, provider, from_model: fromModel, to_model: toModel });
      }
    });
  });
  return rows;
}

function renderWatchdogAlerts(payload, opts = {}) {
  const banner = document.getElementById('watchdog-alert-banner');
  const content = document.getElementById('watchdog-alert-content');
  const applyBtn = document.getElementById('watchdog-apply-migrations-btn');
  if (!banner || !content) return;

  const hasAlerts = !!(payload && payload.has_alerts);
  const alerts = Array.isArray(payload && payload.alerts) ? payload.alerts : [];
  const muted = Date.now() < watchdogAlertsMutedUntil;
  if (!backendOnline || muted || !hasAlerts || !alerts.length) {
    banner.style.display = 'none';
    content.textContent = '';
    watchdogMigrationSuggestions = [];
    if (applyBtn) applyBtn.style.display = 'none';
    if (!hasAlerts && !muted) {
      watchdogAlertDigest = '';
    }
    return;
  }

  const warnCount = alerts.filter(a => String(a && a.severity || '').toLowerCase() === 'warn').length;
  banner.classList.toggle('error', warnCount > 0);
  banner.classList.toggle('warning', warnCount === 0);

  const lines = alerts.slice(0, 6).map((alert, idx) => {
    const sev = String(alert && alert.severity || 'info').toUpperCase();
    const title = esc(alert && alert.title || ('Alert ' + (idx + 1)));
    const detail = esc(alert && alert.detail || '');
    const action = esc(alert && alert.action || '');
    return '[' + sev + '] ' + title
      + (detail ? ('\n  ' + detail) : '')
      + (action ? ('\n  Action: ' + action) : '');
  });
  if (alerts.length > 6) {
    lines.push('... and ' + (alerts.length - 6) + ' more alert(s).');
  }
  watchdogMigrationSuggestions = _watchdogMigrationsFromAlerts(alerts);
  if (watchdogMigrationSuggestions.length) {
    lines.push(
      'Migration suggestions available: '
      + watchdogMigrationSuggestions.length
      + ' (use "Apply migration suggestions").'
    );
  }
  if (applyBtn) {
    applyBtn.style.display = watchdogMigrationSuggestions.length ? '' : 'none';
  }
  const generatedAt = String(payload && payload.last_generated_at || '').trim();
  if (generatedAt) {
    lines.push('Snapshot: ' + generatedAt);
  }
  content.textContent = lines.join('\n');
  banner.style.display = '';

  const digest = _watchdogDigest(alerts);
  if (opts.announce && digest && digest !== watchdogAlertDigest) {
    const level = warnCount > 0 ? 'error' : 'info';
    toast('Model watchdog reported ' + alerts.length + ' alert(s).', level);
  }
  watchdogAlertDigest = digest;
}

function applyWatchdogMigrationsFromBanner() {
  const suggestions = Array.isArray(watchdogMigrationSuggestions)
    ? watchdogMigrationSuggestions
    : [];
  if (!suggestions.length) {
    toast('No migration suggestions are available right now.', 'info');
    return;
  }

  let applied = 0;
  let skipped = 0;
  suggestions.forEach(row => {
    const provider = String(row.provider || '').trim().toLowerCase();
    const fromModel = String(row.from_model || '').trim();
    const toModel = String(row.to_model || '').trim();
    if (!provider || !fromModel || !toModel || fromModel === toModel) {
      skipped += 1;
      return;
    }
    let changed = false;

    if (provider === 'openai') {
      if (String(pipeConfig.deep_research_openai_model || '').trim() === fromModel) {
        pipeConfig.deep_research_openai_model = toModel;
        changed = true;
      }
    } else if (provider === 'google') {
      if (String(pipeConfig.deep_research_google_model || '').trim() === fromModel) {
        pipeConfig.deep_research_google_model = toModel;
        changed = true;
      }
    }

    if (String(config.brain_model || '').trim() === fromModel) {
      config.brain_model = toModel;
      changed = true;
    }
    if (String(pipeConfig.brain_model || '').trim() === fromModel) {
      pipeConfig.brain_model = toModel;
      changed = true;
    }

    if (changed) applied += 1;
    else skipped += 1;
  });

  normalizeCapabilitySettings(pipeConfig);
  syncPipelineCapabilityControlsFromConfig();
  const chainBrainEl = document.getElementById('brain-model');
  if (chainBrainEl && String(config.brain_model || '').trim()) {
    chainBrainEl.value = config.brain_model;
  }
  const pipeBrainEl = document.getElementById('pipe-brain-model');
  if (pipeBrainEl && String(pipeConfig.brain_model || '').trim()) {
    pipeBrainEl.value = pipeConfig.brain_model;
  }

  if (applied > 0) {
    toast(
      'Applied ' + applied + ' model migration suggestion(s).'
      + (skipped > 0 ? (' Skipped ' + skipped + ' with no matching current model.') : ''),
      'success'
    );
  } else {
    toast('No current settings matched the suggested migrations.', 'info');
  }
}

async function pollWatchdogAlerts(opts = {}) {
  if (!backendOnline) return;
  try {
    const resp = await fetch('/api/system/model-watchdog/alerts', { cache: 'no-store' });
    if (!resp.ok) {
      throw new Error('Watchdog alerts failed (' + resp.status + ' ' + resp.statusText + ')');
    }
    const payload = await resp.json();
    renderWatchdogAlerts(payload, { announce: !!opts.announce });
  } catch (err) {
    if (!opts.silent) {
      console.warn('Could not load watchdog alerts', err);
    }
  }
}

function startWatchdogAlertPolling() {
  if (watchdogAlertsTimer) clearInterval(watchdogAlertsTimer);
  watchdogAlertsTimer = setInterval(() => {
    pollWatchdogAlerts({ silent: true });
  }, 60000);
  pollWatchdogAlerts({ silent: true });
}

function muteWatchdogAlerts(hours) {
  const parsed = Number(hours);
  const durationHours = Number.isFinite(parsed) && parsed > 0 ? parsed : 1;
  watchdogAlertsMutedUntil = Date.now() + durationHours * 60 * 60 * 1000;
  const banner = document.getElementById('watchdog-alert-banner');
  const applyBtn = document.getElementById('watchdog-apply-migrations-btn');
  if (banner) banner.style.display = 'none';
  if (applyBtn) applyBtn.style.display = 'none';
  toast('Watchdog alerts muted for ' + durationHours + ' hour(s).', 'info');
}

async function runWatchdogNowFromBanner() {
  try {
    const resp = await postJson('/api/system/model-watchdog/run', { force: true });
    if (resp.error) {
      toast(resp.error, 'error');
      return;
    }
    toast('Watchdog run complete. Refreshing alerts...', 'info');
    await pollWatchdogAlerts({ announce: true });
  } catch (err) {
    const message = (err && err.message) ? err.message : String(err);
    toast('Could not run watchdog: ' + message, 'error');
  }
}

async function requestServerRestart(checkpointPath, opts = {}) {
  const path = String(checkpointPath || '').trim();
  if (!path) {
    toast('Cannot restart: missing checkpoint path.', 'error');
    return false;
  }
  if (pendingServerRestart && pendingServerRestart.checkpoint_path === path) {
    return true;
  }

  const resp = await postJson('/api/system/restart', {
    pipeline_resume_checkpoint: path,
  });
  if (resp.error) {
    toast('Server restart failed: ' + resp.error, 'error');
    return false;
  }

  pendingServerRestart = {
    checkpoint_path: path,
    requested_at: Date.now(),
    auto: !!opts.auto,
  };
  setBackendOnlineState(false, 'Restart requested');
  if (!opts.auto) {
    toast('Restart requested. Waiting for backend to come back...', 'info');
  }
  return true;
}

async function api(url, opts) {
  try {
    const r = await fetch(url, opts);
    setBackendOnlineState(true);
    const raw = await r.text();
    let data = {};
    if (raw) {
      try {
        data = JSON.parse(raw);
      } catch (_) {
        data = { error: 'Server returned malformed JSON.' };
      }
    }
    if (!r.ok) {
      if (!data || typeof data !== 'object') data = {};
      if (!data.error) data.error = 'Request failed (' + r.status + ' ' + r.statusText + ')';
    }
    return data;
  } catch (e) {
    const message = (e && e.message) ? e.message : String(e);
    setBackendOnlineState(false, message);
    return { error: 'Network error: ' + (e && e.message ? e.message : String(e)) };
  }
}

async function postJson(url, body) {
  return api(url, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body),
  });
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Mode Toggle Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
function setMode(mode) {
  config.mode = mode;
  document.querySelectorAll('#mode-toggle button').forEach(b => {
    b.classList.toggle('active', b.dataset.mode === mode);
  });
}
function _normalizedTimeoutSeconds(rawValue, fallbackSeconds) {
  const parsed = Number(rawValue);
  if (!Number.isFinite(parsed) || parsed <= 0) return 0;
  const fallback = Number.isFinite(Number(fallbackSeconds)) ? Number(fallbackSeconds) : 600;
  return Math.max(30, Math.round(parsed || fallback));
}

function syncChainTimeoutControlsFromConfig() {
  const enabled = (Number(config.timeout_per_step) || 0) > 0;
  const input = document.getElementById('timeout-step');
  const checkbox = document.getElementById('timeout-step-enabled');
  const note = document.getElementById('timeout-step-note');
  checkbox.checked = enabled;
  if (enabled) {
    input.value = _normalizedTimeoutSeconds(config.timeout_per_step, 600);
  } else if (!_normalizedTimeoutSeconds(input.value, 600)) {
    input.value = 600;
  }
  input.disabled = !enabled;
  input.style.opacity = enabled ? '1' : '0.45';
  note.textContent = enabled
    ? 'Active: run stops only after this many idle seconds.'
    : 'Unlimited (no inactivity timeout).';
  renderActivityHeartbeats();
}

function syncPipeTimeoutControlsFromConfig() {
  const enabled = (Number(pipeConfig.timeout_per_phase) || 0) > 0;
  const input = document.getElementById('pipe-timeout');
  const checkbox = document.getElementById('pipe-timeout-enabled');
  const note = document.getElementById('pipe-timeout-note');
  checkbox.checked = enabled;
  if (enabled) {
    input.value = _normalizedTimeoutSeconds(pipeConfig.timeout_per_phase, 600);
  } else if (!_normalizedTimeoutSeconds(input.value, 600)) {
    input.value = 600;
  }
  input.disabled = !enabled;
  input.style.opacity = enabled ? '1' : '0.45';
  note.textContent = enabled
    ? 'Active: run stops only after this many idle seconds.'
    : 'Unlimited (no inactivity timeout).';
  renderActivityHeartbeats();
}

function onChainTimeoutToggle() {
  const enabled = document.getElementById('timeout-step-enabled').checked;
  const input = document.getElementById('timeout-step');
  if (enabled && _normalizedTimeoutSeconds(input.value, 600) <= 0) input.value = 600;
  config.timeout_per_step = enabled ? _normalizedTimeoutSeconds(input.value, 600) : 0;
  syncChainTimeoutControlsFromConfig();
}

function onPipeTimeoutToggle() {
  const enabled = document.getElementById('pipe-timeout-enabled').checked;
  const input = document.getElementById('pipe-timeout');
  if (enabled && _normalizedTimeoutSeconds(input.value, 600) <= 0) input.value = 600;
  pipeConfig.timeout_per_phase = enabled ? _normalizedTimeoutSeconds(input.value, 600) : 0;
  syncPipeTimeoutControlsFromConfig();
}

function readChainTimeoutFromUi() {
  const enabled = document.getElementById('timeout-step-enabled').checked;
  const input = document.getElementById('timeout-step');
  return enabled ? _normalizedTimeoutSeconds(input.value, 600) : 0;
}

function readPipeTimeoutFromUi() {
  const enabled = document.getElementById('pipe-timeout-enabled').checked;
  const input = document.getElementById('pipe-timeout');
  return enabled ? _normalizedTimeoutSeconds(input.value, 600) : 0;
}

function _formatElapsedSeconds(totalSeconds) {
  const sec = Math.max(0, Math.floor(totalSeconds || 0));
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  if (m <= 0) return s + 's';
  return m + 'm ' + s + 's';
}

const _SPINNER_FRAMES = ['|', '/', '-', '\\'];
function _spinnerFrame() {
  return _SPINNER_FRAMES[Math.floor(Date.now() / 250) % _SPINNER_FRAMES.length];
}

function _renderLastLogHint(elId, state) {
  const el = document.getElementById(elId);
  if (!el) return;
  const msg = (state.last_log_message || '').toString().trim();
  const level = (state.last_log_level || '').toString().toUpperCase();
  if (!msg) {
    el.textContent = 'Last log: none yet';
    return;
  }
  el.textContent = 'Last log' + (level ? ' [' + level + ']' : '') + ': ' + msg;
}

function _activityColor(idleSeconds, timeoutSeconds) {
  if (timeoutSeconds <= 0) return 'var(--text2)';
  if (idleSeconds >= timeoutSeconds * 0.8) return 'var(--danger)';
  if (idleSeconds >= timeoutSeconds * 0.5) return 'var(--warning)';
  return 'var(--success)';
}

function _renderActivityHeartbeat(elId, running, paused, lastActivityMs, timeoutSeconds) {
  const el = document.getElementById(elId);
  if (!el) return;

  if (!lastActivityMs) {
    if (running && !paused) {
      el.textContent = 'Activity: waiting for first output...';
      el.style.color = 'var(--text2)';
    } else if (running && paused) {
      el.textContent = 'Activity: paused (no output yet)';
      el.style.color = 'var(--warning)';
    } else {
      el.textContent = 'Activity: idle';
      el.style.color = 'var(--text2)';
    }
    return;
  }

  const idleSeconds = Math.max(0, Math.floor((Date.now() - lastActivityMs) / 1000));
  const at = new Date(lastActivityMs).toLocaleTimeString();

  if (!running) {
    el.textContent = 'Last output: ' + idleSeconds + 's ago at ' + at;
    el.style.color = 'var(--text2)';
    return;
  }

  if (paused) {
    el.textContent = 'Paused - last output ' + idleSeconds + 's ago at ' + at;
    el.style.color = 'var(--warning)';
    return;
  }

  if (timeoutSeconds > 0) {
    el.textContent =
      'Output activity: ' + idleSeconds + 's idle (timeout ' + timeoutSeconds + 's inactivity, last at ' + at + ')';
  } else {
    el.textContent = 'Output activity: ' + idleSeconds + 's idle (timeout disabled, last at ' + at + ')';
  }
  el.style.color = _activityColor(idleSeconds, timeoutSeconds);
}

function renderActivityHeartbeats() {
  _renderActivityHeartbeat(
    'activity-heartbeat',
    chainRunning,
    chainPaused,
    chainLastActivityMs,
    Number(config.timeout_per_step) || 0,
  );
  _renderActivityHeartbeat(
    'pipe-activity-heartbeat',
    pipeRunning,
    pipePaused,
    pipeLastActivityMs,
    Number(pipeConfig.timeout_per_phase) || 0,
  );
}

function markChainActivity() {
  chainLastActivityMs = Date.now();
  renderActivityHeartbeats();
}

function markPipeActivity() {
  pipeLastActivityMs = Date.now();
  renderActivityHeartbeats();
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Unlimited Toggle Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
function toggleUnlimited() {
  const on = document.getElementById('unlimited').checked;
  config.unlimited = on;
  document.getElementById('threshold-group').style.display = on ? '' : 'none';

  // Max Loops - ignored in unlimited
  const loopsInput = document.getElementById('max-loops');
  const loopsNote = document.getElementById('max-loops-note');
  loopsInput.disabled = on;
  loopsInput.style.opacity = on ? '0.4' : '1';
  loopsNote.textContent = on ? '(ignored - unlimited)' : '';

  // Max Time - still enforced as a safety cap
  const timeInput = document.getElementById('max-time');
  const timeNote = document.getElementById('max-time-note');
  timeNote.textContent = on ? '(safety cap - still enforced)' : '';

  // Token Budget - still enforced as a safety cap
  const tokensNote = document.getElementById('max-tokens-note');
  tokensNote.textContent = on ? '(safety cap - still enforced)' : '';

  // Convergence - forced on in unlimited mode
  const convCheck = document.getElementById('stop-convergence');
  const convNote = document.getElementById('convergence-note');
  if (on) {
    convCheck.checked = true;
    convCheck.disabled = true;
    convCheck.style.opacity = '0.6';
    convNote.textContent = '(always on in unlimited)';
    config.stop_on_convergence = true;
  } else {
    convCheck.disabled = false;
    convCheck.style.opacity = '1';
    convNote.textContent = '';
  }
}

function toggleBrain() {
  const on = document.getElementById('brain-enabled').checked;
  config.brain_enabled = on;
  document.getElementById('brain-options').style.display = on ? '' : 'none';
  if (on) {
    config.brain_model = document.getElementById('brain-model').value;
  }
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Ollama / Local Only Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */

let _ollamaModels = [];      // cached from server
let _ollamaRunning = false;

async function fetchOllamaModels() {
  try {
    const data = await api('/api/ollama/models');
    _ollamaRunning = data.running;
    _ollamaModels = data.models || [];
    // Populate dynamic <optgroup> slots
    populateOllamaOptions('chain-ollama-models', _ollamaModels);
    populateOllamaOptions('pipe-ollama-models', _ollamaModels);
  } catch (e) {
    console.warn('Could not fetch Ollama models', e);
  }
}

function populateOllamaOptions(groupId, models) {
  const group = document.getElementById(groupId);
  if (!group) return;
  if (!models.length) {
    group.innerHTML = '<option disabled>No Ollama models installed</option>';
    return;
  }
  group.innerHTML = models.map(m => {
    const sizeInfo = m.size_gb ? ' (' + m.size_gb + ' GB)' : '';
    const paramInfo = m.parameter_size ? ' - ' + m.parameter_size : '';
    return '<option value="' + m.ollama_id + '">Ollama - ' + m.display + paramInfo + sizeInfo + '</option>';
  }).join('');
}

function updateOllamaStatus(prefix) {
  const wrap = document.getElementById(prefix + 'ollama-status');
  const icon = document.getElementById(prefix + 'ollama-status-icon');
  const text = document.getElementById(prefix + 'ollama-status-text');
  if (!wrap) return;
  wrap.style.display = '';
  if (_ollamaRunning && _ollamaModels.length) {
    icon.textContent = '\u2705';
    text.textContent = 'Ollama running - ' + _ollamaModels.length + ' model' + (_ollamaModels.length !== 1 ? 's' : '') + ' available';
    text.style.color = '#4caf50';
  } else if (_ollamaRunning) {
    icon.textContent = '\u26a0\ufe0f';
    text.textContent = 'Ollama running but no models installed. Run: ollama pull gemma3:27b';
    text.style.color = 'var(--warning)';
  } else {
    icon.textContent = '\u274c';
    text.textContent = 'Ollama not running. Start with: ollama serve';
    text.style.color = 'var(--danger)';
  }
}

function toggleLocalOnly() {
  const on = document.getElementById('local-only').checked;
  config.local_only = on;
  fetchOllamaModels().then(() => {
    updateOllamaStatus('');
    const select = document.getElementById('brain-model');
    // Disable/enable cloud model option groups
    select.querySelectorAll('.cloud-model-group').forEach(g => {
      g.style.display = on ? 'none' : '';
      // Disable options inside hidden groups so they can't be submitted
      g.querySelectorAll('option').forEach(o => o.disabled = on);
    });
    if (on && _ollamaModels.length) {
      select.value = _ollamaModels[0].ollama_id;
      config.brain_model = select.value;
    }
  });
}

function togglePipeLocalOnly() {
  const on = document.getElementById('pipe-local-only').checked;
  pipeConfig.local_only = on;
  fetchOllamaModels().then(() => {
    updateOllamaStatus('pipe-');
    const select = document.getElementById('pipe-brain-model');
    select.querySelectorAll('.cloud-model-group').forEach(g => {
      g.style.display = on ? 'none' : '';
      g.querySelectorAll('option').forEach(o => o.disabled = on);
    });
    if (on && _ollamaModels.length) {
      select.value = _ollamaModels[0].ollama_id;
      pipeConfig.brain_model = select.value;
    }
  });
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Repo Validation Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
let diagRefreshTimer = { chain: null, pipeline: null };
let diagRequestSeq = { chain: 0, pipeline: 0 };
let diagActionRunState = { chain: {}, pipeline: {} };
const DIAG_CATEGORY_LABEL = {
  repository: 'Repository',
  codex: 'Codex',
  claude_code: 'Claude',
  agents: 'Agents',
};

function _collectChainAgentsForDiagnostics() {
  const enabled = (config.steps || []).filter(s => s.enabled !== false);
  if (!enabled.length) return ['codex'];
  const agents = enabled.map(s => (s.agent === 'auto' ? 'codex' : (s.agent || 'codex')));
  return Array.from(new Set(agents));
}

function _collectPipelineAgentsForDiagnostics() {
  const phaseEls = Array.from(document.querySelectorAll('#phase-list .phase-item'));
  if (phaseEls.length) {
    const active = [];
    phaseEls.forEach(el => {
      const enabledEl = el.querySelector('[data-phase-enabled]');
      if (!enabledEl || !enabledEl.checked) return;
      const agentSel = el.querySelector('[data-phase-agent]');
      active.push(agentSel ? (agentSel.value || 'codex') : (pipeConfig.agent || 'codex'));
    });
    if (active.length) return Array.from(new Set(active));
  }
  return [pipeConfig.agent || 'codex'];
}

function _diagnosticPayload(target) {
  if (target === 'pipeline') {
    return {
      repo_path: document.getElementById('pipe-repo-path').value.trim(),
      codex_binary: document.getElementById('pipe-codex-bin').value.trim() || 'codex',
      claude_binary: document.getElementById('pipe-claude-bin').value.trim() || 'claude',
      agents: _collectPipelineAgentsForDiagnostics(),
    };
  }
  return {
    repo_path: document.getElementById('repo-path').value.trim(),
    codex_binary: document.getElementById('codex-bin').value.trim() || 'codex',
    claude_binary: document.getElementById('claude-bin').value.trim() || 'claude',
    agents: _collectChainAgentsForDiagnostics(),
  };
}

function _diagStatusIcon(status) {
  if (status === 'pass') return '\u2705';
  if (status === 'warn') return '\u26a0\ufe0f';
  return '\u274c';
}

function renderDiagnostics(target, payload) {
  const summaryEl = document.getElementById(target === 'pipeline' ? 'diag-summary-pipeline' : 'diag-summary-chain');
  const listEl = document.getElementById(target === 'pipeline' ? 'diag-list-pipeline' : 'diag-list-chain');
  const actionsEl = document.getElementById(target === 'pipeline' ? 'diag-actions-pipeline' : 'diag-actions-chain');
  if (!summaryEl || !listEl || !actionsEl) return;

  const summary = payload && payload.summary ? payload.summary : { pass: 0, warn: 0, fail: 0 };
  const pass = summary.pass || 0;
  const warn = summary.warn || 0;
  const fail = summary.fail || 0;
  if (fail > 0) {
    summaryEl.textContent = 'Action required: ' + fail + ' failing checks, ' + warn + ' warnings.';
  } else if (warn > 0) {
    summaryEl.textContent = 'Ready with warnings: ' + pass + ' passing checks, ' + warn + ' warnings.';
  } else {
    summaryEl.textContent = 'Ready: all ' + pass + ' checks passed.';
  }

  const checks = Array.isArray(payload && payload.checks) ? payload.checks : [];
  if (!checks.length) {
    listEl.innerHTML = '<div class="diag-item"><div class="diag-detail">No diagnostics available.</div></div>';
  } else {
    listEl.innerHTML = checks.map(c => {
      const status = c.status || 'warn';
      const cls = 'diag-item diag-' + status;
      const category = DIAG_CATEGORY_LABEL[c.category] || c.category || 'Check';
      const label = (c.label || 'Check');
      const detail = c.detail || '';
      const hint = c.hint || '';
      return '<div class="' + cls + '">'
        + '<div class="diag-main">'
        +   '<span class="diag-icon">' + _diagStatusIcon(status) + '</span>'
        +   '<span class="diag-title">' + escHtml(category + ': ' + label) + '</span>'
        + '</div>'
        + '<div class="diag-detail">' + escHtml(detail) + '</div>'
        + (hint ? ('<div class="diag-hint">Fix: ' + escHtml(hint) + '</div>') : '')
        + '</div>';
    }).join('');
  }

  const actions = Array.isArray(payload && payload.next_actions) ? payload.next_actions : [];
  if (!actions.length) {
    actionsEl.innerHTML = '';
  } else {
    actionsEl.innerHTML = '<div class="diag-actions-title">Next actions</div>'
      + actions.map((action, idx) => {
        const severity = (action.severity || 'required').toLowerCase();
        const cls = severity === 'required' ? 'diag-action-required' : 'diag-action-recommended';
        const badge = severity === 'required' ? 'Required' : 'Recommended';
        const title = action.title || 'Action';
        const detail = action.detail || '';
        const command = action.command || '';
        const key = action.key || '';
        const canRun = !!action.can_run;
        const runState = (diagActionRunState[target] || {})[key] || null;
        const runClass = runState
          ? (runState.ok ? 'ok' : 'fail')
          : '';
        const runText = runState
          ? ('Last run: ' + (runState.ok ? 'ok' : 'failed') + ' (exit ' + String(runState.exit_code) + ')')
          : '';
        return '<div class="diag-action ' + cls + '">'
          + '<div class="diag-action-head">'
          +   '<span class="diag-action-rank">' + String(idx + 1) + '.</span>'
          +   '<span class="diag-action-title">[' + escHtml(badge) + '] ' + escHtml(title) + '</span>'
          + '</div>'
          + (detail ? ('<div class="diag-action-detail">' + escHtml(detail) + '</div>') : '')
          + (command ? ('<div class="diag-action-command">Command: ' + escHtml(command) + '</div>') : '')
          + (command
            ? ('<div class="diag-action-controls">'
              + '<button class="btn" type="button" data-command="' + escAttr(command) + '" onclick="copyDiagnosticsCommand(this)">Copy</button>'
              + (canRun
                ? ('<button class="btn btn-primary" type="button" data-target="' + escAttr(target) + '" data-action-key="' + escAttr(key) + '" onclick="runDiagnosticsAction(this)">Run</button>')
                : '')
              + '</div>')
            : '')
          + (runText ? ('<div class="diag-action-run-state ' + runClass + '">' + escHtml(runText) + '</div>') : '')
          + '</div>';
      }).join('');
  }

  scheduleDiagnosticsRefresh(target);
}

async function copyDiagnosticsCommand(btn) {
  const command = (btn && btn.dataset && btn.dataset.command) ? btn.dataset.command : '';
  if (!command) {
    toast('No command is available for this action.', 'error');
    return;
  }
  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(command);
    } else {
      const textarea = document.createElement('textarea');
      textarea.value = command;
      textarea.setAttribute('readonly', '');
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      textarea.remove();
    }
    toast('Copied diagnostics command.', 'success');
  } catch (e) {
    toast('Could not copy command to clipboard.', 'error');
  }
}

async function runDiagnosticsAction(btn) {
  const target = (btn && btn.dataset && btn.dataset.target) ? btn.dataset.target : 'chain';
  const actionKey = (btn && btn.dataset && btn.dataset.actionKey) ? btn.dataset.actionKey : '';
  if (!actionKey) {
    toast('Missing diagnostics action key.', 'error');
    return;
  }
  const original = btn.textContent || 'Run';
  btn.disabled = true;
  btn.textContent = 'Running...';
  try {
    const payload = _diagnosticPayload(target);
    payload.action_key = actionKey;
    const result = await postJson('/api/diagnostics/actions/run', payload);
    if (result && result.error) {
      throw new Error(result.error);
    }
    if (!diagActionRunState[target]) {
      diagActionRunState[target] = {};
    }
    diagActionRunState[target][actionKey] = {
      ok: !!(result && result.ok),
      exit_code: Number(result && result.exit_code ? result.exit_code : 0),
    };
    if (result && result.ok) {
      toast('Diagnostics action completed.', 'success');
    } else {
      const err = (result && result.stderr) ? result.stderr.split('\n')[0] : '';
      toast(
        'Diagnostics action failed (exit ' + String((result && result.exit_code) || '?') + ')'
          + (err ? ': ' + err : '.'),
        'error'
      );
    }
    await refreshDiagnostics(target, { silent: true });
  } catch (e) {
    toast((e && e.message) || 'Failed to run diagnostics action.', 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = original;
  }
}

function scheduleDiagnosticsRefresh(target) {
  if (diagRefreshTimer[target]) clearTimeout(diagRefreshTimer[target]);
  diagRefreshTimer[target] = setTimeout(() => refreshDiagnostics(target, { silent: true }), 500);
}

async function refreshDiagnostics(target, opts) {
  const options = opts || {};
  const summaryEl = document.getElementById(target === 'pipeline' ? 'diag-summary-pipeline' : 'diag-summary-chain');
  const listEl = document.getElementById(target === 'pipeline' ? 'diag-list-pipeline' : 'diag-list-chain');
  if (!summaryEl || !listEl) return;

  const reqId = (diagRequestSeq[target] || 0) + 1;
  diagRequestSeq[target] = reqId;
  if (!options.silent) {
    summaryEl.textContent = 'Running diagnostics...';
  }

  try {
    const payload = _diagnosticPayload(target);
    const data = await postJson('/api/diagnostics', payload);
    if (data && data.error) throw new Error(data.error);
    if (diagRequestSeq[target] !== reqId) return;
    renderDiagnostics(target, data || {});
  } catch (e) {
    if (diagRequestSeq[target] !== reqId) return;
    summaryEl.textContent = 'Diagnostics request failed.';
    listEl.innerHTML = '<div class="diag-item diag-fail"><div class="diag-detail">Could not load diagnostics. ' + esc((e && e.message) || 'Check server logs.') + '</div></div>';
  }
}

let repoTimeout;
function maybeAutoEnableVectorMemory(target, payload) {
  if (!payload || !payload.vector_memory_detected) return;
  const repoPath = String(payload.path || '').trim();
  if (!repoPath) return;

  let enabledNow = false;
  if (target === 'pipeline') {
    if (!pipeConfig.vector_memory_enabled) {
      pipeConfig.vector_memory_enabled = true;
      syncPipelineCapabilityControlsFromConfig();
      enabledNow = true;
    }
  } else {
    if (!config.vector_memory_enabled) {
      config.vector_memory_enabled = true;
      syncChainCapabilityControlsFromConfig();
      enabledNow = true;
    }
  }

  if (enabledNow && _autoVectorMemoryNotified[target] !== repoPath) {
    toast('Detected existing vector memory for this repository and enabled it automatically.', 'info');
    _autoVectorMemoryNotified[target] = repoPath;
  }
}

function validateRepo() {
  clearTimeout(repoTimeout);
  const path = document.getElementById('repo-path').value.trim();
  config.repo_path = path;
  scheduleDiagnosticsRefresh('chain');
  if (!path) {
    document.getElementById('repo-status').textContent = '';
    refreshChainOutputs(false);
    return;
  }
  refreshChainOutputs(false);
  repoTimeout = setTimeout(async () => {
    try {
      const r = await postJson('/api/validate-repo', {path});
      if (path !== document.getElementById('repo-path').value.trim()) return;
      const el = document.getElementById('repo-status');
      if (r.is_git)       { el.textContent = '\u2705'; el.title = 'Valid git repo'; }
      else if (r.exists)  { el.textContent = '\u26a0\ufe0f'; el.title = 'Directory exists but not a git repo'; }
      else                { el.textContent = '\u274c'; el.title = 'Path not found'; }
      maybeAutoEnableVectorMemory('chain', r);
    } catch(e) { /* ignore */ }
  }, 400);
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Steps Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
function addStep() {
  const defaultType = 'feature_discovery';
  const p = presets.find(x => x.key === defaultType);
  const step = {
    id: Math.random().toString(36).substring(2, 10),
    name: p ? p.name : 'New Step',
    job_type: defaultType,
    prompt_mode: 'preset',
    custom_prompt: '',
    on_failure: 'skip',
    max_retries: 1,
    loop_count: 1,
    enabled: true,
    agent: 'codex',
  };
  config.steps.push(step);
  selectedStepId = step.id;
  renderSteps();
  renderStepDetails();
}

function removeStep(id) {
  config.steps = config.steps.filter(s => s.id !== id);
  if (selectedStepId === id) selectedStepId = config.steps.length ? config.steps[0].id : null;
  renderSteps();
  renderStepDetails();
}

function moveStep(id, dir) {
  const idx = config.steps.findIndex(s => s.id === id);
  const newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= config.steps.length) return;
  [config.steps[idx], config.steps[newIdx]] = [config.steps[newIdx], config.steps[idx]];
  renderSteps();
}

function selectStep(id) {
  selectedStepId = id;
  renderSteps();
  renderStepDetails();
}

function toggleStepEnabled(id) {
  const s = config.steps.find(x => x.id === id);
  if (s) s.enabled = !s.enabled;
  renderSteps();
  renderStepDetails();
}

function getPresetIcon(jobType) {
  const p = presets.find(x => x.key === jobType);
  return p ? p.icon : '\ud83c\udfaf';
}

function getPresetPrompt(jobType, mode) {
  return fetch('/api/presets/' + jobType)
    .then(r => r.json())
    .then(data => {
      if (mode === 'ai_decides') return data.ai_prompt || data.prompt || '';
      return data.prompt || '';
    })
    .catch(() => '');
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Render: Step List Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
function renderSteps() {
  const list = document.getElementById('step-list');
  document.getElementById('step-count').textContent = '(' + config.steps.length + ')';
  const collisionDetails = getStepOutputCollisionDetails(config.steps);
  const duplicateIds = duplicateStepIdSet(collisionDetails);

  if (!config.steps.length) {
    list.innerHTML = '<div class="state-card">No steps yet. Click <strong>+ Add Step</strong> to begin.</div>';
    renderStepCollisionAlert([]);
    document.getElementById('step-details-wrap').style.display = 'none';
    scheduleDiagnosticsRefresh('chain');
    return;
  }

  list.innerHTML = config.steps.map((step, i) => {
    const sel  = step.id === selectedStepId ? 'selected' : '';
    const dis  = !step.enabled ? 'disabled-step' : '';
    const dup  = duplicateIds.has(step.id) ? 'duplicate-step' : '';
    const dupMark = duplicateIds.has(step.id)
      ? '<span class="step-dup-mark" title="Duplicate output filename - rename this step">&#10060;</span>'
      : '<span class="step-dup-mark"></span>';
    return '<div class="step-item ' + sel + ' ' + dis + ' ' + dup + '"'
      + ' role="button" tabindex="0" aria-pressed="' + (step.id === selectedStepId ? 'true' : 'false') + '"'
      + ' onclick="selectStep(\'' + step.id + '\')"'
      + ' onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();selectStep(\'' + step.id + '\')}">'
      + '<span class="step-num">' + (i+1) + '</span>'
      + '<span class="step-icon">' + getPresetIcon(step.job_type) + '</span>'
      + '<span class="step-name">' + esc(step.name || step.job_type) + (step.loop_count > 1 ? ' <span style="font-size:10px;color:var(--accent);font-weight:600">\u00d7' + step.loop_count + '</span>' : '') + '</span>'
      + dupMark
      + '<span class="step-actions">'
      +   '<button title="Toggle" onclick="toggleStepEnabled(\'' + step.id + '\');event.stopPropagation()">' + (step.enabled ? '\u25cf' : '\u25cb') + '</button>'
      +   '<button title="Move up" onclick="moveStep(\'' + step.id + '\',-1);event.stopPropagation()">\u25b2</button>'
      +   '<button title="Move down" onclick="moveStep(\'' + step.id + '\',1);event.stopPropagation()">\u25bc</button>'
      +   '<button title="Remove" onclick="removeStep(\'' + step.id + '\');event.stopPropagation()">\u2715</button>'
      + '</span>'
    + '</div>';
  }).join('');
  renderStepCollisionAlert(collisionDetails);
  scheduleDiagnosticsRefresh('chain');
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Render: Step Details Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
async function renderStepDetails() {
  const wrap = document.getElementById('step-details-wrap');
  const el = document.getElementById('step-details');
  if (!selectedStepId) { wrap.style.display = 'none'; return; }
  const step = config.steps.find(s => s.id === selectedStepId);
  if (!step) { wrap.style.display = 'none'; return; }
  wrap.style.display = '';

  const stepCollision = getStepOutputCollisionDetails(config.steps)
    .find(c => (c.steps || []).some(s => s.id === step.id));
  let stepNameWarning = '';
  if (stepCollision) {
    const conflicting = (stepCollision.steps || [])
      .filter(s => s.id !== step.id)
      .map(s => s.name || 'step')
      .join(', ');
    stepNameWarning =
      '<div class="step-name-warning">'
      + '<strong>&#10060; This step name conflicts with another step.</strong><br>'
      + 'Output file collision: <code>' + esc(stepCollision.file) + '</code><br>'
      + 'Also used by: ' + esc(conflicting || 'another step') + '<br>'
      + 'Fix by renaming this step to a unique name.'
      + '</div>';
  }

  // Build options for job type
  let typeOpts = presets.map(p =>
    '<option value="' + p.key + '"' + (p.key === step.job_type ? ' selected' : '') + '>'
    + p.icon + ' ' + p.name + '</option>'
  ).join('');
  typeOpts += '<option value="custom"' + (step.job_type === 'custom' ? ' selected' : '') + '>\ud83c\udfaf Custom</option>';

  // Get prompt text
  let promptText = step.custom_prompt;
  const isCustom = step.prompt_mode === 'custom' || step.job_type === 'custom';
  if (!isCustom && step.job_type !== 'custom') {
    try {
      promptText = await getPresetPrompt(step.job_type, step.prompt_mode);
    } catch(e) {}
  }

  el.innerHTML = ''
    + '<div class="detail-header">'
    +   '<span class="detail-title">' + getPresetIcon(step.job_type) + ' ' + esc(step.name) + '</span>'
    +   '<label style="margin:0;cursor:pointer"><input type="checkbox"' + (step.enabled ? ' checked' : '') + ' onchange="toggleStepEnabled(\'' + step.id + '\')"> Enabled</label>'
    + '</div>'
    + stepNameWarning
    // Job Type
    + '<div class="form-row"><label>Job Type</label>'
    +   '<select onchange="onJobTypeChange(this.value)">' + typeOpts + '</select>'
    + '</div>'
    // Name
    + '<div class="form-row"><label>Step Name <span class="help-icon" title="The step name becomes the output filename (e.g. &quot;Dream Up Ideas&quot; -> .codex_manager/outputs/Dream-Up-Ideas.md). Later steps can read this file. Use clear names so steps can reference each other.">?</span></label>'
    +   '<input type="text" value="' + esc(step.name) + '" onchange="updateStep(\'name\',this.value)" placeholder="e.g. Dream Up Ideas -> .codex_manager/outputs/Dream-Up-Ideas.md">'
    + '</div>'
    // Prompt Mode
    + '<div class="form-row"><label>Prompt Mode</label>'
    +   '<div class="radio-group">'
    +     '<label><input type="radio" name="pm" value="preset"'     + (step.prompt_mode==='preset'?' checked':'')     + ' onchange="updateStep(\'prompt_mode\',\'preset\');renderStepDetails()"> Preset</label>'
    +     '<label><input type="radio" name="pm" value="ai_decides"' + (step.prompt_mode==='ai_decides'?' checked':'') + ' onchange="updateStep(\'prompt_mode\',\'ai_decides\');renderStepDetails()"> AI Decides</label>'
    +     '<label><input type="radio" name="pm" value="custom"'     + (step.prompt_mode==='custom'?' checked':'')     + ' onchange="updateStep(\'prompt_mode\',\'custom\');renderStepDetails()"> Custom</label>'
    +   '</div>'
    + '</div>'
    // Prompt Preview
    + '<div class="form-row prompt-preview"><label>Prompt</label>'
    +   '<textarea id="prompt-textarea" rows="5"' + (isCustom ? '' : ' readonly') + ' onchange="updateStep(\'custom_prompt\',this.value)">' + esc(promptText) + '</textarea>'
    +   (isCustom ? '' : '<span class="readonly-badge">read-only</span>')
    + '</div>'
    // On Failure
    + '<div class="form-row-inline">'
    +   '<div class="form-row"><label>On Failure</label>'
    +     '<select onchange="updateStep(\'on_failure\',this.value);renderStepDetails()">'
    +       '<option value="skip"'  + (step.on_failure==='skip'?' selected':'')  + '>Skip to next</option>'
    +       '<option value="retry"' + (step.on_failure==='retry'?' selected':'') + '>Retry</option>'
    +       '<option value="abort"' + (step.on_failure==='abort'?' selected':'') + '>Abort chain</option>'
    +     '</select>'
    +   '</div>'
    +   (step.on_failure === 'retry'
      ? '<div class="form-row"><label>Max Retries</label><input type="number" value="' + step.max_retries + '" min="1" max="10" onchange="updateStep(\'max_retries\',parseInt(this.value))"></div>'
      : '<div class="form-row"></div>')
    + '</div>'
    // Step loop count
    + '<div class="form-row"><label>Repeat This Step</label>'
    +   '<div style="display:flex;align-items:center;gap:8px">'
    +     '<input type="number" value="' + (step.loop_count || 1) + '" min="1" max="100" style="width:70px" onchange="updateStep(\'loop_count\',parseInt(this.value)||1)">'
    +     '<span style="font-size:12px;color:var(--text2)">' + ((step.loop_count || 1) > 1 ? 'times before advancing to next step' : 'time (run once)') + '</span>'
    +   '</div>'
    + '</div>'
    // Agent selection (Expert only)
    + '<div class="form-row medium-hide" style="margin-top:10px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:10px">'
    +   '<label style="margin-bottom:4px">Agent</label>'
    +   '<select onchange="updateStep(\'agent\',this.value)">'
    +     '<option value="codex"'      + (step.agent==='codex'?' selected':'')      + '>\ud83d\udfe2 Codex (OpenAI)</option>'
    +     '<option value="claude_code"' + (step.agent==='claude_code'?' selected':'') + '>\ud83d\udfe3 Claude Code (Anthropic)</option>'
    +     '<option value="auto"'        + (step.agent==='auto'?' selected':'')        + '>\u2728 Auto (Brain decides)</option>'
    +   '</select>'
    +   '<p style="font-size:11px;color:var(--text2);margin-top:4px">'
    +     (step.agent === 'codex' ? 'OpenAI Codex CLI - best for code generation and refactoring' : step.agent === 'claude_code' ? 'Anthropic Claude Code - strong at analysis, testing, and complex reasoning' : 'Let the AI Brain choose the best agent for this step')
    +   '</p>'
    + '</div>';
}

function onJobTypeChange(val) {
  const step = config.steps.find(s => s.id === selectedStepId);
  if (!step) return;
  step.job_type = val;
  if (val !== 'custom') {
    const p = presets.find(x => x.key === val);
    if (p) step.name = p.name;
    if (step.prompt_mode === 'custom') step.prompt_mode = 'preset';
  } else {
    step.name = step.name || 'Custom Step';
    step.prompt_mode = 'custom';
  }
  renderSteps();
  renderStepDetails();
}

function updateStep(field, value) {
  const step = config.steps.find(s => s.id === selectedStepId);
  if (step) step[field] = value;
  if (field === 'name') {
    renderSteps();
    renderStepDetails();
  }
  if (field === 'agent') scheduleDiagnosticsRefresh('chain');
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Execution Control Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
async function startChain() {
  // Sync config from UI inputs
  config.repo_path             = document.getElementById('repo-path').value.trim();
  config.unlimited             = document.getElementById('unlimited').checked;
  config.improvement_threshold = parseFloat(document.getElementById('threshold-slider').value) || 1.0;
  config.max_loops             = parseInt(document.getElementById('max-loops').value) || 3;
  config.max_time_minutes      = parseInt(document.getElementById('max-time').value) || 120;
  config.max_total_tokens      = parseInt(document.getElementById('max-tokens').value) || 2000000;
  config.strict_token_budget   = document.getElementById('strict-token-budget').checked;
  config.stop_on_convergence   = document.getElementById('stop-convergence').checked;
  config.test_cmd              = document.getElementById('test-cmd').value.trim();
  config.codex_binary          = document.getElementById('codex-bin').value.trim();
  config.codex_reasoning_effort = document.getElementById('codex-reasoning-effort').value;
  config.codex_sandbox_mode    = document.getElementById('codex-sandbox-mode').value;
  config.codex_approval_policy = document.getElementById('codex-approval-policy').value;
  config.codex_bypass_approvals_and_sandbox = document.getElementById('codex-bypass-approvals').checked;
  config.claude_binary         = document.getElementById('claude-bin').value.trim();
  config.timeout_per_step      = readChainTimeoutFromUi();
  config.parallel_execution    = document.getElementById('parallel-exec').checked;
  config.brain_enabled         = document.getElementById('brain-enabled').checked;
  config.brain_model           = document.getElementById('brain-model').value;
  config.local_only            = document.getElementById('local-only').checked;
  config.allow_path_creation   = document.getElementById('chain-allow-path-creation').checked;
  config.dependency_install_policy = document.getElementById('chain-dependency-install-policy').value;
  config.image_generation_enabled = document.getElementById('chain-image-generation-enabled').checked;
  config.image_provider        = document.getElementById('chain-image-provider').value;
  config.image_model           = document.getElementById('chain-image-model').value.trim();
  config.vector_memory_enabled = document.getElementById('chain-vector-memory-enabled').checked;
  config.vector_memory_backend = document.getElementById('chain-vector-memory-backend').value;
  config.vector_memory_collection = document.getElementById('chain-vector-memory-collection').value.trim();
  config.vector_memory_top_k = parseInt(document.getElementById('chain-vector-memory-top-k').value, 10) || 8;
  normalizeCodexPermissions(config);
  normalizeCapabilitySettings(config);
  syncChainPermissionControlsFromConfig();
  syncChainCapabilityControlsFromConfig();
  syncChainTimeoutControlsFromConfig();

  if (!config.repo_path) { toast('Set a repository path first', 'error'); return; }
  if (!config.steps.length) { toast('Add at least one step', 'error'); return; }
  const collisionDetails = getStepOutputCollisionDetails(config.steps);
  if (collisionDetails.length) {
    renderSteps();
    const detail = collisionDetails
      .map(c => c.file + ' (' + (c.steps || []).map(s => s.name).join(', ') + ')')
      .join('; ');
    toast('Duplicate step names detected. Rename steps marked with X to make output files unique. Conflicts: ' + detail, 'error');
    return;
  }
  const chainUsesCodex = config.steps.some(s => s.enabled && (s.agent || 'auto') !== 'claude_code');
  const runPlan = await openRunPlanModal('chain');
  if (!applyRunPlanChoice(runPlan)) return;
  if ((runPlan.profile || 'safe') === 'readonly' && chainUsesCodex) {
    toast('Read-Only Inspect selected: Codex can analyze but cannot write files in this run.', 'info');
  }
  if (!requestDangerConfirmationIfNeeded(config)) return;

  // Resolve custom prompts for non-custom steps (so backend has the text)
  for (const step of config.steps) {
    if (step.prompt_mode !== 'custom' && step.job_type !== 'custom') {
      try {
        step.custom_prompt = await getPresetPrompt(step.job_type, step.prompt_mode);
      } catch(e) {}
    }
  }

  // Clear previous results
  chainLogEntries = [];
  chainResultsCache = [];
  chainResultsCount = 0;
  _chainResultsRenderSignature = '';
  chainLastActivityMs = 0;
  chainRunning = true;
  chainPaused = false;
  renderActivityHeartbeats();
  document.getElementById('progress-last-log').textContent = 'Last log: waiting for first message...';
  renderStopGuidance('chain-stop-guidance', null, false);
  document.getElementById('log-viewer').innerHTML = '<div class="log-empty state-card loading">Connecting to live log stream...</div>';
  document.getElementById('results-body').innerHTML = '<tr><td colspan="9"><div class="state-card loading">Waiting for step results...</div></td></tr>';
  setLogContentState(document.getElementById('chain-output-content'), 'Waiting for step output files...', 'loading');
  document.getElementById('chain-output-select').innerHTML = '<option value="">No output files yet</option>';
  document.getElementById('chain-output-dir').textContent = '';
  _lastOutputRefreshStepCount = -1;

  const resp = await postJson('/api/chain/start', config);
  if (resp.error) {
    chainRunning = false;
    chainPaused = false;
    renderActivityHeartbeats();
    document.getElementById('log-viewer').innerHTML = '<div class="log-empty state-card error">Could not start chain. Check diagnostics and configuration.</div>';
    document.getElementById('results-body').innerHTML = '<tr><td colspan="9"><div class="state-card">No execution results yet. Run a chain to populate this table.</div></td></tr>';
    toast(resp.error, 'error');
    return;
  }

  setControlsRunning(true);
  connectSSE();
  startPolling();
  refreshChainOutputs(false);
  if ((config.mode || 'dry-run') === 'dry-run') {
    toast('SAFE MODE ACTIVE: Dry Run is enabled. Changes are evaluated and then reverted.', 'info');
  }
  toast('Chain started', 'success');
}

async function stopChain() {
  const r = await postJson('/api/chain/stop');
  if (r.error) {
    toast(r.error, 'error');
    return;
  }
  toast('Stop requested', 'info');
}

async function pauseChain() {
  const r = await postJson('/api/chain/pause');
  if (r.error) {
    toast(r.error, 'error');
    return;
  }
  document.getElementById('btn-pause').innerHTML = r.status === 'paused' ? '&#9654; Resume' : '&#9208; Pause';
}

function setControlsRunning(running) {
  document.getElementById('btn-start').disabled = running;
  document.getElementById('btn-pause').disabled = !running;
  document.getElementById('btn-stop').disabled  = !running;
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ SSE Connection Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
function connectSSE() {
  if (eventSource) eventSource.close();
  eventSource = new EventSource('/api/stream');
  eventSource.onmessage = (e) => {
    let data;
    try { data = JSON.parse(e.data); } catch { return; }
    if (data.type === 'heartbeat') return;
    addLogEntry(data);
  };
  eventSource.onerror = () => {
    // Will auto-reconnect
  };
}

function disconnectSSE() {
  if (eventSource) { eventSource.close(); eventSource = null; }
}

function normalizeLogMessage(msg) {
  let text = (msg || '').toString();
  // Strip OSC and CSI ANSI escape sequences.
  text = text.replace(/\u001b\][^\u0007]*(?:\u0007|\u001b\\)/g, '');
  text = text.replace(/\u001b\[[0-9;]*[A-Za-z]/g, '');
  // Drop remaining non-printable control chars that can visually corrupt the log.
  text = text.replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F]/g, '');
  text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  text = text.replace(/\n{3,}/g, '\n\n');
  return text;
}

function isDebugLogEntry(entry) {
  const msg = normalizeLogMessage(entry.message || '');
  return msg.includes('[DEBUG]');
}

function shouldShowLogEntry(entry, isPipe) {
  const debugToggle = document.getElementById(isPipe ? 'pipe-show-debug-logs' : 'show-debug-logs');
  const showDebug = !!(debugToggle && debugToggle.checked);
  return showDebug || !isDebugLogEntry(entry);
}

function appendLogEntry(viewerId, entry) {
  const viewer = document.getElementById(viewerId);
  const empty = viewer.querySelector('.log-empty');
  if (empty) empty.remove();

  const div = document.createElement('div');
  div.className = 'log-entry log-' + (entry.level || 'info');
  div.innerHTML = ''
    + '<span class="log-time">' + esc(entry.time || '') + '</span>'
    + '<span class="log-msg">' + esc(normalizeLogMessage(entry.message || '')) + '</span>';
  viewer.appendChild(div);
  viewer.scrollTop = viewer.scrollHeight;
}

function renderChainLogViewer() {
  const viewer = document.getElementById('log-viewer');
  viewer.innerHTML = '';
  const filtered = chainLogEntries.filter(e => shouldShowLogEntry(e, false));
  if (!filtered.length) {
    viewer.innerHTML = '<div class="log-empty state-card">No log entries to show.</div>';
    return;
  }
  filtered.forEach(e => appendLogEntry('log-viewer', e));
}

function toggleDebugLogs() {
  renderChainLogViewer();
}

function addLogEntry(entry) {
  markChainActivity();
  chainLogEntries.push(entry);
  if (chainLogEntries.length > 4000) chainLogEntries.shift();
  if (!shouldShowLogEntry(entry, false)) return;
  appendLogEntry('log-viewer', entry);
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Status Polling Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
function startPolling() {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(pollStatus, 1500);
}

function stopPolling() {
  if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
}

async function pollStatus() {
  try {
    const s = await api('/api/chain/status?since_results=' + encodeURIComponent(chainResultsCount));
    if (s && s.error) {
      setBackendOnlineState(false, s.error);
      return;
    }
    updateProgress(s);
    const next = _consumeResultsPayload(s, chainResultsCache, chainResultsCount);
    chainResultsCache = next.results;
    chainResultsCount = next.total;
    updateResults(chainResultsCache);
    const done = s.total_steps_completed || 0;
    if (done !== _lastOutputRefreshStepCount) {
      _lastOutputRefreshStepCount = done;
      refreshChainOutputs(true);
    }

    if (!s.running) {
      setControlsRunning(false);
      stopPolling();
      disconnectSSE();
      refreshChainOutputs(true);
    }
  } catch(e) { /* ignore */ }
}

function updateProgress(s) {
  chainRunning = !!s.running;
  chainPaused = !!s.paused;
  const stopGuidance = s.stop_guidance || null;
  if (s.last_log_epoch_ms) chainLastActivityMs = s.last_log_epoch_ms;
  renderActivityHeartbeats();
  _renderLastLogHint('progress-last-log', s);
  const enabled = config.steps.filter(x => x.enabled).length;
  const done = s.total_steps_completed || 0;
  const runUnlimited = typeof s.run_unlimited === 'boolean' ? s.run_unlimited : !!config.unlimited;
  const runMaxLoops = Number.isFinite(Number(s.run_max_loops)) && Number(s.run_max_loops) > 0
    ? Number(s.run_max_loops)
    : (parseInt(document.getElementById('max-loops').value) || config.max_loops || 1);

  let pct;
  if (runUnlimited) {
    // In unlimited mode the bar shows improvement remaining (100% = lots of room, approaching 0% = converging)
    pct = Math.min(100, Math.max(0, Math.round(s.improvement_pct || 100)));
  } else {
    const maxSteps = enabled * runMaxLoops;
    pct = maxSteps > 0 ? Math.min(100, Math.round(done / maxSteps * 100)) : 0;
  }

  const progressFill = document.getElementById('progress-fill');
  progressFill.style.width = pct + '%';
  progressFill.classList.toggle('running', !!s.running && !s.paused);

  // Token count + improvement badge
  let tokenText = (s.total_tokens || 0).toLocaleString() + ' tokens';
  if (s.improvement_pct !== undefined && s.improvement_pct < 200 && done > 0) {
    tokenText += '  |  improvement: ' + (s.improvement_pct || 0).toFixed(1) + '%';
  }
  document.getElementById('progress-tokens').textContent = tokenText;

  let text = 'Ready';
  if (s.running && s.paused) {
    text = 'Paused';
  } else if (s.running) {
    const loopLabel = runUnlimited
      ? 'Loop ' + s.current_loop + ' / \u221e'
      : 'Loop ' + s.current_loop + ' / ' + runMaxLoops;
    const runningFor = s.current_step_started_at_epoch_ms
      ? Math.max(0, Math.floor((Date.now() - s.current_step_started_at_epoch_ms) / 1000))
      : 0;
    text = '[' + _spinnerFrame() + '] ' + loopLabel + ' \u2022 Step ' + (s.current_step + 1) + '/' + config.steps.length;
    if (s.current_step_name) text += ' \u2022 ' + esc(s.current_step_name);
    if (runningFor > 0) text += ' \u2022 running ' + _formatElapsedSeconds(runningFor);
    if (!runUnlimited) text += ' \u2022 ' + pct + '%';
  } else if (s.stop_reason) {
    const label = stopGuidance && stopGuidance.label ? stopGuidance.label : s.stop_reason;
    text = 'Finished: ' + label + ' (' + (s.total_loops_completed || 0) + ' loops)';
  }
  document.getElementById('progress-text').textContent = text;
  renderStopGuidance('chain-stop-guidance', stopGuidance, s.running);
}

function _formatChangedLineCount(value, cls, sign) {
  const n = Number(value);
  if (!Number.isFinite(n)) {
    return '<span class="file-changes-binary">bin</span>';
  }
  return '<span class="' + cls + '">' + sign + n + '</span>';
}

function renderChangedFilesCell(changedFiles, filesChanged) {
  const files = Array.isArray(changedFiles) ? changedFiles : [];
  const total = Number(filesChanged || 0);
  if (!files.length) {
    if (total <= 0) {
      return '<span class="file-changes-empty">0</span>';
    }
    const label = total + ' file' + (total === 1 ? '' : 's');
    return '<span class="file-changes-empty" title="File details unavailable for this result">' + label + '</span>';
  }

  const labelCount = files.length;
  const summary = labelCount + ' file' + (labelCount === 1 ? '' : 's');
  const rows = files.map(f => {
    const path = esc(String((f && f.path) || '(unknown)'));
    return '<div class="file-changes-row">'
      + '<span class="file-changes-path" title="' + path + '">' + path + '</span>'
      + _formatChangedLineCount(f && f.insertions, 'file-changes-plus', '+')
      + _formatChangedLineCount(f && f.deletions, 'file-changes-minus', '-')
      + '</div>';
  }).join('');

  return '<details class="file-changes-details">'
    + '<summary class="file-changes-summary">' + summary + '</summary>'
    + '<div class="file-changes-list">' + rows + '</div>'
    + '</details>';
}

function _captureOpenChangedFileRows(tbodyId) {
  const tbody = document.getElementById(tbodyId);
  const openKeys = new Set();
  if (!tbody) return openKeys;
  tbody.querySelectorAll('details.file-changes-details[open]').forEach((details) => {
    const tr = details.closest('tr[data-change-key]');
    if (!tr || !tr.dataset) return;
    const key = tr.dataset.changeKey || '';
    if (key) openKeys.add(key);
  });
  return openKeys;
}

function _restoreOpenChangedFileRows(tbodyId, openKeys) {
  if (!openKeys || !openKeys.size) return;
  const tbody = document.getElementById(tbodyId);
  if (!tbody) return;
  tbody.querySelectorAll('details.file-changes-details').forEach((details) => {
    const tr = details.closest('tr[data-change-key]');
    if (!tr || !tr.dataset) return;
    const key = tr.dataset.changeKey || '';
    if (key && openKeys.has(key)) details.open = true;
  });
}

function _parseResultCount(value, fallback) {
  const n = Number(value);
  if (!Number.isFinite(n) || n < 0) return fallback;
  return Math.floor(n);
}

function _consumeResultsPayload(payload, cache, knownCount) {
  if (Array.isArray(payload.results)) {
    const full = payload.results;
    const total = _parseResultCount(payload.total_results, full.length);
    return { results: full, total: Math.max(full.length, total) };
  }

  if (!Array.isArray(payload.results_delta)) {
    return { results: cache, total: knownCount };
  }

  const delta = payload.results_delta;
  const total = _parseResultCount(payload.total_results, knownCount + delta.length);
  let next = cache;

  if (total === 0) {
    next = [];
  } else if (total < next.length) {
    next = next.slice(0, total);
  }

  if (delta.length) next = next.concat(delta);
  if (total < next.length) next = next.slice(0, total);

  return { results: next, total: Math.max(total, next.length) };
}

function _resultsSignature(results) {
  const len = Array.isArray(results) ? results.length : 0;
  if (!len) return '0';
  const last = results[len - 1] || {};
  const changedFiles = Array.isArray(last.changed_files) ? last.changed_files.length : 0;
  return [
    len,
    last.loop_number || 0,
    last.step_index || 0,
    last.cycle || 0,
    String(last.phase || ''),
    String(last.step_name || ''),
    String(last.test_outcome || ''),
    Number(last.files_changed || 0),
    Number(last.net_lines_changed || 0),
    Number(last.duration_seconds || 0),
    changedFiles,
  ].join('|');
}

function updateResults(results) {
  const signature = _resultsSignature(results);
  if (signature === _chainResultsRenderSignature) return;
  _chainResultsRenderSignature = signature;

  const tbody = document.getElementById('results-body');
  const openKeys = _captureOpenChangedFileRows('results-body');
  if (!results.length) {
    tbody.innerHTML = '<tr><td colspan="9"><div class="state-card">No execution results yet. Run a chain to populate this table.</div></td></tr>';
    return;
  }
  tbody.innerHTML = results.map((r, idx) => {
    const badge = r.test_outcome === 'passed' ? 'badge-pass'
                : r.test_outcome === 'failed' ? 'badge-fail'
                : r.test_outcome === 'skipped' ? 'badge-skip' : 'badge-error';
    const agentBadge = (r.agent_used || 'codex').includes('Claude') ? '\ud83d\udfe3' : '\ud83d\udfe2';
    const rowKey = 'chain:' + idx + ':' + (r.loop_number || 0) + ':' + (r.step_index || 0);
    return '<tr data-change-key="' + esc(rowKey) + '">'
      + '<td>' + r.loop_number + '</td>'
      + '<td>' + esc(r.step_name) + '</td>'
      + '<td style="font-size:12px">' + agentBadge + ' ' + esc(r.agent_used || 'Codex') + '</td>'
      + '<td><span class="badge ' + badge + '">' + r.test_outcome + '</span></td>'
      + '<td>' + r.files_changed + '</td>'
      + '<td class="file-changes-cell">' + renderChangedFilesCell(r.changed_files, r.files_changed) + '</td>'
      + '<td>' + (r.net_lines_changed >= 0 ? '+' : '') + r.net_lines_changed + '</td>'
      + '<td>' + r.duration_seconds + 's</td>'
      + '<td style="font-family:var(--mono);font-size:12px">' + (r.commit_sha || '\u2014') + '</td>'
    + '</tr>';
  }).join('');
  _restoreOpenChangedFileRows('results-body', openKeys);
}

function setLogContentState(el, text, state) {
  if (!el) return;
  el.classList.toggle('is-loading', state === 'loading');
  el.textContent = text;
}

async function refreshChainOutputs(keepSelection = true) {
  const sel = document.getElementById('chain-output-select');
  const content = document.getElementById('chain-output-content');
  const dirEl = document.getElementById('chain-output-dir');
  const prev = keepSelection ? (sel.value || '') : '';
  setLogContentState(content, 'Loading output files...', 'loading');

  if (!config.repo_path) {
    chainOutputFiles = [];
    sel.innerHTML = '<option value="">No output files yet</option>';
    setLogContentState(content, 'Set a repository path and run a chain to generate outputs.');
    dirEl.textContent = '';
    return;
  }

  try {
    const q = '/api/chain/outputs?repo_path=' + encodeURIComponent(config.repo_path);
    const data = await api(q);
    chainOutputFiles = Array.isArray(data.files) ? data.files : [];

    if (!chainOutputFiles.length) {
      sel.innerHTML = '<option value="">No output files yet</option>';
      setLogContentState(content, 'No step output files were found for this repository yet.');
      dirEl.textContent = data.output_dir ? ('Directory: ' + data.output_dir) : '';
      return;
    }

    sel.innerHTML = '<option value="">Select an output file...</option>' + chainOutputFiles.map(f => {
      const kb = Math.max(1, Math.round((f.size_bytes || 0) / 1024));
      return '<option value="' + esc(f.name) + '">' + esc(f.name) + ' (' + kb + ' KB)</option>';
    }).join('');

    dirEl.textContent = data.output_dir ? ('Directory: ' + data.output_dir) : '';
    const next = chainOutputFiles.find(f => f.name === prev) ? prev : chainOutputFiles[chainOutputFiles.length - 1].name;
    if (next) {
      sel.value = next;
      await viewChainOutput(next);
    }
  } catch (e) {
    setLogContentState(content, 'Could not load step outputs.');
  }
}

async function viewChainOutput(name) {
  const sel = document.getElementById('chain-output-select');
  const content = document.getElementById('chain-output-content');
  const filename = name || sel.value;
  if (!filename) {
    setLogContentState(content, 'Select an output file to view its contents.');
    return;
  }
  setLogContentState(content, 'Loading output file...', 'loading');
  try {
    const url = '/api/chain/outputs/' + encodeURIComponent(filename)
      + '?repo_path=' + encodeURIComponent(config.repo_path || '');
    const data = await api(url);
    if (data.error) {
      setLogContentState(content, data.error);
      return;
    }
    setLogContentState(content, data.content || '(empty file)');
  } catch (e) {
    setLogContentState(content, 'Could not read output file.');
  }
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Config Save / Load Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
function renderOwnerDecisionBoard(board) {
  const area = document.getElementById('owner-board-content');
  const warningEl = document.getElementById('owner-board-warning');
  if (!area || !warningEl) return;

  const cards = Array.isArray(board.cards) ? board.cards : [];
  const warnings = Array.isArray(board.governance_warnings) ? board.governance_warnings : [];
  warningEl.textContent = warnings.length ? ('Governance checks:\n- ' + warnings.join('\n- ')) : '';

  if (!cards.length) {
    area.textContent = 'No decision cards found yet. Generate from a monetization output.';
    return;
  }

  area.innerHTML = cards.map(card => {
    const id = String(card.id || '');
    const title = esc(card.title || 'Untitled');
    const summary = esc(card.summary || '');
    const decision = String(card.decision || 'pending');
    const prompt = esc(card.owner_prompt || '');
    const decided = card.decided_at
      ? ('<div style="font-size:10px;color:var(--text2);margin-top:4px">Decided: ' + esc(card.decided_at) + '</div>')
      : '';
    return ''
      + '<div style="border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:10px;background:var(--panel2)">'
      +   '<div style="display:flex;justify-content:space-between;gap:8px;align-items:flex-start">'
      +     '<strong>' + title + '</strong>'
      +     '<span class="badge" style="font-size:10px;background:var(--surface2);color:var(--text2)">' + esc(decision) + '</span>'
      +   '</div>'
      +   '<div style="font-size:12px;color:var(--text2);margin-top:6px;white-space:pre-wrap">' + summary + '</div>'
      +   '<div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">'
      +     '<button class="btn btn-success" onclick="updateOwnerDecisionCard(\'' + esc(id) + '\', \'approve\')">Approve</button>'
      +     '<button class="btn btn-warning" onclick="updateOwnerDecisionCard(\'' + esc(id) + '\', \'hold\')">Hold</button>'
      +     '<button class="btn btn-danger" onclick="updateOwnerDecisionCard(\'' + esc(id) + '\', \'deny\')">Deny</button>'
      +   '</div>'
      +   '<div style="margin-top:8px">'
      +     '<label style="font-size:11px;color:var(--text2)">Follow-up prompt override (optional)</label>'
      +     '<textarea id="owner-card-prompt-' + esc(id) + '" rows="3" style="width:100%;margin-top:4px">' + prompt + '</textarea>'
      +   '</div>'
      +   decided
      + '</div>';
  }).join('');
}

async function loadOwnerDecisionBoard() {
  const repoPath = (document.getElementById('repo-path').value || '').trim();
  const area = document.getElementById('owner-board-content');
  if (!repoPath) {
    if (area) area.textContent = 'Set Repository Path in Chain Builder first.';
    return;
  }
  if (area) area.textContent = 'Loading decision board...';
  const resp = await api('/api/owner/decision-board?repo_path=' + encodeURIComponent(repoPath));
  if (resp.error) {
    if (area) area.textContent = resp.error;
    return;
  }
  renderOwnerDecisionBoard(resp);
}

async function generateDecisionBoardFromCurrentOutput() {
  const repoPath = (document.getElementById('repo-path').value || '').trim();
  if (!repoPath) {
    toast('Set a repository path first.', 'error');
    return;
  }
  const outputContent = document.getElementById('chain-output-content');
  const markdown = (outputContent && outputContent.textContent) ? outputContent.textContent.trim() : '';
  if (!markdown) {
    toast('Open a monetization output file first, then generate the decision board.', 'error');
    return;
  }
  const resp = await postJson('/api/owner/decision-board/generate', {
    repo_path: repoPath,
    markdown,
    source: 'chain_output',
  });
  if (resp.error) {
    toast(resp.error, 'error');
    return;
  }
  renderOwnerDecisionBoard(resp);
  toast('Owner decision board generated.', 'success');
}

async function updateOwnerDecisionCard(cardId, decision) {
  const repoPath = (document.getElementById('repo-path').value || '').trim();
  const promptEl = document.getElementById('owner-card-prompt-' + cardId);
  const ownerPrompt = promptEl ? promptEl.value.trim() : '';
  const resp = await postJson('/api/owner/decision-board/decision', {
    repo_path: repoPath,
    card_id: cardId,
    decision,
    owner_prompt: ownerPrompt,
  });
  if (resp.error) {
    toast(resp.error, 'error');
    return;
  }
  renderOwnerDecisionBoard(resp);
  toast('Decision saved: ' + decision, 'success');
}

async function loadConfigList() {
  try {
    const configs = await api('/api/configs');
    const sel = document.getElementById('config-select');
    if (!Array.isArray(configs)) {
      sel.innerHTML = '<option value="">Load config...</option><option value="" disabled>Could not read config list</option>';
      toast('Could not load config list from /api/configs', 'error');
      return;
    }
    const options = configs.map(c => '<option value="' + esc(c.name) + '">' + esc(c.name) + '</option>').join('');
    if (!options) {
      sel.innerHTML = '<option value="">Load config...</option><option value="" disabled>No saved configs found</option>';
      return;
    }
    sel.innerHTML = '<option value="">Load config...</option>' + options;
    sel.onchange = async function() {
      if (!this.value) return;
      const data = await postJson('/api/configs/load', {name: this.value});
      if (data.error) { toast(data.error, 'error'); return; }
      applyConfig(data);
      toast('Loaded: ' + this.value, 'info');
      this.value = '';
    };
  } catch(e) {
    const sel = document.getElementById('config-select');
    if (sel) {
      sel.innerHTML = '<option value="">Load config...</option><option value="" disabled>Config list unavailable</option>';
    }
    toast('Config list unavailable. Check Brave Shields / network settings and try Refresh.', 'error');
  }
}

function applyConfig(data) {
  Object.assign(config, data);
  if (!Object.prototype.hasOwnProperty.call(data || {}, 'codex_reasoning_effort')) {
    config.codex_reasoning_effort = 'xhigh';
  }
  if (!Array.isArray(config.steps)) config.steps = [];
  resetPermissionProfileUiState('chain');
  normalizeCodexPermissions(config);
  normalizeCapabilitySettings(config);
  document.getElementById('repo-path').value = config.repo_path || '';
  document.getElementById('unlimited').checked = !!config.unlimited;
  document.getElementById('threshold-slider').value = config.improvement_threshold || 1.0;
  document.getElementById('threshold-val').textContent = (config.improvement_threshold || 1.0) + '%';
  document.getElementById('max-loops').value = config.max_loops || 3;
  document.getElementById('max-time').value = config.max_time_minutes || 120;
  document.getElementById('max-tokens').value = config.max_total_tokens || 2000000;
  document.getElementById('strict-token-budget').checked = !!config.strict_token_budget;
  document.getElementById('stop-convergence').checked = config.stop_on_convergence !== false;
  document.getElementById('test-cmd').value = config.test_cmd || '';
  document.getElementById('codex-bin').value = config.codex_binary || 'codex';
  syncChainPermissionControlsFromConfig();
  syncChainCapabilityControlsFromConfig();
  document.getElementById('claude-bin').value = config.claude_binary || 'claude';
  config.timeout_per_step = _normalizedTimeoutSeconds(config.timeout_per_step, 600);
  syncChainTimeoutControlsFromConfig();
  document.getElementById('parallel-exec').checked = !!config.parallel_execution;
  document.getElementById('brain-enabled').checked = !!config.brain_enabled;
  document.getElementById('brain-model').value = config.brain_model || 'gpt-5.2';
  document.getElementById('local-only').checked = !!config.local_only;
  setMode(config.mode || 'dry-run');
  toggleUnlimited();
  toggleBrain();
  toggleLocalOnly();
  selectedStepId = config.steps.length ? config.steps[0].id : null;
  renderSteps();
  renderStepDetails();
  validateRepo();
  refreshChainOutputs(false);
  loadOwnerDecisionBoard();
}

async function saveConfig() {
  const name = prompt('Config name:', config.name || 'My Chain');
  if (!name) return;
  config.name = name;
  // Sync from UI
  config.repo_path             = document.getElementById('repo-path').value.trim();
  config.unlimited             = document.getElementById('unlimited').checked;
  config.improvement_threshold = parseFloat(document.getElementById('threshold-slider').value) || 1.0;
  config.max_loops             = parseInt(document.getElementById('max-loops').value) || 3;
  config.max_time_minutes      = parseInt(document.getElementById('max-time').value) || 120;
  config.max_total_tokens      = parseInt(document.getElementById('max-tokens').value) || 2000000;
  config.strict_token_budget   = document.getElementById('strict-token-budget').checked;
  config.stop_on_convergence   = document.getElementById('stop-convergence').checked;
  config.test_cmd              = document.getElementById('test-cmd').value.trim();
  config.codex_binary          = document.getElementById('codex-bin').value.trim();
  config.codex_reasoning_effort = document.getElementById('codex-reasoning-effort').value;
  config.codex_sandbox_mode    = document.getElementById('codex-sandbox-mode').value;
  config.codex_approval_policy = document.getElementById('codex-approval-policy').value;
  config.codex_bypass_approvals_and_sandbox = document.getElementById('codex-bypass-approvals').checked;
  config.claude_binary         = document.getElementById('claude-bin').value.trim();
  config.timeout_per_step      = readChainTimeoutFromUi();
  config.parallel_execution    = document.getElementById('parallel-exec').checked;
  config.brain_enabled         = document.getElementById('brain-enabled').checked;
  config.brain_model           = document.getElementById('brain-model').value;
  config.local_only            = document.getElementById('local-only').checked;
  config.allow_path_creation   = document.getElementById('chain-allow-path-creation').checked;
  config.dependency_install_policy = document.getElementById('chain-dependency-install-policy').value;
  config.image_generation_enabled = document.getElementById('chain-image-generation-enabled').checked;
  config.image_provider        = document.getElementById('chain-image-provider').value;
  config.image_model           = document.getElementById('chain-image-model').value.trim();
  config.vector_memory_enabled = document.getElementById('chain-vector-memory-enabled').checked;
  config.vector_memory_backend = document.getElementById('chain-vector-memory-backend').value;
  config.vector_memory_collection = document.getElementById('chain-vector-memory-collection').value.trim();
  config.vector_memory_top_k = parseInt(document.getElementById('chain-vector-memory-top-k').value, 10) || 8;
  normalizeCodexPermissions(config);
  normalizeCapabilitySettings(config);
  syncChainPermissionControlsFromConfig();
  syncChainCapabilityControlsFromConfig();
  syncChainTimeoutControlsFromConfig();

  const r = await postJson('/api/configs/save', {name, config});
  if (r.error) { toast(r.error, 'error'); return; }
  toast('Saved: ' + name, 'success');
  loadConfigList();
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Utilities Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */
function resetExecutionPanelsToDefaults() {
  chainLogEntries = [];
  pipeLogEntries = [];
  chainResultsCache = [];
  pipeResultsCache = [];
  chainResultsCount = 0;
  pipeResultsCount = 0;
  _chainResultsRenderSignature = '';
  _pipeResultsRenderSignature = '';
  chainLastActivityMs = 0;
  pipeLastActivityMs = 0;
  chainRunning = false;
  chainPaused = false;
  pipeRunning = false;
  pipePaused = false;
  chainOutputFiles = [];
  _lastOutputRefreshStepCount = -1;
  pendingServerRestart = null;
  selfRestartNoticeCheckpoint = '';

  setControlsRunning(false);
  setPipeControlsRunning(false);
  document.getElementById('btn-pause').innerHTML = '&#9208; Pause';
  document.getElementById('pipe-btn-pause').innerHTML = '&#9208; Pause';

  document.getElementById('progress-text').textContent = 'Ready';
  document.getElementById('progress-tokens').textContent = '0 tokens';
  document.getElementById('progress-fill').style.width = '0%';
  document.getElementById('progress-fill').classList.remove('running');
  document.getElementById('progress-last-log').textContent = 'Last log: none yet';
  renderStopGuidance('chain-stop-guidance', null, false);
  document.getElementById('log-viewer').innerHTML = '<div class="log-empty state-card">Waiting to start...</div>';
  document.getElementById('results-body').innerHTML = '<tr><td colspan="9"><div class="state-card">No execution results yet. Run a chain to populate this table.</div></td></tr>';
  document.getElementById('show-debug-logs').checked = false;

  document.getElementById('pipe-progress-text').textContent = 'Ready';
  document.getElementById('pipe-progress-tokens').textContent = '0 tokens';
  document.getElementById('pipe-progress-fill').style.width = '0%';
  document.getElementById('pipe-progress-fill').classList.remove('running');
  document.getElementById('pipe-progress-last-log').textContent = 'Last log: none yet';
  renderStopGuidance('pipe-stop-guidance', null, false);
  document.getElementById('pipe-log-viewer').innerHTML = '<div class="log-empty state-card">Configure phases and click Start Pipeline...</div>';
  document.getElementById('pipe-results-body').innerHTML = '<tr><td colspan="8"><div class="state-card">No pipeline results yet. Start a pipeline run to populate this table.</div></td></tr>';
  document.getElementById('pipe-show-debug-logs').checked = false;

  setLogContentState(document.getElementById('log-file-content'), 'Select a log file above to view its contents.');
  document.querySelectorAll('#log-file-tabs button').forEach((btn, idx) => {
    btn.classList.toggle('active', idx === 0);
  });

  const cuaStatus = document.getElementById('pipe-cua-status');
  cuaStatus.textContent = '';
  cuaStatus.style.color = 'var(--text2)';

  renderActivityHeartbeats();
  setBackendOnlineState(true);
}

function resetNewProjectForm() {
  document.getElementById('np-parent').value = '';
  document.getElementById('np-name').value = '';
  document.getElementById('np-desc').value = '';
  document.getElementById('np-git-name').value = '';
  document.getElementById('np-git-email').value = '';
  document.getElementById('np-readme').checked = true;
  document.getElementById('np-gitignore').checked = true;
  document.getElementById('np-branch').value = 'main';
  document.getElementById('np-remote').value = '';
  document.getElementById('np-foundation-enabled').checked = false;
  document.getElementById('np-foundation-prompt').value = '';
  document.getElementById('np-foundation-generate-docs').checked = true;
  document.getElementById('np-foundation-bootstrap-once').checked = true;
  document.getElementById('np-foundation-bootstrap-autorun').checked = true;
  document.getElementById('np-licensing-enabled').checked = false;
  document.getElementById('np-licensing-strategy').value = 'oss_only';
  document.getElementById('np-licensing-commercial').checked = true;
  document.getElementById('np-licensing-email').value = '';
  document.getElementById('np-licensing-legal-review-required').checked = true;
  document.getElementById('np-licensing-legal-signoff').checked = false;
  document.getElementById('np-licensing-legal-reviewer').value = '';
  document.getElementById('np-licensing-legal-notes').value = '';
  document.querySelectorAll('.np-foundation-assistant').forEach((el) => {
    el.checked = el.value === 'codex';
  });
  _setFoundationStatus(
    'Choose assistants and click "Improve..." to refine prompt structure.',
    'muted',
  );
  toggleFoundationOptions();
  toggleLicensingOptions();
  toggleLicensingLegalSignoff();
  document.getElementById('np-result').style.display = 'none';
  document.getElementById('np-create-btn').disabled = false;
  document.querySelectorAll('#new-project-overlay details').forEach(el => { el.open = false; });
  hideNewProjectModal();
}

function resetTodoWishlistForm() {
  const repo = _activeRepoPath();
  document.getElementById('todo-wishlist-repo').value = repo;
  document.getElementById('todo-wishlist-content').value = '';
  document.getElementById('todo-wishlist-context').value = '';
  document.getElementById('todo-wishlist-model').value = 'gpt-5.2';
  lastTodoWishlistSuggestion = '';
  _setTodoWishlistStatus('', 'muted');
  hideTodoWishlistModal();
}

async function clearEverything() {
  const running = chainRunning || chainPaused || pipeRunning || pipePaused;
  const proceed = confirm(
    running
      ? 'A chain or pipeline is currently running. Stop it and reset all settings/UI to startup defaults? Saved configurations will be preserved.'
      : 'Reset all settings and UI state to startup defaults? Saved configurations will be preserved.'
  );
  if (!proceed) return;

  if (running) {
    try { await postJson('/api/chain/stop'); } catch(e) {}
    try { await postJson('/api/pipeline/stop'); } catch(e) {}
  }

  stopPolling();
  disconnectSSE();
  if (pipelinePollTimer) { clearInterval(pipelinePollTimer); pipelinePollTimer = null; }
  if (pipelineSSE) { pipelineSSE.close(); pipelineSSE = null; }

  Object.assign(config, cloneState(DEFAULT_CHAIN_CONFIG));
  Object.assign(pipeConfig, cloneState(DEFAULT_PIPE_CONFIG));
  selectedStepId = null;
  if (typeof _phasePromptOverrides !== 'undefined') {
    Object.keys(_phasePromptOverrides).forEach(key => { delete _phasePromptOverrides[key]; });
  }

  if (typeof localStorage !== 'undefined') {
    // Only reset known UI/session flags. Preserve any saved config keys.
    localStorage.removeItem('cm_mode');
    localStorage.removeItem('cm_onboarded');
  }

  currentMode = 'easy';
  document.querySelectorAll('.recipe-card').forEach(card => {
    card.classList.remove('selected');
    card.setAttribute('aria-pressed', 'false');
  });
  document.querySelectorAll('#chain-panel details, #pipeline-config details').forEach(el => { el.open = false; });

  applyConfig(cloneState(DEFAULT_CHAIN_CONFIG));
  applyPipeConfigToUi();
  applyMode('easy');

  resetExecutionPanelsToDefaults();
  resetNewProjectForm();
  resetTodoWishlistForm();
  closeRunPlanModal({ action: 'cancel' });
  closePermissionsHelpModal();
  closeReadOnlyWarningModal('cancel');
  closeDocsModal();
  browseClose();
  switchTab('chain');
  loadConfigList();
  renderPipelinePhases();

  _openOverlay('onboarding-overlay', '.onboarding-card .btn-primary');
  toast('Reset complete: settings restored. Saved configurations were not deleted.', 'success');
}

function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function escAttr(s) {
  return esc(s).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

function renderStopGuidance(elementId, guidance, running) {
  const el = document.getElementById(elementId);
  if (!el) return;

  if (running || !guidance || !guidance.label) {
    el.className = 'stop-guidance hidden';
    el.innerHTML = '';
    return;
  }

  const severity = ['info', 'warn', 'error'].includes(guidance.severity)
    ? guidance.severity
    : 'info';
  const summary = guidance.summary
    ? '<div class="stop-guidance-summary">' + esc(guidance.summary) + '</div>'
    : '';
  const steps = Array.isArray(guidance.next_steps) ? guidance.next_steps : [];
  const stepsHtml = steps.length
    ? '<ol class="stop-guidance-steps">' + steps.map(step => '<li>' + esc(step) + '</li>').join('') + '</ol>'
    : '';

  el.className = 'stop-guidance stop-guidance-' + severity;
  el.innerHTML = ''
    + '<div class="stop-guidance-title">Why it stopped: ' + esc(guidance.label) + '</div>'
    + summary
    + stepsHtml;
}

function _ensureToastStack() {
  let stack = document.getElementById('toast-stack');
  if (!stack) {
    stack = document.createElement('div');
    stack.id = 'toast-stack';
    stack.setAttribute('aria-live', 'polite');
    stack.setAttribute('aria-atomic', 'false');
    document.body.appendChild(stack);
  }
  return stack;
}

function toast(msg, type) {
  const stack = _ensureToastStack();
  const el = document.createElement('div');
  el.className = 'toast toast-' + (type || 'info');
  el.textContent = msg;
  const announcer = document.getElementById('sr-announcer');
  if (announcer) {
    announcer.textContent = '';
    setTimeout(() => { announcer.textContent = msg; }, 10);
  }
  stack.appendChild(el);
  setTimeout(() => {
    el.classList.add('toast-exit');
    setTimeout(() => {
      el.remove();
      if (stack.childElementCount === 0) stack.remove();
    }, 220);
  }, 3000);
}

/* Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â */
/* TAB SWITCHING                                                    */
/* Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â */

function switchTab(tabId) {
  document.querySelectorAll('#main-tabs button').forEach(b => {
    const active = b.dataset.tab === tabId;
    b.classList.toggle('active', active);
    b.setAttribute('aria-selected', active ? 'true' : 'false');
    b.setAttribute('tabindex', active ? '0' : '-1');
  });
  document.querySelectorAll('.tab-content').forEach(el => {
    const active = el.id === tabId + '-view';
    el.classList.toggle('active', active);
    el.hidden = !active;
  });
  if (tabId === 'pipeline' && !pipelinePhases.length) {
    loadPipelinePhases();
  }
}

/* Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â */
/* PIPELINE                                                         */
/* Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â */

const PHASE_ICONS = {
  ideation: '\uD83D\uDCA1',
  prioritization: '\uD83D\uDCCA',
  implementation: '\uD83D\uDD28',
  testing: '\uD83E\uDDEA',
  debugging: '\uD83D\uDC1B',
  commit: '\uD83D\uDCBE',
  deep_research: '\uD83D\uDD0D',
  apply_upgrades_and_restart: '\uD83D\uDD04',
  progress_review: '\uD83D\uDCCB',
  visual_test: '\uD83D\uDC41\uFE0F',
  theorize: '\uD83E\uDD14',
  experiment: '\u2697\uFE0F',
  skeptic: '\uD83E\uDDEA',
  analyze: '\uD83D\uDD2C',
};

let pipelinePhases = [];
let pipelineSSE = null;
let pipelinePollTimer = null;

const pipeConfig = {
  repo_path: '',
  mode: 'dry-run',
  max_cycles: 3,
  unlimited: false,
  improvement_threshold: 1.0,
  agent: 'codex',
  science_enabled: false,
  cua_enabled: false,
  cua_provider: 'openai',
  cua_target_url: '',
  cua_task: '',
  brain_enabled: false,
  brain_model: 'gpt-5.2',
  phases: [],
  // Stop conditions (consistent with chain builder)
  max_time_minutes: 240,
  max_total_tokens: 5000000,
  strict_token_budget: false,
  stop_on_convergence: true,
  // Advanced settings (consistent with chain builder)
  test_cmd: '',
  codex_binary: 'codex',
  codex_reasoning_effort: 'xhigh',
  claude_binary: 'claude',
  codex_sandbox_mode: 'workspace-write',
  codex_approval_policy: 'never',
  codex_bypass_approvals_and_sandbox: false,
  codex_danger_confirmation: '',
  allow_path_creation: true,
  dependency_install_policy: 'project_only',
  image_generation_enabled: false,
  image_provider: 'openai',
  image_model: 'gpt-image-1',
  vector_memory_enabled: false,
  vector_memory_backend: 'chroma',
  vector_memory_collection: '',
  vector_memory_top_k: 8,
  deep_research_enabled: false,
  deep_research_providers: 'both',
  deep_research_max_age_hours: 168,
  deep_research_dedupe: true,
  deep_research_native_enabled: false,
  deep_research_retry_attempts: 2,
  deep_research_daily_quota: 8,
  deep_research_max_provider_tokens: 12000,
  deep_research_budget_usd: 5.0,
  deep_research_openai_model: 'gpt-5.2',
  deep_research_google_model: 'gemini-3-pro-preview',
  self_improvement_enabled: false,
  self_improvement_auto_restart: false,
  timeout_per_phase: 0,
  // Git settings
  auto_commit: true,
  commit_frequency: 'per_phase',
  // Local-only mode
  local_only: false,
};
const DEFAULT_PIPE_CONFIG = cloneState(pipeConfig);

function applyPipeConfigToUi() {
  if (!Array.isArray(pipeConfig.phases)) pipeConfig.phases = [];
  resetPermissionProfileUiState('pipeline');
  normalizeCodexPermissions(pipeConfig);
  normalizeCapabilitySettings(pipeConfig);

  document.getElementById('pipe-repo-path').value = pipeConfig.repo_path || '';
  document.getElementById('pipe-unlimited').checked = !!pipeConfig.unlimited;
  document.getElementById('pipe-threshold-slider').value = pipeConfig.improvement_threshold || 1.0;
  document.getElementById('pipe-threshold-val').textContent = (pipeConfig.improvement_threshold || 1.0) + '%';
  document.getElementById('pipe-cycles').value = pipeConfig.max_cycles || 3;
  document.getElementById('pipe-max-time').value = pipeConfig.max_time_minutes || 240;
  document.getElementById('pipe-max-tokens').value = pipeConfig.max_total_tokens || 5000000;
  document.getElementById('pipe-strict-token-budget').checked = !!pipeConfig.strict_token_budget;
  document.getElementById('pipe-stop-convergence').checked = pipeConfig.stop_on_convergence !== false;
  document.getElementById('pipe-agent').value = pipeConfig.agent || 'codex';
  document.getElementById('pipe-science').checked = !!pipeConfig.science_enabled;
  document.getElementById('pipe-cua').checked = !!pipeConfig.cua_enabled;
  document.getElementById('pipe-cua-provider').value = pipeConfig.cua_provider || 'openai';
  document.getElementById('pipe-cua-url').value = pipeConfig.cua_target_url || '';
  document.getElementById('pipe-cua-task').value = pipeConfig.cua_task || '';
  const cuaStatus = document.getElementById('pipe-cua-status');
  cuaStatus.textContent = '';
  cuaStatus.style.color = 'var(--text2)';
  document.getElementById('pipe-brain').checked = !!pipeConfig.brain_enabled;
  document.getElementById('pipe-brain-model').value = pipeConfig.brain_model || 'gpt-5.2';
  document.getElementById('pipe-local-only').checked = !!pipeConfig.local_only;
  document.getElementById('pipe-auto-commit').checked = pipeConfig.auto_commit !== false;
  document.getElementById('pipe-commit-freq').value = pipeConfig.commit_frequency || 'per_phase';
  document.getElementById('pipe-test-cmd').value = pipeConfig.test_cmd || '';
  document.getElementById('pipe-codex-bin').value = pipeConfig.codex_binary || 'codex';
  document.getElementById('pipe-claude-bin').value = pipeConfig.claude_binary || 'claude';
  pipeConfig.timeout_per_phase = _normalizedTimeoutSeconds(pipeConfig.timeout_per_phase, 600);
  syncPipelinePermissionControlsFromConfig();
  syncPipelineCapabilityControlsFromConfig();
  syncPipeTimeoutControlsFromConfig();
  setPipeMode(pipeConfig.mode || 'dry-run');
  togglePipeUnlimited();
  togglePipeScience();
  togglePipeCUA();
  togglePipeBrain();
  togglePipeVectorMemory(false);
  togglePipeDeepResearch(false);
  togglePipeSelfImprovement();
  togglePipeLocalOnly();
  validatePipeRepo();
}

async function loadPipelinePhases() {
  try {
    pipelinePhases = await api('/api/pipeline/phases');
    renderPipelinePhases();
  } catch(e) {
    console.warn('Could not load pipeline phases', e);
  }
}

// Per-phase custom prompt overrides (keyed by phase key)
const _phasePromptOverrides = {};

function renderPipelinePhases() {
  const list = document.getElementById('phase-list');
  if (!pipelinePhases.length) {
    list.innerHTML = '<div class="state-card loading">Loading phases...</div>';
    scheduleDiagnosticsRefresh('pipeline');
    return;
  }

  const scienceEnabled = document.getElementById('pipe-science').checked;
  const cuaEnabled = document.getElementById('pipe-cua') ? document.getElementById('pipe-cua').checked : false;
  const deepResearchEnabled = document.getElementById('pipe-deep-research-enabled')
    ? document.getElementById('pipe-deep-research-enabled').checked
    : false;
  const selfImprovementEnabled = document.getElementById('pipe-self-improvement-enabled')
    ? document.getElementById('pipe-self-improvement-enabled').checked
    : false;

  list.innerHTML = pipelinePhases.map(p => {
    const isScience = p.is_science;
    const isDeepResearch = p.is_deep_research;
    const isCUA = p.is_cua;
    const isSelfImprovement = p.is_self_improvement;
    const hidden = (isScience && !scienceEnabled)
      || (isDeepResearch && !deepResearchEnabled)
      || (isCUA && !cuaEnabled)
      || (isSelfImprovement && !selfImprovementEnabled);
    if (hidden) return '';
    const icon = PHASE_ICONS[p.key] || '\u2699\uFE0F';
    const desc = p.description || '';
    const prompt = _phasePromptOverrides[p.key] || p.prompt || '';
    const isCustom = !!_phasePromptOverrides[p.key];

    return '<div class="phase-item" data-phase="' + p.key + '">'
      // Header row (clickable to expand)
      + '<div class="phase-header" role="button" tabindex="0" aria-expanded="false"'
      + ' onclick="togglePhaseExpand(this.parentElement)"'
      + ' onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();togglePhaseExpand(this.parentElement)}">'
      +   '<span class="phase-expand-arrow">\u25B6</span>'
      +   '<input type="checkbox" checked data-phase-enabled="' + p.key + '" style="accent-color:var(--accent)" onclick="event.stopPropagation()" onchange="scheduleDiagnosticsRefresh(\'pipeline\')">'
      +   '<span class="phase-icon">' + icon + '</span>'
      +   '<span class="phase-name">' + esc(p.name) + '</span>'
      +   '<input type="number" class="phase-iter" value="' + p.default_iterations + '" min="1" max="50" data-phase-iter="' + p.key + '" title="Iterations" onclick="event.stopPropagation()">'
      +   '<span style="font-size:10px;color:var(--text2);width:60px;text-align:right">' + (p.log_file || '') + '</span>'
      + '</div>'
      // Expandable details
      + '<div class="phase-details">'
      +   (desc ? '<p class="phase-desc">' + esc(desc) + '</p>' : '')
      // Prompt section
      +   '<div class="phase-prompt-wrap">'
      +     '<label>Prompt '
      +       '<span style="font-size:10px;font-weight:400;color:var(--text2);margin-left:4px">'
      +         (isCustom ? '(customized)' : '(from catalog - editable)')
      +       '</span>'
      +     '</label>'
      +     '<textarea class="phase-prompt" data-phase-prompt="' + p.key + '" '
      +       'oninput="onPhasePromptEdit(\'' + p.key + '\', this.value)" '
      +       'placeholder="Prompt for ' + esc(p.name) + '..."'
      +     '>' + esc(prompt) + '</textarea>'
      +     (isCustom
        ? '<button onclick="resetPhasePrompt(\'' + p.key + '\')" style="margin-top:4px;font-size:11px;padding:3px 10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text2);cursor:pointer" title="Revert to catalog default">Reset to default</button>'
        : '')
      +   '</div>'
      // Meta row: agent, on-failure, log file
      +   '<div class="phase-meta-row">'
      +     '<div class="form-row">'
      +       '<label>Agent</label>'
      +       '<select data-phase-agent="' + p.key + '" onchange="scheduleDiagnosticsRefresh(\'pipeline\')">'
      +         '<option value="codex">Codex</option>'
      +         '<option value="claude_code">Claude Code</option>'
      +       '</select>'
      +     '</div>'
      +     '<div class="form-row">'
      +       '<label>On Failure</label>'
      +       '<select data-phase-on-failure="' + p.key + '">'
      +         '<option value="skip">Skip</option>'
      +         '<option value="retry">Retry</option>'
      +         '<option value="abort">Abort</option>'
      +       '</select>'
      +     '</div>'
      +     '<div class="form-row">'
      +       '<label>Log File</label>'
      +       '<span style="font-size:12px;color:var(--text2);padding-top:6px;display:inline-block">' + esc(p.log_file || 'none') + '</span>'
      +     '</div>'
      +   '</div>'
      + '</div>'
    + '</div>';
  }).join('');
  scheduleDiagnosticsRefresh('pipeline');
}

function togglePhaseExpand(el) {
  const expanded = el.classList.toggle('expanded');
  const header = el.querySelector('.phase-header');
  if (header) header.setAttribute('aria-expanded', expanded ? 'true' : 'false');
}

function onPhasePromptEdit(key, value) {
  const phase = pipelinePhases.find(p => p.key === key);
  if (!phase) return;
  // Track custom override only if it differs from the catalog default
  if (value.trim() !== (phase.prompt || '').trim()) {
    _phasePromptOverrides[key] = value;
  } else {
    delete _phasePromptOverrides[key];
  }
}

function resetPhasePrompt(key) {
  delete _phasePromptOverrides[key];
  renderPipelinePhases();
}

function togglePipeScience() {
  pipeConfig.science_enabled = document.getElementById('pipe-science').checked;
  renderPipelinePhases();
}

// Ã¢â€â‚¬Ã¢â€â‚¬ CUA Visual Testing Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬
function togglePipeCUA() {
  const checked = document.getElementById('pipe-cua').checked;
  pipeConfig.cua_enabled = checked;
  document.getElementById('pipe-cua-options').style.display = checked ? 'block' : 'none';
  renderPipelinePhases();
}

function runStandaloneCUA() {
  const provider = document.getElementById('pipe-cua-provider').value;
  const target_url = document.getElementById('pipe-cua-url').value;
  const task = document.getElementById('pipe-cua-task').value;
  const statusEl = document.getElementById('pipe-cua-status');
  statusEl.textContent = 'Starting CUA session...';
  statusEl.style.color = 'var(--accent2)';

  fetch('/api/cua/start', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ provider, target_url, task })
  })
  .then(r => r.json())
  .then(data => {
    if (data.error) {
      statusEl.textContent = 'Error: ' + data.error;
      statusEl.style.color = 'var(--danger)';
    } else {
      statusEl.textContent = 'CUA running (' + data.provider + ')...';
      statusEl.style.color = 'var(--accent2)';
      pollCUAStatus();
    }
  })
  .catch(err => {
    statusEl.textContent = 'Failed: ' + err;
    statusEl.style.color = 'var(--danger)';
  });
}

function pollCUAStatus() {
  const statusEl = document.getElementById('pipe-cua-status');
  const interval = setInterval(() => {
    fetch('/api/cua/status')
      .then(r => r.json())
      .then(data => {
        if (!data.running && data.result) {
          clearInterval(interval);
          const r = data.result;
          statusEl.textContent = '';
          if (r.success) {
            statusEl.textContent = '\u2713 Done: ' + r.total_steps + ' steps, ' + r.duration_seconds + 's';
            statusEl.style.color = 'var(--success)';
          } else {
            statusEl.textContent = '\u2717 Failed: ' + (r.error || 'unknown error');
            statusEl.style.color = 'var(--danger)';
          }
          if (r.summary) {
            const summaryEl = document.createElement('div');
            summaryEl.style.fontSize = '10px';
            summaryEl.style.color = 'var(--text2)';
            summaryEl.textContent = r.summary.substring(0, 200);
            statusEl.appendChild(summaryEl);
          }
        } else if (data.result) {
          statusEl.textContent = 'CUA running... ' + (data.result.total_steps || 0) + ' steps so far';
          statusEl.style.color = 'var(--accent2)';
        }
      })
      .catch(() => {
        clearInterval(interval);
        statusEl.textContent = 'Lost connection to CUA status';
        statusEl.style.color = 'var(--warning)';
      });
  }, 3000);
}

function togglePipeBrain() {
  const on = document.getElementById('pipe-brain').checked;
  pipeConfig.brain_enabled = on;
  document.getElementById('pipe-brain-options').style.display = on ? '' : 'none';
  if (on) {
    pipeConfig.brain_model = document.getElementById('pipe-brain-model').value;
    // Re-apply local-only filter if active
    if (pipeConfig.local_only) togglePipeLocalOnly();
  }
}

function togglePipeUnlimited() {
  const on = document.getElementById('pipe-unlimited').checked;
  pipeConfig.unlimited = on;
  document.getElementById('pipe-threshold-group').style.display = on ? '' : 'none';

  // Max Cycles - ignored in unlimited
  const cyclesInput = document.getElementById('pipe-cycles');
  const cyclesNote = document.getElementById('pipe-cycles-note');
  cyclesInput.disabled = on;
  cyclesInput.style.opacity = on ? '0.4' : '1';
  cyclesNote.textContent = on ? '(ignored - unlimited)' : '';

  // Max Time - still enforced as a safety cap
  const timeNote = document.getElementById('pipe-time-note');
  timeNote.textContent = on ? '(safety cap - still enforced)' : '';

  // Token Budget - still enforced as a safety cap
  const tokensNote = document.getElementById('pipe-tokens-note');
  tokensNote.textContent = on ? '(safety cap - still enforced)' : '';

  // Convergence - forced on in unlimited mode
  const convCheck = document.getElementById('pipe-stop-convergence');
  const convNote = document.getElementById('pipe-convergence-note');
  if (on) {
    convCheck.checked = true;
    convCheck.disabled = true;
    convCheck.style.opacity = '0.6';
    convNote.textContent = '(always on in unlimited)';
    pipeConfig.stop_on_convergence = true;
  } else {
    convCheck.disabled = false;
    convCheck.style.opacity = '1';
    convNote.textContent = '';
  }
}

function setPipeMode(mode) {
  pipeConfig.mode = mode;
  document.querySelectorAll('#pipe-mode-toggle button').forEach(b => {
    b.classList.toggle('active', b.dataset.mode === mode);
  });
}

let pipeRepoTimeout;
function validatePipeRepo() {
  clearTimeout(pipeRepoTimeout);
  const path = document.getElementById('pipe-repo-path').value.trim();
  pipeConfig.repo_path = path;
  scheduleDiagnosticsRefresh('pipeline');
  if (!path) { document.getElementById('pipe-repo-status').textContent = ''; return; }
  pipeRepoTimeout = setTimeout(async () => {
    try {
      const r = await postJson('/api/validate-repo', {path});
      if (path !== document.getElementById('pipe-repo-path').value.trim()) return;
      const el = document.getElementById('pipe-repo-status');
      if (r.is_git)      { el.textContent = '\u2705'; el.title = 'Valid git repo'; }
      else if (r.exists)  { el.textContent = '\u26a0\ufe0f'; el.title = 'Not a git repo'; }
      else                { el.textContent = '\u274c'; el.title = 'Path not found'; }
      maybeAutoEnableVectorMemory('pipeline', r);
    } catch(e) {}
  }, 400);
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Pipeline Execution Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */

async function startPipeline() {
  // Sync all config from UI inputs (consistent with chain builder's startChain)
  pipeConfig.repo_path              = document.getElementById('pipe-repo-path').value.trim();
  pipeConfig.unlimited              = document.getElementById('pipe-unlimited').checked;
  pipeConfig.improvement_threshold  = parseFloat(document.getElementById('pipe-threshold-slider').value) || 1.0;
  pipeConfig.max_cycles             = parseInt(document.getElementById('pipe-cycles').value) || 3;
  pipeConfig.max_time_minutes       = parseInt(document.getElementById('pipe-max-time').value) || 240;
  pipeConfig.max_total_tokens       = parseInt(document.getElementById('pipe-max-tokens').value) || 5000000;
  pipeConfig.strict_token_budget    = document.getElementById('pipe-strict-token-budget').checked;
  pipeConfig.stop_on_convergence    = document.getElementById('pipe-stop-convergence').checked;
  pipeConfig.agent                  = document.getElementById('pipe-agent').value;
  pipeConfig.science_enabled        = document.getElementById('pipe-science').checked;
  pipeConfig.brain_enabled          = document.getElementById('pipe-brain').checked;
  pipeConfig.brain_model            = document.getElementById('pipe-brain-model').value;
  pipeConfig.local_only             = document.getElementById('pipe-local-only').checked;
  pipeConfig.cua_enabled            = document.getElementById('pipe-cua').checked;
  pipeConfig.cua_provider           = document.getElementById('pipe-cua-provider').value;
  pipeConfig.cua_target_url         = document.getElementById('pipe-cua-url').value.trim();
  pipeConfig.cua_task               = document.getElementById('pipe-cua-task').value.trim();
  pipeConfig.auto_commit            = document.getElementById('pipe-auto-commit').checked;
  pipeConfig.commit_frequency       = document.getElementById('pipe-commit-freq').value;
  pipeConfig.test_cmd               = document.getElementById('pipe-test-cmd').value.trim();
  pipeConfig.codex_binary           = document.getElementById('pipe-codex-bin').value.trim();
  pipeConfig.codex_reasoning_effort = document.getElementById('pipe-codex-reasoning-effort').value;
  pipeConfig.codex_sandbox_mode     = document.getElementById('pipe-codex-sandbox-mode').value;
  pipeConfig.codex_approval_policy  = document.getElementById('pipe-codex-approval-policy').value;
  pipeConfig.codex_bypass_approvals_and_sandbox = document.getElementById('pipe-codex-bypass-approvals').checked;
  pipeConfig.claude_binary          = document.getElementById('pipe-claude-bin').value.trim();
  pipeConfig.timeout_per_phase      = readPipeTimeoutFromUi();
  pipeConfig.allow_path_creation    = document.getElementById('pipe-allow-path-creation').checked;
  pipeConfig.dependency_install_policy = document.getElementById('pipe-dependency-install-policy').value;
  pipeConfig.image_generation_enabled = document.getElementById('pipe-image-generation-enabled').checked;
  pipeConfig.image_provider         = document.getElementById('pipe-image-provider').value;
  pipeConfig.image_model            = document.getElementById('pipe-image-model').value.trim();
  pipeConfig.vector_memory_enabled  = document.getElementById('pipe-vector-memory-enabled').checked;
  pipeConfig.vector_memory_backend  = document.getElementById('pipe-vector-memory-backend').value;
  pipeConfig.vector_memory_collection = document.getElementById('pipe-vector-memory-collection').value.trim();
  pipeConfig.vector_memory_top_k    = parseInt(document.getElementById('pipe-vector-memory-top-k').value, 10) || 8;
  pipeConfig.deep_research_enabled  = document.getElementById('pipe-deep-research-enabled').checked;
  pipeConfig.deep_research_providers = document.getElementById('pipe-deep-research-providers').value;
  pipeConfig.deep_research_max_age_hours = parseInt(document.getElementById('pipe-deep-research-max-age-hours').value, 10) || 168;
  pipeConfig.deep_research_dedupe   = document.getElementById('pipe-deep-research-dedupe').checked;
  pipeConfig.deep_research_native_enabled = document.getElementById('pipe-deep-research-native-enabled').checked;
  pipeConfig.deep_research_retry_attempts = parseInt(document.getElementById('pipe-deep-research-retry-attempts').value, 10) || 2;
  pipeConfig.deep_research_daily_quota = parseInt(document.getElementById('pipe-deep-research-daily-quota').value, 10) || 8;
  pipeConfig.deep_research_max_provider_tokens = parseInt(document.getElementById('pipe-deep-research-max-provider-tokens').value, 10) || 12000;
  pipeConfig.deep_research_budget_usd = parseFloat(document.getElementById('pipe-deep-research-budget-usd').value) || 5.0;
  pipeConfig.deep_research_openai_model = document.getElementById('pipe-deep-research-openai-model').value.trim();
  pipeConfig.deep_research_google_model = document.getElementById('pipe-deep-research-google-model').value.trim();
  pipeConfig.self_improvement_enabled = document.getElementById('pipe-self-improvement-enabled').checked;
  pipeConfig.self_improvement_auto_restart = document.getElementById('pipe-self-improvement-auto-restart').checked;
  if (!pipeConfig.self_improvement_enabled) {
    pipeConfig.self_improvement_auto_restart = false;
  }
  normalizeCodexPermissions(pipeConfig);
  normalizeCapabilitySettings(pipeConfig);
  syncPipelinePermissionControlsFromConfig();
  syncPipelineCapabilityControlsFromConfig();
  togglePipeVectorMemory(false);
  togglePipeDeepResearch(false);
  togglePipeSelfImprovement();
  syncPipeTimeoutControlsFromConfig();

  if (!pipeConfig.repo_path) { toast('Set a repository path first', 'error'); return; }
  const phaseEls = Array.from(document.querySelectorAll('#phase-list .phase-item'));
  const pipelineUsesCodex = phaseEls.length
    ? phaseEls.some(el => {
      const enabledEl = el.querySelector('[data-phase-enabled]');
      if (!enabledEl || !enabledEl.checked) return false;
      const agentSel = el.querySelector('[data-phase-agent]');
      const agent = agentSel ? agentSel.value : pipeConfig.agent;
      return agent !== 'claude_code';
    })
    : pipeConfig.agent !== 'claude_code';
  const runPlan = await openRunPlanModal('pipeline');
  if (!applyRunPlanChoice(runPlan)) return;
  if ((runPlan.profile || 'safe') === 'readonly' && pipelineUsesCodex) {
    toast('Read-Only Inspect selected: Codex can analyze but cannot write files in this run.', 'info');
  }
  if (!requestDangerConfirmationIfNeeded(pipeConfig)) return;

  // Collect phase configs (including per-phase agent, on-failure, and custom prompts)
  const phases = [];
  document.querySelectorAll('#phase-list .phase-item').forEach(el => {
    const key = el.dataset.phase;
    const enabled = el.querySelector('[data-phase-enabled]').checked;
    const iter = parseInt(el.querySelector('.phase-iter').value) || 1;
    const agentSel = el.querySelector('[data-phase-agent]');
    const failSel = el.querySelector('[data-phase-on-failure]');
    const agent = agentSel ? agentSel.value : pipeConfig.agent;
    const on_failure = failSel ? failSel.value : 'skip';
    const custom_prompt = _phasePromptOverrides[key] || '';
    phases.push({ phase: key, enabled, iterations: iter, agent, on_failure, custom_prompt });
  });
  pipeConfig.phases = phases;

  pipeLogEntries = [];
  pipeResultsCache = [];
  pipeResultsCount = 0;
  _pipeResultsRenderSignature = '';
  pipeLastActivityMs = 0;
  pipeRunning = true;
  pipePaused = false;
  renderActivityHeartbeats();
  document.getElementById('pipe-progress-last-log').textContent = 'Last log: waiting for first message...';
  renderStopGuidance('pipe-stop-guidance', null, false);
  document.getElementById('pipe-log-viewer').innerHTML = '<div class="log-empty state-card loading">Connecting to live log stream...</div>';
  document.getElementById('pipe-results-body').innerHTML = '<tr><td colspan="8"><div class="state-card loading">Waiting for phase results...</div></td></tr>';

  const resp = await postJson('/api/pipeline/start', pipeConfig);
  if (resp.error) {
    pipeRunning = false;
    pipePaused = false;
    renderActivityHeartbeats();
    document.getElementById('pipe-log-viewer').innerHTML = '<div class="log-empty state-card error">Could not start pipeline. Check diagnostics and configuration.</div>';
    document.getElementById('pipe-results-body').innerHTML = '<tr><td colspan="8"><div class="state-card">No pipeline results yet. Start a pipeline run to populate this table.</div></td></tr>';
    toast(resp.error, 'error');
    return;
  }

  setPipeControlsRunning(true);
  connectPipeSSE();
  startPipePolling();
  if ((pipeConfig.mode || 'dry-run') === 'dry-run') {
    toast('SAFE MODE ACTIVE: Dry Run is enabled. Changes are evaluated and then reverted.', 'info');
  }
  toast('Pipeline started', 'success');
}

async function stopPipeline() {
  const r = await postJson('/api/pipeline/stop');
  if (r.error) {
    toast(r.error, 'error');
    return;
  }
  toast('Stop requested', 'info');
}

async function pausePipeline() {
  const r = await postJson('/api/pipeline/pause');
  if (r.error) {
    toast(r.error, 'error');
    return;
  }
  document.getElementById('pipe-btn-pause').innerHTML = r.status === 'paused' ? '&#9654; Resume' : '&#9208; Pause';
}

function setPipeControlsRunning(running) {
  document.getElementById('pipe-btn-start').disabled = running;
  document.getElementById('pipe-btn-pause').disabled = !running;
  document.getElementById('pipe-btn-stop').disabled  = !running;
}

function connectPipeSSE() {
  if (pipelineSSE) pipelineSSE.close();
  pipelineSSE = new EventSource('/api/pipeline/stream');
  pipelineSSE.onmessage = (e) => {
    let data;
    try { data = JSON.parse(e.data); } catch { return; }
    if (data.type === 'heartbeat') return;
    addPipeLogEntry(data);
  };
}

function renderPipeLogViewer() {
  const viewer = document.getElementById('pipe-log-viewer');
  viewer.innerHTML = '';
  const filtered = pipeLogEntries.filter(e => shouldShowLogEntry(e, true));
  if (!filtered.length) {
    viewer.innerHTML = '<div class="log-empty state-card">No log entries to show.</div>';
    return;
  }
  filtered.forEach(e => appendLogEntry('pipe-log-viewer', e));
}

function togglePipeDebugLogs() {
  renderPipeLogViewer();
}

function addPipeLogEntry(entry) {
  markPipeActivity();
  pipeLogEntries.push(entry);
  if (pipeLogEntries.length > 4000) pipeLogEntries.shift();
  if (!shouldShowLogEntry(entry, true)) return;
  appendLogEntry('pipe-log-viewer', entry);
}

function startPipePolling() {
  if (pipelinePollTimer) clearInterval(pipelinePollTimer);
  pipelinePollTimer = setInterval(pollPipeStatus, 2000);
}

async function pollPipeStatus() {
  try {
    const s = await api('/api/pipeline/status?since_results=' + encodeURIComponent(pipeResultsCount));
    if (s && s.error) {
      setBackendOnlineState(false, s.error);
      return;
    }
    updatePipeProgress(s);
    const next = _consumeResultsPayload(s, pipeResultsCache, pipeResultsCount);
    pipeResultsCache = next.results;
    pipeResultsCount = next.total;
    updatePipeResults(pipeResultsCache);

    if (!s.running) {
      setPipeControlsRunning(false);
      clearInterval(pipelinePollTimer);
      pipelinePollTimer = null;
      if (pipelineSSE) { pipelineSSE.close(); pipelineSSE = null; }
    }
  } catch(e) {}
}

async function maybeHandlePipelineSelfRestart(statusPayload) {
  if (!statusPayload) return;
  if (statusPayload.stop_reason !== 'self_restart_requested' || !statusPayload.restart_required) {
    return;
  }
  const checkpointPath = String(statusPayload.restart_checkpoint_path || '').trim();
  if (!checkpointPath) return;

  if (pipeConfig.self_improvement_auto_restart) {
    await requestServerRestart(checkpointPath, { auto: true });
    return;
  }

  if (selfRestartNoticeCheckpoint !== checkpointPath) {
    selfRestartNoticeCheckpoint = checkpointPath;
    toast(
      'Self-improvement checkpoint created. Restart server to continue from: ' + checkpointPath,
      'info'
    );
  }
}

function updatePipeProgress(s) {
  pipeRunning = !!s.running;
  pipePaused = !!s.paused;
  const stopGuidance = s.stop_guidance || null;
  if (s.last_log_epoch_ms) pipeLastActivityMs = s.last_log_epoch_ms;
  renderActivityHeartbeats();
  _renderLastLogHint('pipe-progress-last-log', s);
  let pct;
  if (pipeConfig.unlimited) {
    // In unlimited mode the bar shows improvement remaining (approaching 0% = converging)
    pct = Math.min(100, Math.max(0, Math.round(s.improvement_pct || 100)));
  } else {
    pct = Math.min(100, Math.max(0, Math.round(
      (s.total_cycles || 0) / Math.max(1, pipeConfig.max_cycles) * 100
    )));
  }
  const pipeProgressFill = document.getElementById('pipe-progress-fill');
  pipeProgressFill.style.width = pct + '%';
  pipeProgressFill.classList.toggle('running', !!s.running && !s.paused);

  // Token count + improvement badge (consistent with chain builder)
  let tokenText = (s.total_tokens || 0).toLocaleString() + ' tokens';
  if (s.improvement_pct !== undefined && s.improvement_pct < 200 && (s.total_phases || 0) > 0) {
    tokenText += '  |  improvement: ' + (s.improvement_pct || 0).toFixed(1) + '%';
  }
  document.getElementById('pipe-progress-tokens').textContent = tokenText;

  let text = 'Ready';
  if (s.running && s.paused) {
    text = 'Paused';
  } else if (s.running) {
    const runningFor = s.current_phase_started_at_epoch_ms
      ? Math.max(0, Math.floor((Date.now() - s.current_phase_started_at_epoch_ms) / 1000))
      : 0;
    const iter = s.current_iteration || 0;
    const cycleLabel = pipeConfig.unlimited
      ? 'Cycle ' + (s.current_cycle || 1) + ' / \u221e'
      : 'Cycle ' + (s.current_cycle || 1) + '/' + pipeConfig.max_cycles;
    text = '[' + _spinnerFrame() + '] ' + cycleLabel
         + ' \u2022 Phase: ' + (s.current_phase || '...')
         + (iter > 0 ? (' (iter ' + iter + ')') : '')
         + ' \u2022 ' + (s.total_phases || 0) + ' phases completed';
    if (runningFor > 0) text += ' \u2022 running ' + _formatElapsedSeconds(runningFor);
    if (!pipeConfig.unlimited) text += ' \u2022 ' + pct + '%';
  } else if (s.stop_reason) {
    const label = stopGuidance && stopGuidance.label ? stopGuidance.label : s.stop_reason;
    text = 'Finished: ' + label + ' (' + (s.total_cycles || 0) + ' cycles)';
  }
  document.getElementById('pipe-progress-text').textContent = text;
  renderStopGuidance('pipe-stop-guidance', stopGuidance, s.running);
  if (!s.running) {
    maybeHandlePipelineSelfRestart(s);
  }
}

function updatePipeResults(results) {
  const signature = _resultsSignature(results);
  if (signature === _pipeResultsRenderSignature) return;
  _pipeResultsRenderSignature = signature;

  const tbody = document.getElementById('pipe-results-body');
  const openKeys = _captureOpenChangedFileRows('pipe-results-body');
  if (!results.length) {
    tbody.innerHTML = '<tr><td colspan="8"><div class="state-card">No pipeline results yet. Start a pipeline run to populate this table.</div></td></tr>';
    return;
  }
  tbody.innerHTML = results.map((r, idx) => {
    const statusBadge = r.success ? 'badge-pass' : 'badge-fail';
    const statusText = r.success ? 'ok' : 'failed';
    const testBadge = r.test_outcome === 'passed' ? 'badge-pass'
      : r.test_outcome === 'failed' ? 'badge-fail'
      : r.test_outcome === 'skipped' ? 'badge-skip' : 'badge-error';
    const rowKey = 'pipe:' + idx + ':' + (r.cycle || 0) + ':' + String(r.phase || '') + ':' + (r.iteration || 0);
    return '<tr data-change-key="' + esc(rowKey) + '">'
      + '<td>' + esc(r.phase || '') + '</td>'
      + '<td>' + (r.iteration || 0) + '</td>'
      + '<td><span class="badge ' + statusBadge + '">' + statusText + '</span></td>'
      + '<td><span class="badge ' + testBadge + '">' + esc(r.test_outcome || 'unknown') + '</span></td>'
      + '<td>' + (r.files_changed || 0) + '</td>'
      + '<td class="file-changes-cell">' + renderChangedFilesCell(r.changed_files, r.files_changed) + '</td>'
      + '<td>' + (((r.net_lines_changed || 0) >= 0 ? '+' : '') + (r.net_lines_changed || 0)) + '</td>'
      + '<td>' + ((r.duration_seconds || 0) + 's') + '</td>'
    + '</tr>';
  }).join('');
  _restoreOpenChangedFileRows('pipe-results-body', openKeys);
}

/* Ã¢â€â‚¬Ã¢â€â‚¬ Log File Viewer Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬ */

async function viewLogFile(filename) {
  document.querySelectorAll('#log-file-tabs button').forEach(b => {
    b.classList.toggle('active', b.dataset.file === filename);
  });
  const label = document.getElementById('log-file-label');
  if (label) label.textContent = filename;
  const el = document.getElementById('log-file-content');
  setLogContentState(el, 'Loading file...', 'loading');
  const repoPath = (pipeConfig.repo_path || config.repo_path || '').trim();
  if (!repoPath) {
    setLogContentState(el, 'Set Repository Path in the Pipeline panel to read log files.');
    return;
  }
  try {
    const url = '/api/pipeline/logs/' + encodeURIComponent(filename)
      + '?repo_path=' + encodeURIComponent(repoPath);
    const r = await api(url);
    if (r.error) {
      setLogContentState(el, r.error);
      return;
    }
    setLogContentState(el, r.content || '(empty - this phase may not have written to this file yet)');
  } catch(e) {
    setLogContentState(el, 'Could not load file.');
  }
}

function closeScienceDashboardModal() {
  _closeOverlay('science-dashboard-overlay');
}

function _scienceNumber(value) {
  const num = Number(value || 0);
  if (!Number.isFinite(num)) return '0';
  return num.toLocaleString();
}

function _scienceSignedNumber(value) {
  const num = Number(value || 0);
  if (!Number.isFinite(num)) return '0';
  const abs = Math.abs(num).toLocaleString();
  return (num >= 0 ? '+' : '-') + abs;
}

function _scienceBadgeClass(status) {
  const s = String(status || '').toLowerCase();
  if (s === 'supported' || s === 'ok' || s === 'passed') return 'pass';
  if (s === 'refuted' || s === 'failed') return 'fail';
  return 'warn';
}

function _renderScienceBars(containerId, rows, total) {
  const el = document.getElementById(containerId);
  if (!el) return;
  if (!rows || !rows.length) {
    el.innerHTML = '<div class="science-empty">No data yet.</div>';
    return;
  }
  const denom = Math.max(1, Number(total || 0));
  el.innerHTML = '<div class="science-bars">' + rows.map(row => {
    const label = esc(String(row.label || row.phase || 'n/a'));
    const count = Number(row.count || 0);
    const pct = Math.max(0, Math.min(100, (count / denom) * 100));
    const cls = _scienceBadgeClass(label);
    return '<div class="science-bar-row">'
      + '<div class="science-bar-label">' + label + '</div>'
      + '<div class="science-bar-track"><div class="science-bar-fill ' + cls + '" style="width:' + pct.toFixed(1) + '%"></div></div>'
      + '<div class="science-bar-value">' + _scienceNumber(count) + '</div>'
      + '</div>';
  }).join('') + '</div>';
}

function _renderScienceDashboard(payload) {
  const summary = payload.summary || {};
  const cards = document.getElementById('science-cards');
  const actionEl = document.getElementById('science-actions-list');
  const timelineBody = document.getElementById('science-timeline-body');
  const implBody = document.getElementById('science-implementation-body');
  const filesEl = document.getElementById('science-top-files');
  const analysisEl = document.getElementById('science-analysis');
  const subtitleEl = document.getElementById('science-dashboard-subtitle');

  if (subtitleEl) {
    const msg = payload.available
      ? ('Repository: ' + esc(payload.repo_path || '') + ' | Trials: ' + _scienceNumber(summary.science_trials))
      : (payload.message || 'Scientist artifacts are not available yet.');
    subtitleEl.textContent = msg;
  }

  if (cards) {
    cards.innerHTML = ''
      + '<div class="science-card"><div class="science-card-label">Cycle</div><div class="science-card-value">' + _scienceNumber(summary.current_cycle) + '</div></div>'
      + '<div class="science-card"><div class="science-card-label">Science Trials</div><div class="science-card-value">' + _scienceNumber(summary.science_trials) + '</div></div>'
      + '<div class="science-card"><div class="science-card-label">Hypotheses</div><div class="science-card-value">' + _scienceNumber(summary.hypotheses) + '</div></div>'
      + '<div class="science-card"><div class="science-card-label">Trial Tokens</div><div class="science-card-value">' + _scienceNumber(summary.trial_tokens) + '</div></div>'
      + '<div class="science-card"><div class="science-card-label">Supported</div><div class="science-card-value pass">' + _scienceNumber(summary.supported) + '</div></div>'
      + '<div class="science-card"><div class="science-card-label">Refuted</div><div class="science-card-value fail">' + _scienceNumber(summary.refuted) + '</div></div>'
      + '<div class="science-card"><div class="science-card-label">Inconclusive</div><div class="science-card-value warn">' + _scienceNumber(summary.inconclusive) + '</div></div>'
      + '<div class="science-card"><div class="science-card-label">Rollbacks</div><div class="science-card-value warn">' + _scienceNumber(summary.rollbacks) + '</div></div>';
  }

  const verdictRows = [
    { label: 'supported', count: Number(summary.supported || 0) },
    { label: 'refuted', count: Number(summary.refuted || 0) },
    { label: 'inconclusive', count: Number(summary.inconclusive || 0) },
  ];
  _renderScienceBars('science-verdict-chart', verdictRows, Number(summary.science_trials || 0));
  _renderScienceBars('science-phase-chart', payload.phase_breakdown || [], Number(summary.science_trials || 0));

  const actionItems = Array.isArray(payload.action_items) ? payload.action_items : [];
  if (actionEl) {
    actionEl.innerHTML = actionItems.length
      ? actionItems.map((item, idx) =>
        '<div class="science-list-item"><span class="name">' + esc((idx + 1) + '. ' + item) + '</span></div>'
      ).join('')
      : '<div class="science-empty">No action checklist found yet. Run analyze to generate implementation TODO items.</div>';
  }

  const timeline = Array.isArray(payload.timeline) ? payload.timeline : [];
  if (timelineBody) {
    timelineBody.innerHTML = timeline.length
      ? timeline.map((row) =>
        '<tr>'
          + '<td>' + esc(String(row.cycle || 0)) + '</td>'
          + '<td>' + esc(String(row.phase || '')) + '</td>'
          + '<td>' + esc(String(row.hypothesis_id || 'n/a')) + '</td>'
          + '<td><span class="badge badge-' + (_scienceBadgeClass(row.verdict) === 'pass' ? 'pass' : (_scienceBadgeClass(row.verdict) === 'fail' ? 'fail' : 'skip')) + '">' + esc(String(row.verdict || 'n/a')) + '</span></td>'
          + '<td>' + esc(String(row.confidence || 'n/a')) + '</td>'
          + '<td>' + esc(String(row.baseline_test || 'n/a') + '->' + String(row.post_test || 'n/a')) + '</td>'
          + '<td>' + esc(_scienceNumber(row.files_changed) + '/' + _scienceSignedNumber(row.net_lines_changed)) + '</td>'
          + '<td>' + esc(String(row.rollback_action || 'n/a')) + '</td>'
        + '</tr>'
      ).join('')
      : '<tr><td colspan="8"><div class="science-empty">No science timeline data yet.</div></td></tr>';
  }

  const implementation = Array.isArray(payload.implementation) ? payload.implementation : [];
  if (implBody) {
    implBody.innerHTML = implementation.length
      ? implementation.map((row) =>
        '<tr>'
          + '<td>' + esc(String(row.cycle || 0)) + '</td>'
          + '<td>' + esc(String(row.phase || '')) + '</td>'
          + '<td>' + esc(String(row.iteration || 0)) + '</td>'
          + '<td><span class="badge badge-' + (_scienceBadgeClass(row.status) === 'pass' ? 'pass' : (_scienceBadgeClass(row.status) === 'fail' ? 'fail' : 'skip')) + '">' + esc(String(row.status || 'unknown')) + '</span></td>'
          + '<td>' + esc(String(row.tests || 'unknown')) + '</td>'
          + '<td>' + esc(String(row.files || 0)) + '</td>'
          + '<td>' + esc(String(row.net_delta || '0')) + '</td>'
          + '<td>' + esc(String(row.commit || '-')) + '</td>'
        + '</tr>'
      ).join('')
      : '<tr><td colspan="8"><div class="science-empty">No implementation rows in report yet.</div></td></tr>';
  }

  const topFiles = Array.isArray(payload.top_files) ? payload.top_files : [];
  if (filesEl) {
    filesEl.innerHTML = topFiles.length
      ? topFiles.map(row =>
        '<div class="science-list-item"><span class="name">' + esc(String(row.path || '')) + '</span><span class="count">' + _scienceNumber(row.touches) + '</span></div>'
      ).join('')
      : '<div class="science-empty">No touched-file summary yet.</div>';
  }

  if (analysisEl) {
    const analysisText = String(payload.analysis_excerpt || '').trim();
    analysisEl.textContent = analysisText || 'No analyze excerpt recorded yet.';
  }
}

async function refreshScienceDashboard() {
  const statusEl = document.getElementById('science-dashboard-subtitle');
  const repoPath = (pipeConfig.repo_path || config.repo_path || '').trim();
  if (statusEl) statusEl.textContent = 'Loading Scientist dashboard...';
  if (!repoPath) {
    _renderScienceDashboard({
      available: false,
      summary: {},
      action_items: [],
      timeline: [],
      phase_breakdown: [],
      implementation: [],
      top_files: [],
      analysis_excerpt: '',
      message: 'Set Repository Path in the Pipeline panel to load Scientist dashboard data.',
      repo_path: '',
    });
    return;
  }
  try {
    const url = '/api/pipeline/science-dashboard?repo_path=' + encodeURIComponent(repoPath);
    const payload = await api(url);
    if (payload.error) {
      _renderScienceDashboard({
        available: false,
        summary: {},
        action_items: [],
        timeline: [],
        phase_breakdown: [],
        implementation: [],
        top_files: [],
        analysis_excerpt: '',
        message: payload.error,
        repo_path: repoPath,
      });
      return;
    }
    _renderScienceDashboard(payload || {});
  } catch (e) {
    _renderScienceDashboard({
      available: false,
      summary: {},
      action_items: [],
      timeline: [],
      phase_breakdown: [],
      implementation: [],
      top_files: [],
      analysis_excerpt: '',
      message: 'Could not load dashboard data.',
      repo_path: repoPath,
    });
  }
}

async function openScienceDashboardModal() {
  _openOverlay('science-dashboard-overlay', '#science-dashboard-refresh');
  await refreshScienceDashboard();
}

// Ã¢â€â‚¬Ã¢â€â‚¬ Browse modal Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬Ã¢â€â‚¬
let _browseTarget = null;   // id of the input to fill
let _browseCurrent = '';    // current directory being shown

function openBrowse(targetInputId) {
  _browseTarget = targetInputId;
  const input = document.getElementById(targetInputId);
  const startPath = input ? input.value.trim() : '';
  _openOverlay('browse-overlay', '.browse-modal-footer .btn-primary');
  browseTo(startPath);
}

async function browseTo(path) {
  const overlay = document.getElementById('browse-overlay');
  const pathBar = document.getElementById('browse-path');
  const listEl  = document.getElementById('browse-list');
  const drivesEl = document.getElementById('browse-drives');

  listEl.innerHTML = '<div class="browse-empty state-card loading">Loading folders...</div>';
  drivesEl.innerHTML = '';
  drivesEl.style.display = 'none';

  try {
    const r = await postJson('/api/browse-dirs', { path });
    _browseCurrent = r.current;
    pathBar.textContent = r.current;

    // Drive buttons (Windows)
    if (r.drives && r.drives.length) {
      drivesEl.style.display = 'flex';
      r.drives.forEach(letter => {
        const btn = document.createElement('button');
        btn.textContent = letter + ':\\';
        btn.onclick = () => browseTo(letter + ':\\');
        drivesEl.appendChild(btn);
      });
    }

    // Build list
    let html = '';

    // Parent directory button
    if (r.parent) {
      html += `<button class="browse-item" onclick="browseTo('${escBrowse(r.parent)}')">` +
              `<span class="browse-item-icon">&#128281;</span>` +
              `<span class="browse-item-name">..</span></button>`;
    }

    if (!r.dirs.length && !r.parent) {
      html += '<div class="browse-empty state-card">No subdirectories found.</div>';
    }

    r.dirs.forEach(d => {
      const sep = r.current.includes('/') ? '/' : '\\';
      const fullPath = r.current.replace(/[\\/]$/, '') + sep + d.name;
      const gitBadge = d.is_git ? '<span class="browse-item-git">git</span>' : '';
      const icon = d.is_git ? '&#128230;' : '&#128193;';
      html += `<button class="browse-item" onclick="browseTo('${escBrowse(fullPath)}')">` +
              `<span class="browse-item-icon">${icon}</span>` +
              `<span class="browse-item-name">${escHtml(d.name)}</span>${gitBadge}</button>`;
    });

    listEl.innerHTML = html;
  } catch (e) {
    listEl.innerHTML = '<div class="browse-empty state-card error">Could not load this directory.</div>';
  }
}

function browseSelect() {
  if (_browseTarget && _browseCurrent) {
    const input = document.getElementById(_browseTarget);
    if (input) {
      input.value = _browseCurrent;
      input.dispatchEvent(new Event('input'));
    }
  }
  browseClose();
}

function browseClose() {
  _closeOverlay('browse-overlay');
  _browseTarget = null;
}

// Escape backslashes for inline onclick
function escBrowse(s) {
  return s.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
}

// Minimal HTML escape
function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>

<!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
<!-- BROWSE MODAL                                                   -->
<!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
<div id="browse-overlay" class="browse-modal-overlay hidden" onclick="if(event.target===this)browseClose()">
  <div class="browse-modal" role="dialog" aria-modal="true" aria-labelledby="browse-title">
    <div class="browse-modal-header">
      <h3 id="browse-title">Browse for Folder</h3>
    </div>
    <div class="browse-path-bar" id="browse-path"></div>
    <div class="browse-drives" id="browse-drives" style="display:none"></div>
    <div class="browse-list" id="browse-list"></div>
    <div class="browse-modal-footer">
      <button class="btn" onclick="browseClose()">Cancel</button>
      <button class="btn btn-primary" onclick="browseSelect()">Select This Folder</button>
    </div>
  </div>
</div>

<div id="docs-overlay" class="hidden" onclick="if(event.target===this)closeDocsModal()">
  <div class="docs-modal" role="dialog" aria-modal="true" aria-labelledby="docs-title">
    <div class="docs-modal-header">
      <div>
        <h3 id="docs-title">Documentation</h3>
        <div class="docs-subtitle" id="docs-subtitle">Select a guide from the header links.</div>
      </div>
      <button class="btn" onclick="closeDocsModal()">Close</button>
    </div>
    <div class="docs-tab-row" id="docs-tab-row">
      <button class="btn" data-doc="quickstart" onclick="loadDoc('quickstart')">Quickstart</button>
      <button class="btn" data-doc="output_artifacts" onclick="loadDoc('output_artifacts')">Outputs</button>
      <button class="btn" data-doc="troubleshooting" onclick="loadDoc('troubleshooting')">Troubleshooting</button>
      <button class="btn" data-doc="cli_reference" onclick="loadDoc('cli_reference')">CLI Reference</button>
      <button class="btn" data-doc="tutorial" onclick="loadDoc('tutorial')">Tutorial</button>
    </div>
    <pre class="docs-content" id="docs-content">Select a guide from the header links.</pre>
  </div>
</div>

<div id="science-dashboard-overlay" class="hidden" onclick="if(event.target===this)closeScienceDashboardModal()">
  <div class="science-dashboard-modal" role="dialog" aria-modal="true" aria-labelledby="science-dashboard-title">
    <div class="science-dashboard-header">
      <div>
        <h3 id="science-dashboard-title">Scientist Dashboard</h3>
        <div class="science-dashboard-subtitle" id="science-dashboard-subtitle">
          Evidence-first view of experiments, verdicts, action plan, and implementation rollout.
        </div>
      </div>
      <div class="science-dashboard-actions">
        <button class="btn" id="science-dashboard-refresh" onclick="refreshScienceDashboard()">Refresh</button>
        <button class="btn" onclick="closeScienceDashboardModal()">Close</button>
      </div>
    </div>
    <div class="science-dashboard-body">
      <section>
        <div class="science-cards" id="science-cards">
          <div class="science-empty">Loading dashboard...</div>
        </div>
      </section>

      <section class="science-grid">
        <div class="science-panel">
          <h4>Verdict Breakdown</h4>
          <div id="science-verdict-chart"></div>
        </div>
        <div class="science-panel">
          <h4>Phase Breakdown</h4>
          <div id="science-phase-chart"></div>
        </div>
      </section>

      <section class="science-grid">
        <div class="science-panel">
          <h4>Action Plan</h4>
          <div class="science-list" id="science-actions-list"></div>
        </div>
        <div class="science-panel">
          <h4>Most-Touched Files</h4>
          <div class="science-list" id="science-top-files"></div>
        </div>
      </section>

      <section class="science-panel">
        <h4>Science Timeline</h4>
        <div class="science-table-wrap">
          <table class="science-table">
            <thead>
              <tr>
                <th>Cycle</th>
                <th>Phase</th>
                <th>Hypothesis</th>
                <th>Verdict</th>
                <th>Confidence</th>
                <th>Tests</th>
                <th>Delta</th>
                <th>Rollback</th>
              </tr>
            </thead>
            <tbody id="science-timeline-body">
              <tr><td colspan="8"><div class="science-empty">No timeline data yet.</div></td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="science-panel">
        <h4>Implementation Rollout</h4>
        <div class="science-table-wrap">
          <table class="science-table">
            <thead>
              <tr>
                <th>Cycle</th>
                <th>Phase</th>
                <th>Iter</th>
                <th>Status</th>
                <th>Tests</th>
                <th>Files</th>
                <th>Net</th>
                <th>Commit</th>
              </tr>
            </thead>
            <tbody id="science-implementation-body">
              <tr><td colspan="8"><div class="science-empty">No implementation rows yet.</div></td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="science-panel">
        <h4>Latest Analyze Excerpt</h4>
        <pre class="science-analysis" id="science-analysis">No analyze excerpt recorded yet.</pre>
      </section>
    </div>
  </div>
</div>

<div id="run-plan-overlay" class="hidden" onclick="if(event.target===this)closeRunPlanModal({ action: 'cancel' })">
  <div class="run-plan-modal" role="dialog" aria-modal="true" aria-labelledby="run-plan-title">
    <div class="run-plan-header">
      <div>
        <h3 id="run-plan-title">Run Configuration</h3>
        <div class="run-plan-subtitle" id="run-plan-subtitle">
          Review what this run will do before starting.
        </div>
      </div>
      <div class="run-plan-model-chip" id="run-plan-model-chip">Model: GPT-5.3-Codex</div>
    </div>
    <div class="run-plan-body">
      <div class="run-plan-grid">
        <div class="run-plan-field">
          <label for="run-plan-mode">Execution Behavior</label>
          <select id="run-plan-mode" onchange="updateRunPlanModalPreview()">
            <option value="dry-run">Dry Run (recommended)</option>
            <option value="apply">Apply Changes</option>
          </select>
        </div>
        <div class="run-plan-field">
          <label for="run-plan-profile">Codex Permission Profile</label>
          <select id="run-plan-profile" onchange="updateRunPlanModalPreview()">
            <option value="safe">Recommended: Safe Repo Access</option>
            <option value="full_access">Trusted Repo Full Access</option>
            <option value="readonly">Read-Only Inspect</option>
          </select>
        </div>
      </div>

      <div class="run-plan-summary">
        <div class="run-plan-summary-line" id="run-plan-summary-mode"></div>
        <div class="run-plan-summary-line" id="run-plan-summary-profile"></div>
        <div class="run-plan-callout" id="run-plan-summary-callout"></div>
      </div>

      <label class="run-plan-danger hidden" id="run-plan-danger-wrap">
        <input type="checkbox" id="run-plan-danger-ack">
        <span>I understand trusted full-access mode disables sandbox and approval safeguards for this run.</span>
      </label>
    </div>
    <div class="run-plan-actions">
      <button class="btn" onclick="closeRunPlanModal({ action: 'cancel' })">Cancel</button>
      <button class="btn btn-success" onclick="confirmRunPlanModal()">Start Run</button>
    </div>
  </div>
</div>

<div id="permissions-help-overlay" class="hidden" onclick="if(event.target===this)closePermissionsHelpModal()">
  <div class="permissions-help-modal" role="dialog" aria-modal="true" aria-labelledby="permissions-help-title">
    <div class="permissions-help-header">
      <h3 id="permissions-help-title">Permission Settings Guide</h3>
      <button class="btn" onclick="closePermissionsHelpModal()">Close</button>
    </div>
    <div class="permissions-help-body">
      <div class="permissions-help-card">
        <h4>Recommended: Safe Repo Access</h4>
        <p>Best default. Agent can read/write files in your repository only, with no interactive approval prompts.</p>
      </div>
      <div class="permissions-help-card">
        <h4>Read-Only Inspect</h4>
        <p>Use for analysis and planning. Agent can read files but should not write changes.</p>
      </div>
      <div class="permissions-help-card">
        <h4>Trusted Repo Full Access</h4>
        <p>Use only when you fully trust the repository and environment. Disables sandbox and approval checks.</p>
      </div>
      <div class="permissions-help-card">
        <h4>Manual Controls</h4>
        <p><strong>Sandbox Mode</strong> controls filesystem access scope.</p>
        <p><strong>Approval Policy</strong> controls if/when interactive approvals are required.</p>
        <p><strong>Disable sandbox + approvals</strong> forces maximum autonomy for trusted local work.</p>
      </div>
      <div class="permissions-help-card">
        <h4>When To Change These</h4>
        <p>Most users should keep Recommended. Change profiles only if you need strict read-only checks or trusted full-access automation.</p>
      </div>
    </div>
  </div>
</div>


<div id="readonly-warning-overlay" class="hidden" onclick="if(event.target===this)closeReadOnlyWarningModal('cancel')">
  <div class="readonly-warning-modal" role="dialog" aria-modal="true" aria-labelledby="readonly-warning-title">
    <div class="readonly-warning-header">
      <h3 id="readonly-warning-title">Read-Only Sandbox Active</h3>
    </div>
    <div class="readonly-warning-body">
      <p id="readonly-warning-message">Codex is currently running with read-only filesystem access.</p>
      <div class="readonly-warning-callout" id="readonly-warning-guidance">
        Switch to a write-enabled permission profile if you want Codex to modify files.
      </div>
      <p>For read/write access, switch to <strong>Trusted Repo Full Access</strong> (or <strong>Recommended: Safe Repo Access</strong> for sandboxed writes).</p>
    </div>
    <div class="readonly-warning-actions">
      <button class="btn" id="readonly-warning-cancel" onclick="closeReadOnlyWarningModal('cancel')">Cancel</button>
      <button class="btn" onclick="closeReadOnlyWarningModal('continue_readonly')">Run Read-Only</button>
      <button class="btn" onclick="closeReadOnlyWarningModal('switch_safe')">Use Safe Write Mode</button>
      <button class="btn btn-danger" onclick="closeReadOnlyWarningModal('switch_trusted')">Use Trusted Repo Full Access</button>
    </div>
  </div>
</div>
</body>
</html>

